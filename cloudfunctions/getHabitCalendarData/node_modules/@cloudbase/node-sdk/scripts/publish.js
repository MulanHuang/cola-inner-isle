const inquirer = require('inquirer')
const semver = require('semver')
const package = require('../package.json')
const util = require('util')
const exec = util.promisify(require('child_process').exec)
async function publish() {
  const config = await inquirer.prompt([
    {
      type: 'list',
      name: 'version',
      message: 'è¯·é€‰æ‹©æœ¬æ¬¡å‘å¸ƒçš„ç‰ˆæœ¬ç±»å‹ï¼š',
      choices: ['Prerelease', 'Patch', 'Minor', 'Major'],
      filter: function(val) {
        return val.toLowerCase()
      }
    },
    {
      type: 'confirm',
      name: 'isLatest',
      message: 'æ˜¯æ­£å¼ç‰ˆå‘å¸ƒå—ï¼Ÿ',
      default: false
    }
  ])

  if (config.isLatest && config.version === 'prerelease') {
    console.log('PreReleaseç‰ˆæœ¬ä¸èƒ½å‘å¸ƒæ­£å¼ç‰ˆï¼')
    return
  }

  if (!config.isLatest && config.version !== 'prerelease') {
    config.version = 'pre' + config.version
  }

  let newVersion = semver.inc(package.version, config.version)

  const publishCommand = 'npm publish' + (config.isLatest ? '' : ' --tag beta')

  const confirmMessage = `è¯·ç¡®è®¤æ ¸å¯¹ä¿¡æ¯ï¼š
  ==========å‘å¸ƒä¿¡æ¯==========
  å½“å‰ç‰ˆæœ¬ï¼š${package.version}
  å‘å¸ƒç‰ˆæœ¬ï¼š${newVersion}
  æ‰§è¡Œå‘½ä»¤ï¼šnpm version ${newVersion} && ${publishCommand}
  ==========å‘å¸ƒä¿¡æ¯==========
  ä»¥ä¸Šä¿¡æ¯ç¡®è®¤æ— è¯¯ï¼Ÿ`
  const confirm = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'result',
      message: confirmMessage,
      default: false
    }
  ])

  if (confirm.result) {
    console.log('å‘å¸ƒä¸­...')
    const { stdout, stderr } = await exec(
      `npm version ${newVersion} && ${publishCommand}`
    )
    console.log('stdout:', stdout)
    console.log('stderr:', stderr)
    console.log('å‘å¸ƒæˆåŠŸï¼')
  }
}
publish()
