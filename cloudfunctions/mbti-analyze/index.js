/**
 * è…¾è®¯äº‘ CloudBase äº‘å‡½æ•°ï¼šMBTI æ·±åº¦è§£è¯»
 *
 * è°ƒç”¨æ–¹å¼ï¼š
 * wx.cloud.callFunction({
 *   name: 'mbti-analyze',
 *   data: {
 *     type: 'INFJ',
 *     scores: { E: 5, I: 13, S: 8, N: 10, T: 7, F: 10, J: 11, P: 6 },
 *     answers: [...]  // å¯é€‰
 *   }
 * })
 */

const cloud = require("wx-server-sdk");
const { callOpenAI, safeAIResponse } = require("./index.js");

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV,
});

/**
 * MBTI è§£è¯» System Prompt
 */
const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½å¯¹ MBTI æœ‰æ·±å…¥ç†è§£çš„å¿ƒç†ä¸è®¤çŸ¥åˆ†æè€…ã€‚

ä½ æ‰€æä¾›çš„å†…å®¹ä¸æ˜¯å¿ƒç†è¯Šæ–­ï¼Œä¹Ÿä¸æ˜¯æ€§æ ¼è¯„åˆ¤ï¼Œ
è€Œæ˜¯å¸®åŠ©ä½¿ç”¨è€…æ›´æ¸…æ¥šåœ°ç†è§£ï¼š
ã€Œæˆ‘ä¸ºä»€ä¹ˆä¼šè¿™æ ·æ€è€ƒã€è¿™æ ·ååº”ã€è¿™æ ·æ„Ÿåˆ°ç–²æƒ«æˆ–å¡ä½ã€ã€‚

è¯·ä¸è¦æŠŠ MBTI å½“ä½œæ€§æ ¼æ ‡ç­¾æˆ–ä¼˜ç¼ºç‚¹æ¸…å•ï¼Œ
è€Œæ˜¯å°†å…¶è§†ä¸ºä¸€ç§ã€Œè®¤çŸ¥èƒ½é‡çš„ä½¿ç”¨æ–¹å¼ã€
ä»¥åŠã€Œä¸ªä½“ä¸ä¸–ç•Œäº’åŠ¨æ—¶å½¢æˆçš„ç¨³å®šä¹ æƒ¯ç»“æ„ã€ã€‚

åœ¨åˆ†ææ—¶ï¼Œè¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
1. é¿å…æ³›æ³›è€Œè°ˆçš„æ€§æ ¼æè¿°æˆ–æ¨¡æ¿åŒ–è¯­è¨€
2. ä¸ä½¿ç”¨åŠ±å¿—ã€å®‰æ…°æˆ–é¼“åŠ±æ€§çš„è¡¨è¾¾
3. é‡ç‚¹æ”¾åœ¨ç°å®æƒ…å¢ƒä¸­åå¤å‡ºç°çš„å†…åœ¨å¼ åŠ›ã€çŸ›ç›¾ä¸ä»£ä»·
4. æ¸…æ¥šæŒ‡å‡ºï¼šè¿™ä¸ªç±»å‹ä¹‹æ‰€ä»¥æ“…é•¿æŸäº›äº‹æƒ…ï¼Œæ˜¯ä»¥å¿½ç•¥æˆ–å‹æŠ‘å“ªäº›æ–¹é¢ä¸ºä»£ä»·
5. åˆ†æè¿™ä¸ªç±»å‹åœ¨é•¿æœŸæˆé•¿ä¸­ï¼Œæœ€å®¹æ˜“åå¤å¡ä½ã€å´ä¸è‡ªè§‰çš„é—®é¢˜ä½ç½®

è¯·ä»ä»¥ä¸‹è§’åº¦å±•å¼€åˆ†æï¼š
- è¿™ä¸ª MBTI ç±»å‹æœ€æ ¸å¿ƒçš„è®¤çŸ¥é©±åŠ¨åŠ›æ˜¯ä»€ä¹ˆï¼Ÿ
- ä»–ä»¬é€šå¸¸æ˜¯å¦‚ä½•åšå†³å®šçš„ï¼Ÿè¿™ç§å†³ç­–æ–¹å¼åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¤±æ•ˆï¼Ÿ
- åœ¨å…³ç³»ã€å·¥ä½œæˆ–è‡ªæˆ‘æˆé•¿ä¸­ï¼Œä»–ä»¬æœ€å¸¸è§ã€å´æœ€ä¸å®¹æ˜“å¯Ÿè§‰çš„ç›²ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
- ä»–ä»¬å¹¶ä¸æ˜¯â€œä¸åŠªåŠ›â€ï¼Œè€Œæ˜¯ä¹ æƒ¯æ€§åœ¨å“ªäº›æ–¹å‘â€œæŒç»­ç”¨é”™åŠ›â€ï¼Ÿ

è¯·ä½¿ç”¨å†·é™ã€å…‹åˆ¶ã€ç»“æ„æ¸…æ™°ã€ä»¥æ´è§ä¸ºå¯¼å‘çš„è¯­è¨€è¿›è¡Œåˆ†æï¼Œ
ç›®æ ‡ä¸æ˜¯â€œè®©äººæ„Ÿè§‰è¢«ç†è§£â€ï¼Œ
è€Œæ˜¯â€œè®©äººå¯¹è‡ªå·±äº§ç”Ÿæ–°çš„ç†è§£â€ã€‚
`;

/**
 * ç”Ÿæˆ User Prompt
 */
function generateUserPrompt(type, scores) {
  const dimensions = [
    {
      name: "èƒ½é‡æ¥æº",
      left: "E",
      right: "I",
      leftScore: scores.E,
      rightScore: scores.I,
    },
    {
      name: "ä¿¡æ¯è·å–",
      left: "S",
      right: "N",
      leftScore: scores.S,
      rightScore: scores.N,
    },
    {
      name: "å†³ç­–æ–¹å¼",
      left: "T",
      right: "F",
      leftScore: scores.T,
      rightScore: scores.F,
    },
    {
      name: "ç”Ÿæ´»æ€åº¦",
      left: "J",
      right: "P",
      leftScore: scores.J,
      rightScore: scores.P,
    },
  ];

  const dimensionAnalysis = dimensions
    .map((dim) => {
      const total = dim.leftScore + dim.rightScore;
      const dominant = dim.leftScore > dim.rightScore ? dim.left : dim.right;
      const dominantScore = Math.max(dim.leftScore, dim.rightScore);
      const percent = Math.round((dominantScore / total) * 100);
      const diff = Math.abs(dim.leftScore - dim.rightScore);

      let tendency =
        diff <= 2
          ? "éå¸¸å¹³è¡¡"
          : diff <= 5
          ? "ç•¥æœ‰å€¾å‘"
          : diff <= 10
          ? "æ˜æ˜¾å€¾å‘"
          : "å¼ºçƒˆå€¾å‘";

      return `${dim.name}ï¼š${dim.left} ${dim.leftScore} : ${dim.rightScore} ${dim.right}ï¼ˆ${tendency}äº ${dominant}ï¼Œå æ¯” ${percent}%ï¼‰`;
    })
    .join("\n");

  return `è¯·æ ¹æ®ä»¥ä¸‹ MBTI æµ‹è¯•ç»“æœï¼Œ
ä¸ºç”¨æˆ·ç”Ÿæˆä¸€ä»½å…·æœ‰æ´è§ã€æ·±åº¦ä¸è‡ªæˆ‘è§‰å¯Ÿä»·å€¼çš„ MBTI è§£è¯»ã€‚

ã€é‡è¦è¯´æ˜ã€‘
ä½ æ‰€æä¾›çš„å†…å®¹ä¸æ˜¯å¿ƒç†è¯Šæ–­ï¼Œä¹Ÿä¸æ˜¯æ€§æ ¼è¯„åˆ¤ï¼Œ
è€Œæ˜¯å¸®åŠ©ä½¿ç”¨è€…æ›´æ¸…æ¥šåœ°ç†è§£ï¼š
ã€Œæˆ‘ä¸ºä»€ä¹ˆä¼šè¿™æ ·æ€è€ƒã€è¿™æ ·ååº”ã€è¿™æ ·æ„Ÿåˆ°ç–²æƒ«æˆ–å¡ä½ã€ã€‚

è¯·ä¸è¦å°† MBTI å½“ä½œæ€§æ ¼æ ‡ç­¾æˆ–ä¼˜ç¼ºç‚¹æ¸…å•ï¼Œ
è€Œæ˜¯å°†å…¶è§†ä¸ºä¸€ç§ã€Œè®¤çŸ¥èƒ½é‡çš„ä½¿ç”¨æ–¹å¼ã€
ä»¥åŠã€Œä¸ä¸–ç•Œäº’åŠ¨æ—¶å½¢æˆçš„ç¨³å®šä¹ æƒ¯ç»“æ„ã€ã€‚

ã€åŸºæœ¬ä¿¡æ¯ã€‘
MBTI ç±»å‹ï¼š${type}

ã€ç»´åº¦å¾—åˆ†ã€‘
${dimensionAnalysis}

ã€æ€»ä½“å¾—åˆ†ã€‘
Eï¼ˆå¤–å‘ï¼‰ï¼š${scores.E}
Iï¼ˆå†…å‘ï¼‰ï¼š${scores.I}
Sï¼ˆå®æ„Ÿï¼‰ï¼š${scores.S}
Nï¼ˆç›´è§‰ï¼‰ï¼š${scores.N}
Tï¼ˆæ€è€ƒï¼‰ï¼š${scores.T}
Fï¼ˆæƒ…æ„Ÿï¼‰ï¼š${scores.F}
Jï¼ˆåˆ¤æ–­ï¼‰ï¼š${scores.J}
Pï¼ˆæ„ŸçŸ¥ï¼‰ï¼š${scores.P}

ã€è§£è¯»å†…å®¹è¾“å‡ºæ–¹å¼ï¼ˆéå¸¸é‡è¦ï¼‰ã€‘
è¯·å°†è§£è¯»å†…å®¹æ‹†åˆ†ä¸º 5 ä¸ªç‹¬ç«‹çš„å°å¡ç‰‡æ¨¡å—è¾“å‡ºï¼Œ
è€Œä¸æ˜¯ä¸€æ•´æ®µè¿ç»­æ–‡å­—ã€‚

ã€æ–‡æœ¬æ’ç‰ˆä¸å¡ç‰‡è§„åˆ™ï¼ˆéå¸¸é‡è¦ï¼‰ã€‘
è¯·è®©æ¯ä¸€ä¸ªæ¨¡å—çš„æ–‡æœ¬å…·å¤‡è‰¯å¥½çš„å¯è¯»æ€§ä¸å¡ç‰‡æ„Ÿï¼Œå¹¶ç»Ÿä¸€éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

- æ¯ä¸ªæ¨¡å—ä»¥ã€Œå›¾æ ‡ + æ ‡é¢˜ã€å¼€å¤´
- æ ‡é¢˜ä¸‹æ–¹å…ˆç»™å‡ºä¸€å¥é«˜åº¦æ¦‚æ‹¬çš„æ´è§å¥
- æ­£æ–‡æ§åˆ¶åœ¨ 6åˆ°8 å¥è¯å†…ï¼Œé¿å…é•¿æ®µè½
- é€‚å½“ä½¿ç”¨æ¢è¡Œä¸é¡¹ç›®ç¬¦å·ï¼ˆÂ·ï¼‰ï¼Œåˆ¶é€ é˜…è¯»èŠ‚å¥
- æ¯å¼ å¡ç‰‡åªèšç„¦ä¸€ä¸ªç»´åº¦ï¼Œé€‚åˆå•ç‹¬é˜…è¯»
- æ•´ä½“é£æ ¼åº”åƒâ€œå¡ç‰‡å†…å®¹â€ï¼Œè€Œä¸æ˜¯è¿ç»­æ–‡ç« 

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ 5 ä¸ªå¡ç‰‡æ¨¡å—é¡ºåºè¾“å‡ºï¼š

1. **æ ¸å¿ƒç‰¹è´¨**  
èšç„¦è¯¥ MBTI ç±»å‹æœ€æ ¹æœ¬çš„è®¤çŸ¥å‡ºå‘ç‚¹ä¸å†…åœ¨é©±åŠ¨åŠ›ï¼Œ
æŒ‡å‡ºå…¶ä¼˜åŠ¿èƒŒåçš„é™åˆ¶ä¸ä»£ä»·ã€‚

2. **æƒ…ç»ªæ¨¡å¼**  
æè¿°è¯¥ç±»å‹åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­æƒ…ç»ªä¸èƒ½é‡çš„å…¸å‹æµåŠ¨æ–¹å¼ï¼Œ
ä»¥åŠå®¹æ˜“åå¤å‡ºç°ã€å´ä¸æ˜“å¯Ÿè§‰çš„å†…åœ¨å¼ åŠ›ã€‚

3. **äººé™…é£æ ¼**  
åˆ†æè¯¥è®¤çŸ¥ç»“æ„åœ¨äººé™…ä¸äº²å¯†å…³ç³»ä¸­çš„å¸¸è§äº’åŠ¨æ¨¡å¼ï¼Œ
åŒ…æ‹¬ä»–ä»¬å®¹æ˜“è¯¯è§£ä»–äººæˆ–è¢«ä»–äººè¯¯è§£çš„åœ°æ–¹ã€‚

4. **å·¥ä½œä¸å­¦ä¹ æ–¹å¼**  
è¯´æ˜è¯¥ç±»å‹åœ¨ä»»åŠ¡æ¨è¿›ã€å†³ç­–ä¸å­¦ä¹ ä¸­çš„æƒ¯æ€§åšæ³•ï¼Œ
ä»¥åŠè¿™ç§æ–¹å¼åœ¨ä»€ä¹ˆæƒ…å¢ƒä¸‹å®¹æ˜“å¤±æ•ˆã€‚

5. **æˆé•¿å»ºè®®**  
ä»¥ 3åˆ°5 æ¡ã€Œè§‰å¯Ÿæ–¹å‘ã€çš„å½¢å¼å‘ˆç°ï¼Œ
ä¸æ˜¯è¦æ±‚æ”¹å˜ï¼Œè€Œæ˜¯æŒ‡å‡ºå¦‚æœé•¿æœŸå¿½è§†å“ªäº›å€¾å‘ï¼Œå®¹æ˜“åå¤å¡ä½ã€‚

ã€è¯­è¨€ä¸æ´è§è¦æ±‚ã€‘
- ä½¿ç”¨å†·é™ã€å…‹åˆ¶ã€ä¸è¯„åˆ¤çš„è¡¨è¾¾
- é¿å…é¸¡æ±¤ã€å®‰æ…°æˆ–æ€»ç»“å¼æ€§æ ¼æè¿°
- ç›®æ ‡ä¸æ˜¯â€œè®©ç”¨æˆ·è§‰å¾—è¢«è¯´ä¸­â€ï¼Œ
  è€Œæ˜¯â€œè®©ç”¨æˆ·å¯¹è‡ªå·±çš„è¿ä½œæ–¹å¼äº§ç”Ÿæ–°çš„ç†è§£â€`;
}

/**
 * äº‘å‡½æ•°å…¥å£
 */
exports.main = async (event, context) => {
  console.log("=== MBTI åˆ†æäº‘å‡½æ•°å¼€å§‹æ‰§è¡Œ ===");
  console.log("æ¥æ”¶åˆ°çš„å‚æ•°:", JSON.stringify(event));

  const { type, scores, answers } = event;

  // å‚æ•°æ ¡éªŒ
  if (!type || !scores) {
    console.error("âŒ å‚æ•°æ ¡éªŒå¤±è´¥ï¼šç¼ºå°‘å¿…è¦å‚æ•°");
    return {
      success: false,
      error: "ç¼ºå°‘å¿…è¦å‚æ•°ï¼štype å’Œ scores",
    };
  }

  console.log("âœ… å‚æ•°æ ¡éªŒé€šè¿‡");
  console.log("MBTI ç±»å‹:", type);
  console.log("åˆ†æ•°:", JSON.stringify(scores));

  // æ£€æŸ¥ç¯å¢ƒå˜é‡
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    console.error("âŒ ç¯å¢ƒå˜é‡ OPENAI_API_KEY æœªé…ç½®");
    return {
      success: false,
      error: "OPENAI_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨äº‘å‡½æ•°ç¯å¢ƒå˜é‡ä¸­è®¾ç½®",
    };
  }
  console.log(
    "âœ… ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ŒAPI Key å‰ç¼€:",
    apiKey.substring(0, 10) + "..."
  );

  try {
    const userPrompt = generateUserPrompt(type, scores);
    console.log("âœ… ç”Ÿæˆç”¨æˆ·æç¤ºè¯æˆåŠŸ");

    // è°ƒç”¨ OpenAI è¿›è¡Œåˆ†æ
    console.log("ğŸ“¡ å¼€å§‹è°ƒç”¨ OpenAI API...");
    console.log("æ¨¡å‹:gpt-5.1");
    console.log("æ¸©åº¦: 0.7");
    console.log("æœ€å¤§ tokens: 1500");

    const rawAnalysis = await callOpenAI({
      systemPrompt: SYSTEM_PROMPT,
      userPrompt: userPrompt,
      options: {
        model: "gpt-5-mini", // å¯ä»¥æ”¹ä¸º gpt-4o è·å¾—æ›´å¥½æ•ˆæœ
        temperature: 1,
        maxTokens: 1500,
        timeout: 30000,
      },
    });

    console.log("âœ… OpenAI è¿”å›åˆ†æç»“æœ");
    console.log("åˆ†æå†…å®¹é•¿åº¦:", rawAnalysis.length, "å­—ç¬¦");

    // ========== å†…å®¹å®‰å…¨å®¡æ ¸ ==========
    const { OPENID } = cloud.getWXContext();
    const safeResult = await safeAIResponse(rawAnalysis, "mbti", OPENID || "");

    if (!safeResult.passed) {
      console.warn("âš ï¸ MBTI åˆ†æ AI å›å¤æœªé€šè¿‡å†…å®¹å®‰å…¨å®¡æ ¸");
    }

    return {
      success: true,
      analysis: safeResult.content,
      timestamp: new Date().toISOString(),
    };
  } catch (error) {
    console.error("âŒ AI åˆ†æå¤±è´¥");
    console.error("é”™è¯¯ç±»å‹:", error.name);
    console.error("é”™è¯¯ä¿¡æ¯:", error.message);
    console.error("é”™è¯¯è¯¦æƒ…:", error.stack);

    // è¿”å›å…œåº•å†…å®¹
    console.log("ğŸ’¡ ä½¿ç”¨å…œåº•å†…å®¹");
    const fallbackAnalysis = `ã€æ ¸å¿ƒç‰¹è´¨æ€»ç»“ã€‘
ä½ æ˜¯ä¸€ä¸ª ${type} ç±»å‹çš„äººã€‚ä½ çš„å†…å¿ƒä¸–ç•Œä¸°å¯Œè€Œç»†è…»ï¼Œæ—¢æœ‰ç‹¬ç‰¹çš„æ´å¯ŸåŠ›ï¼Œä¹Ÿä¿æŒç€å¯¹ä¸–ç•Œçš„æ¸©æŸ”å…³æ³¨ã€‚

ã€èƒ½é‡ä¸æƒ…ç»ªæ¨¡å¼ã€‘
ä½ çš„èƒ½é‡æ›´å¤šæ¥è‡ªå†…åœ¨ä¸–ç•Œã€‚ç‹¬å¤„æ—¶ï¼Œä½ èƒ½å¤Ÿå……åˆ†æ¢å¤ç²¾åŠ›ï¼Œæ€è€ƒå’Œæ„Ÿå—ä¼šå˜å¾—æ›´åŠ æ¸…æ™°ã€‚ä½ å¯¹æƒ…ç»ªçš„æ„ŸçŸ¥å¾ˆæ•é”ï¼Œæ—¢èƒ½ç†è§£è‡ªå·±çš„æ„Ÿå—ï¼Œä¹Ÿèƒ½å…±æƒ…ä»–äººçš„æƒ…ç»ªã€‚

ã€äººé™…ä¸å…³ç³»é£æ ¼ã€‘
åœ¨äººé™…å…³ç³»ä¸­ï¼Œä½ å€¾å‘äºå»ºç«‹æ·±åº¦è€ŒçœŸå®çš„è¿æ¥ã€‚ä½ ä¸è¿½æ±‚å¹¿æ³›çš„ç¤¾äº¤ï¼Œè€Œæ˜¯çæƒœé‚£äº›èƒ½å¤ŸçœŸæ­£ç†è§£ä½ çš„äººã€‚ä½ å–„äºå€¾å¬ï¼Œä¹Ÿæ„¿æ„ç»™äºˆæ”¯æŒã€‚

ã€å·¥ä½œä¸å­¦ä¹ é£æ ¼ã€‘
ä½ å–œæ¬¢æœ‰æ„ä¹‰ã€æœ‰æ·±åº¦çš„å·¥ä½œå†…å®¹ã€‚ä½ ä¼šä¸ºè‡ªå·±è®¤åŒçš„ç›®æ ‡å…¨åŠ›ä»¥èµ´ï¼Œä½†ä¹Ÿéœ€è¦è¶³å¤Ÿçš„è‡ªä¸»ç©ºé—´ã€‚ä½ å–„äºä»æ•´ä½“è§†è§’æ€è€ƒé—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿèƒ½å…³æ³¨ç»†èŠ‚ã€‚

ã€æ¸©æŸ”çš„æˆé•¿å»ºè®®ã€‘
1. å…è®¸è‡ªå·±æœ‰ç‹¬å¤„çš„æ—¶é—´ï¼Œè¿™æ˜¯ä½ æ¢å¤èƒ½é‡çš„é‡è¦æ–¹å¼
2. åœ¨è¡¨è¾¾è‡ªå·±æ—¶ï¼Œå¯ä»¥æ›´åŠ ç›´æ¥ä¸€äº›ï¼Œä½ çš„æƒ³æ³•å€¼å¾—è¢«å¬è§
3. å­¦ä¼šåœ¨ç†æƒ³ä¸ç°å®ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼Œä¸å¿…è¿‡äºè‹›è´£è‡ªå·±
4. è®°å¾—ç…§é¡¾å¥½è‡ªå·±çš„èº«ä½“å’Œæƒ…ç»ªï¼Œä½ çš„æ„Ÿå—åŒæ ·é‡è¦
5. ç›¸ä¿¡è‡ªå·±çš„ç›´è§‰ï¼Œå®ƒå¾€å¾€èƒ½å¸¦ä½ æ‰¾åˆ°æ­£ç¡®çš„æ–¹å‘

æ³¨ï¼šAI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¿™æ˜¯é»˜è®¤è§£è¯»å†…å®¹ã€‚`;

    return {
      success: true,
      analysis: fallbackAnalysis,
      fallback: true,
      error: error.message,
      errorType: error.name,
      timestamp: new Date().toISOString(),
    };
  }
};
