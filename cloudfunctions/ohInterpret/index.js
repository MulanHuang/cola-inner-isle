// cloudfunctions/ohInterpret/index.js
// ============================================================
// OHå¡è§£è¯»äº‘å‡½æ•°
// é£æ ¼ï¼šå¿ƒç†å­¦æ´å¯Ÿ + è¡ŒåŠ¨åŠ›æ•™ç»ƒ
// ============================================================
const cloud = require("wx-server-sdk");
// âœ… ç»Ÿä¸€é€šè¿‡å…¬ç”¨ OpenAI å®¢æˆ·ç«¯ï¼Œç»ç”± Vercel ä»£ç† https://vercel-openai-proxy-lemon.vercel.app/api/openai è°ƒç”¨
const {
  callOpenAI,
  safeAIResponse,
  getFallbackMessage,
} = require("./index.js");

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV,
});

/**
 * OHå¡å¯¼å¸ˆç³»ç»Ÿæç¤ºè¯
 * äººè®¾è®¾å®šï¼šæ¸©æŸ”ã€æ´å¯ŸåŠ›å¼ºã€å°Šé‡ç•Œé™ã€ä¸“ä¸šåˆæœ‰è¡ŒåŠ¨åŠ›æ€ç»´
 */
const SYSTEM_PROMPT = `ä½ æ˜¯ã€Œå¯ä¹å¿ƒå²› OH å¡å¯¼å¸ˆã€ï¼Œä¸€ä½æ¸©æŸ”ã€æ´å¯ŸåŠ›å¼ºã€å°Šé‡ç•Œé™ã€ä¸“ä¸šåˆæœ‰è¡ŒåŠ¨åŠ›æ€ç»´çš„å¿ƒçµé™ªä¼´è€…ã€‚

ä½ çš„æ ¸å¿ƒç‰¹è´¨ï¼š
1. æ¸©æŸ”ä¸”æœ‰æ´å¯ŸåŠ› - èƒ½å¤Ÿä»å›¾åƒå’Œè¯è¯­ä¸­æ•æ‰åˆ°æ·±å±‚çš„å¿ƒç†è±¡å¾
2. å°Šé‡è¾¹ç•Œ - ä¸åšè¯Šæ–­ã€ä¸è´´æ ‡ç­¾ã€ä¸é¢„æµ‹æœªæ¥
3. è¡ŒåŠ¨å¯¼å‘ - ç»™å‡ºå°è€Œå¯è¡Œçš„å»ºè®®ï¼Œåƒä¸€ä½æ¸©æš–çš„æ•™ç»ƒ
4. éè¯„åˆ¤æ€åº¦ - æ‰€æœ‰çš„æƒ…ç»ªå’Œæƒ³æ³•éƒ½æ˜¯è¢«æ¥çº³çš„

ä½ çš„å·¥ä½œæ–¹å¼ï¼š
- ç»“åˆå¿ƒç†å­¦æ´å¯Ÿä¸è¡ŒåŠ¨æ•™ç»ƒæ€ç»´
- å¤šä½¿ç”¨"ä¹Ÿè®¸"ã€"å¯èƒ½"ã€"æœ‰æ—¶"ç­‰éç»å¯¹è¡¨è¿°
- å…³æ³¨å½“ä¸‹çš„æƒ…ç»ªã€éœ€æ±‚ä¸å†…åœ¨åŠ¨åŠ›
- ç»™å‡ºå…·ä½“ã€å¯æ“ä½œçš„å°å»ºè®®

ç»å¯¹ç¦æ­¢ï¼š
- ä½¿ç”¨åŒ»å­¦è¯Šæ–­è¯æ±‡ï¼ˆå¦‚æŠ‘éƒç—‡ã€ç„¦è™‘ç—‡ã€éšœç¢ç­‰ï¼‰
- é¢„æµ‹æœªæ¥ã€å åœè¿åŠ¿
- ä¸‹å®šè®ºæˆ–è´´æ ‡ç­¾
- ä½¿ç”¨æå“æ€§æˆ–è´Ÿé¢è¯„åˆ¤çš„è¡¨è¾¾`;

/**
 * ç”Ÿæˆç”¨æˆ·æç¤ºè¯
 */
function generateUserPrompt(mode, userInput, imageCard, wordCard) {
  let cardInfo = `ã€å›¾å¡ä¿¡æ¯ã€‘
- å›¾å¡åç§°ï¼š${imageCard.name}
- å›¾å¡æè¿°ï¼šè¿™æ˜¯ä¸€å¼  OH å›¾å¡ï¼Œè¯·ä»é¢œè‰²ã€æ„å›¾ã€å½¢è±¡ä¸­è”æƒ³å…¶è±¡å¾æ„ä¹‰ã€‚`;

  if (mode === "imageAndWord" && wordCard) {
    cardInfo += `

ã€å­—å¡ä¿¡æ¯ã€‘
- å­—å¡è¯è¯­ï¼š${wordCard.name}
- å½“å›¾å¡ä¸å­—å¡ç»„åˆæ—¶ï¼Œè¯·æ¢ç´¢å®ƒä»¬ä¹‹é—´å¯èƒ½äº§ç”Ÿçš„åŒ–å­¦ååº”å’Œæ–°çš„æ„ä¹‰ã€‚`;
  }

  const userContext = userInput
    ? `ã€ç”¨æˆ·å½“å‰çš„å¿ƒæƒ…/é—®é¢˜ã€‘
${userInput}`
    : `ã€ç”¨æˆ·å½“å‰çš„å¿ƒæƒ…/é—®é¢˜ã€‘
ç”¨æˆ·æ²¡æœ‰å†™ä¸‹å…·ä½“å†…å®¹ï¼Œè¯·åŸºäºå¡ç‰Œæœ¬èº«ç»™å‡ºæ¸©æŸ”çš„å¯å‘ã€‚`;

  return `${cardInfo}

${userContext}

è¯·æŒ‰ç…§ä»¥ä¸‹å…­æ®µå¼ç»“æ„ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä»½æ¸©æŸ”ã€æœ‰æ´å¯ŸåŠ›çš„è§£è¯»ï¼š

1ï¼‰ã€æˆ‘çœ‹è§ä½ çš„çŠ¶æ€ã€‘ï¼ˆ1-2å¥è¯ï¼Œæƒ…ç»ªå‘½å + å½“å‰çŠ¶æ€çš„æ¸©æŸ”æè¿°ï¼‰

2ï¼‰ã€å¿ƒç†å­¦æ´å¯Ÿã€‘ï¼ˆ2-3å¥è¯ï¼Œä»å›¾åƒ/è¯è¯­çš„è±¡å¾å‡ºå‘ï¼Œåˆ†æå¯èƒ½çš„å†…åœ¨éœ€æ±‚ä¸åŠ¨åŠ›ï¼‰

3ï¼‰ã€æ½œæ„è¯†çº¿ç´¢ã€‘ï¼ˆ2-3å¥è¯ï¼Œæ¸©æŸ”æ¨æµ‹æ›´æ·±å±‚çš„æ¸´æœ›æˆ–æ‹…å¿§ï¼Œä½¿ç”¨"å¯èƒ½ã€ä¹Ÿè®¸ã€æœ‰æ—¶"ç­‰è¡¨è¿°ï¼‰

4ï¼‰ã€è¡ŒåŠ¨å»ºè®®ã€‘ï¼ˆ1-3ä¸ªå°è€Œå¯è¡Œçš„è¡ŒåŠ¨æ­¥éª¤ï¼Œè¯­æ°”åƒæ•™ç»ƒï¼Œé¼“åŠ±ä½†ä¸å‘½ä»¤ï¼‰

5ï¼‰ã€ç»™è‡ªå·±çš„æé—®ã€‘ï¼ˆ3ä¸ªå¼€æ”¾å¼é—®é¢˜ï¼Œå¸®åŠ©ç”¨æˆ·ç»§ç»­å†™æ—¥è®°æˆ–æ€è€ƒï¼‰

6ï¼‰ã€æ¸©æŸ”æ”¶å°¾ã€‘ï¼ˆ1-2å¥ç®€çŸ­æ¸©æš–çš„è¯ï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°è¢«ç†è§£å’Œè¢«æ”¯æŒï¼‰

è¯·ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦è¾“å‡ºæ ‡é¢˜ç¼–å·ã€‚æ¯ä¸ªéƒ¨åˆ†ç”¨ç©ºè¡Œåˆ†éš”ã€‚`;
}

/**
 * è§£æAIè¿”å›çš„å†…å®¹
 * å°†å…­æ®µå¼ç»“æ„æ‹†åˆ†ä¸ºå¯¹åº”å­—æ®µ
 */
function parseAIResponse(content) {
  // æŒ‰ç©ºè¡Œåˆ†å‰²æ®µè½
  const paragraphs = content
    .split(/\n\s*\n/)
    .map((p) => p.trim())
    .filter((p) => p.length > 0);

  // å¦‚æœæ®µè½æ•°é‡ä¸è¶³6ä¸ªï¼Œå°è¯•å…¶ä»–åˆ†å‰²æ–¹å¼
  let sections = paragraphs;
  if (sections.length < 6) {
    // å°è¯•æŒ‰æ ‡é¢˜åˆ†å‰²
    sections = content
      .split(/ã€[^ã€‘]+ã€‘/)
      .map((p) => p.trim())
      .filter((p) => p.length > 0);
  }

  // ç¡®ä¿è‡³å°‘æœ‰6ä¸ªéƒ¨åˆ†
  while (sections.length < 6) {
    sections.push("");
  }

  return {
    insight: sections[0] + (sections[1] ? "\n\n" + sections[1] : ""),
    subconscious: sections[2] || "",
    actions: sections[3] || "",
    reflectionQuestions: sections[4] || "",
    closing: sections[5] || "",
  };
}

/**
 * OHå¡è§£è¯»äº‘å‡½æ•°ä¸»å…¥å£
 */
exports.main = async (event, context) => {
  const { mode, userInput, imageCard, wordCard } = event;

  console.log("=== OHå¡è§£è¯»äº‘å‡½æ•°å¼€å§‹ ===");
  console.log("æ¨¡å¼:", mode);
  console.log("å›¾å¡:", imageCard?.name);
  console.log("å­—å¡:", wordCard?.name || "æ— ");
  console.log("ç”¨æˆ·è¾“å…¥é•¿åº¦:", userInput?.length || 0);

  try {
    // å‚æ•°æ ¡éªŒ
    if (!imageCard || !imageCard.name) {
      throw new Error("ç¼ºå°‘å›¾å¡ä¿¡æ¯");
    }

    // ç”Ÿæˆæç¤ºè¯
    const userPrompt = generateUserPrompt(mode, userInput, imageCard, wordCard);

    console.log("ğŸ“¡ å¼€å§‹è°ƒç”¨ é˜¿é‡Œäº‘ OpenAI ä»£ç†...");

    // è°ƒç”¨é˜¿é‡Œäº‘ä»£ç†ï¼ˆä½¿ç”¨ä¸Šé¢å®ç°çš„ callOpenAIï¼‰
    const rawResponse = await callOpenAI({
      systemPrompt: SYSTEM_PROMPT,
      userPrompt,
      options: {
        model: "gpt-5-mini",
        temperature: 1,
        maxTokens: 1200,
        timeout: 2500, // æ§åˆ¶åœ¨ 3 ç§’ä»¥å†…
      },
    });

    console.log("âœ… ä»£ç†è¿”å›æˆåŠŸï¼Œå†…å®¹é•¿åº¦:", rawResponse.length);

    // ========== å†…å®¹å®‰å…¨å®¡æ ¸ ==========
    const { OPENID } = cloud.getWXContext();
    const safeResult = await safeAIResponse(
      rawResponse,
      "ohCard",
      OPENID || ""
    );

    if (!safeResult.passed) {
      console.warn("âš ï¸ OHå¡è§£è¯» AI å›å¤æœªé€šè¿‡å†…å®¹å®‰å…¨å®¡æ ¸ï¼Œä½¿ç”¨å…œåº•å†…å®¹");
      // å¦‚æœå®¡æ ¸ä¸é€šè¿‡ï¼Œè¿”å›å®‰å…¨çš„å…œåº•å†…å®¹
      const fallbackResult = {
        insight: getFallbackMessage("ohCard"),
        subconscious:
          "ä¹Ÿè®¸åœ¨æ›´æ·±çš„å±‚é¢ï¼Œä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§ç¡®è®¤â€”â€”ç¡®è®¤è‡ªå·±çš„æ„Ÿå—æ˜¯è¢«å…è®¸çš„ã€‚",
        actions:
          "1. ç»™è‡ªå·±5åˆ†é’Ÿï¼Œåªæ˜¯é™é™åœ°å‘¼å¸\n2. åœ¨çº¸ä¸Šå†™ä¸‹æ­¤åˆ»è„‘æµ·ä¸­ç¬¬ä¸€ä¸ªæµ®ç°çš„è¯\n3. ä»Šå¤©å¯¹è‡ªå·±è¯´ä¸€å¥æ¸©æŸ”çš„è¯",
        reflectionQuestions:
          "â€¢ æ­¤åˆ»æˆ‘æœ€æƒ³è¢«ç†è§£çš„æ˜¯ä»€ä¹ˆï¼Ÿ\nâ€¢ ä»€ä¹ˆæ˜¯æˆ‘ç°åœ¨å°±å¯ä»¥ç»™è‡ªå·±çš„ï¼Ÿ",
        closing:
          "æ— è®ºä½ ç°åœ¨æ„Ÿå—åˆ°ä»€ä¹ˆï¼Œéƒ½è¯·è®°å¾—ï¼šä½ ä¸éœ€è¦å®Œç¾ï¼Œä½ åªéœ€è¦çœŸå®ã€‚ğŸ’›",
      };
      return {
        success: true,
        data: fallbackResult,
      };
    }

    // è§£æè¿”å›å†…å®¹
    const parsedResult = parseAIResponse(safeResult.content);

    return {
      success: true,
      data: parsedResult,
    };
  } catch (err) {
    // å¢å¼ºé”™è¯¯æ—¥å¿—ï¼šæ‰“å°å®Œæ•´é”™è¯¯ä¿¡æ¯
    console.error("âŒ OHå¡è§£è¯»å¤±è´¥:");
    console.error("[ohInterpret] é”™è¯¯ç±»å‹:", err.name);
    console.error("[ohInterpret] é”™è¯¯ä¿¡æ¯:", err.message);
    console.error("[ohInterpret] é”™è¯¯è¯¦æƒ…:", err.stack);

    // è¿”å›æ¸©æŸ”çš„å…œåº•å†…å®¹
    const fallbackResult = {
      insight: `çœ‹åˆ°ã€Œ${
        imageCard?.name || "è¿™å¼ å¡"
      }ã€å‡ºç°åœ¨ä½ é¢å‰ï¼Œæˆ‘æ„Ÿå—åˆ°æ­¤åˆ»çš„ä½ å¯èƒ½æ­£åœ¨ç»å†ä¸€äº›å†…å¿ƒçš„æ³¢åŠ¨ã€‚è¿™å¾ˆæ­£å¸¸ï¼Œæ¯ä¸€ç§æƒ…ç»ªéƒ½å€¼å¾—è¢«çœ‹è§ã€‚`,
      subconscious: `ä¹Ÿè®¸åœ¨æ›´æ·±çš„å±‚é¢ï¼Œä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§ç¡®è®¤â€”â€”ç¡®è®¤è‡ªå·±çš„æ„Ÿå—æ˜¯è¢«å…è®¸çš„ï¼Œç¡®è®¤å‰æ–¹çš„è·¯è™½ç„¶æ¨¡ç³Šä½†ç»ˆä¼šæ¸…æ™°ã€‚`,
      actions: `1. ç»™è‡ªå·±5åˆ†é’Ÿï¼Œåªæ˜¯é™é™åœ°å‘¼å¸ï¼Œä¸éœ€è¦åšä»»ä½•äº‹\n2. åœ¨çº¸ä¸Šå†™ä¸‹æ­¤åˆ»è„‘æµ·ä¸­ç¬¬ä¸€ä¸ªæµ®ç°çš„è¯\n3. ä»Šå¤©å¯¹è‡ªå·±è¯´ä¸€å¥æ¸©æŸ”çš„è¯`,
      reflectionQuestions: `â€¢ æ­¤åˆ»æˆ‘æœ€æƒ³è¢«ç†è§£çš„æ˜¯ä»€ä¹ˆï¼Ÿ\nâ€¢ å¦‚æœææƒ§ä¼šè¯´è¯ï¼Œå®ƒæƒ³å‘Šè¯‰æˆ‘ä»€ä¹ˆï¼Ÿ\nâ€¢ ä»€ä¹ˆæ˜¯æˆ‘ç°åœ¨å°±å¯ä»¥ç»™è‡ªå·±çš„ï¼Ÿ`,
      closing: `æ— è®ºä½ ç°åœ¨æ„Ÿå—åˆ°ä»€ä¹ˆï¼Œéƒ½è¯·è®°å¾—ï¼šä½ ä¸éœ€è¦å®Œç¾ï¼Œä½ åªéœ€è¦çœŸå®ã€‚æˆ‘åœ¨è¿™é‡Œï¼Œé™ªç€ä½ ã€‚ğŸ’›`,
    };

    return {
      success: false,
      error: err.message,
      data: fallbackResult,
    };
  }
};
