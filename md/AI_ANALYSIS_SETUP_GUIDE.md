# 🤖 AI 深度解读功能配置指南

## 📋 概述

本指南将帮助你配置 MBTI 测试的 AI 深度解读功能。该功能使用 OpenAI API 为用户生成个性化的性格分析报告。

---

## ✅ 已完成的代码修改

### 1. 更新云函数代码

**文件：** `cloudfunctions/mbti-analyze/index.js`

**修改内容：**

- ✅ 引入 `wx-server-sdk` 和 `openaiClient`
- ✅ 使用 `callOpenAI` 函数调用 OpenAI API
- ✅ 添加了兜底逻辑（当 AI 服务不可用时返回默认内容）
- ✅ 完善了错误处理

**文件：** `cloudfunctions/mbti-analyze/package.json`

**修改内容：**

- ✅ 更新依赖为 `wx-server-sdk: ~2.6.3`（与其他云函数保持一致）

---

## 🚀 配置步骤

### 步骤 1：获取 OpenAI API Key

1. **访问 OpenAI 官网**

   - 网址：https://platform.openai.com/
   - 注册或登录账号

2. **创建 API Key**

   - 进入 API Keys 页面：https://platform.openai.com/api-keys
   - 点击 "Create new secret key"
   - 复制生成的 API Key（格式：`sk-...`）
   - ⚠️ **重要：** 保存好这个 Key，它只会显示一次！

3. **充值账户**（如果需要）
   - OpenAI API 是付费服务
   - 建议充值 $5-$10 用于测试
   - 使用 `gpt-5-mini` 模型成本很低（约 $0.15/1M tokens）

---

### 步骤 2：在微信开发者工具中配置云函数

#### 2.1 上传云函数

1. **右键点击 `mbti-analyze` 文件夹**

   - 选择 "上传并部署：云端安装依赖"
   - 等待上传完成

2. **检查上传状态**
   - 在云开发控制台查看云函数列表
   - 确认 `mbti-analyze` 已成功部署

#### 2.2 配置环境变量

1. **打开云开发控制台**

   - 在微信开发者工具中点击 "云开发" 按钮
   - 或访问：https://console.cloud.tencent.com/tcb

2. **进入云函数配置**

   - 点击左侧菜单 "云函数"
   - 找到 `mbti-analyze` 函数
   - 点击函数名称进入详情页

3. **添加环境变量**

   - 点击 "函数配置" 标签
   - 找到 "环境变量" 部分
   - 点击 "编辑"
   - 添加以下环境变量：

   | 变量名           | 变量值                 |
   | ---------------- | ---------------------- |
   | `OPENAI_API_KEY` | `sk-your-api-key-here` |

   - 点击 "保存"

4. **重启云函数**（可选）
   - 环境变量修改后，云函数会自动重启
   - 如果没有自动重启，可以手动重新部署

---

### 步骤 3：测试 AI 解读功能

#### 3.1 在小程序中测试

1. **完成 MBTI 测试**

   - 在小程序中进入 MBTI 测试页面
   - 完成所有 70 道题目
   - 查看测试结果

2. **点击 "AI 深度解读" 按钮**

   - 应该显示 "生成中..." 加载提示
   - 等待 5-10 秒
   - 查看生成的解读内容

3. **检查控制台日志**
   - 打开微信开发者工具的控制台
   - 查看是否有错误信息
   - 正常情况下应该看到：
     ```
     📡 准备调用云函数...
     📤 发送数据到云函数: {...}
     📥 云函数返回完整数据: {...}
     ✅ 解读成功，显示内容
     ```

#### 3.2 在云函数控制台测试

1. **打开云函数测试页面**

   - 在云开发控制台中找到 `mbti-analyze` 函数
   - 点击 "测试" 标签

2. **输入测试数据**

   ```json
   {
     "type": "INFJ",
     "scores": {
       "E": 5,
       "I": 13,
       "S": 8,
       "N": 10,
       "T": 7,
       "F": 11,
       "J": 12,
       "P": 6
     }
   }
   ```

3. **点击 "测试" 按钮**
   - 查看返回结果
   - 正常情况下应该返回：
     ```json
     {
       "success": true,
       "analysis": "【核心特质总结】\n你是一个 INFJ 类型的人..."
     }
     ```

---

## 🔍 故障排查

### 问题 1：云函数调用失败

**错误信息：** `cloud.callFunction:fail`

**可能原因：**

1. 云函数未上传或部署失败
2. 云环境未初始化

**解决方案：**

1. 检查云函数是否已成功部署
2. 在 `app.js` 中确认云环境已初始化：
   ```javascript
   wx.cloud.init({
     env: "your-env-id",
     traceUser: true,
   });
   ```

---

### 问题 2：OpenAI API 调用失败

**错误信息：** `OPENAI_API_KEY 未配置`

**解决方案：**

1. 检查环境变量是否正确配置
2. 确认 API Key 格式正确（以 `sk-` 开头）
3. 重新部署云函数

---

### 问题 3：返回默认解读内容

**现象：** 显示 "注：AI 服务暂时不可用，这是默认解读内容。"

**可能原因：**

1. OpenAI API Key 未配置或无效
2. OpenAI API 调用超时
3. 网络连接问题

**解决方案：**

1. 检查云函数日志，查看具体错误信息
2. 验证 API Key 是否有效
3. 检查 OpenAI 账户余额是否充足

---

## 💰 成本估算

使用 `gpt-5-mini` 模型：

- **输入成本：** $0.15 / 1M tokens
- **输出成本：** $0.60 / 1M tokens
- **单次解读成本：** 约 $0.001-0.003（0.007-0.02 元人民币）
- **1000 次解读成本：** 约 $1-3（7-20 元人民币）

**建议：**

- 初期测试：充值 $5-10
- 正式运营：根据用户量充值，建议设置用量提醒

---

## 📝 后续优化建议

### 1. 添加缓存机制

- 相同 MBTI 类型和分数的结果可以缓存
- 减少 API 调用次数，降低成本

### 2. 添加用量统计

- 记录每次 AI 调用的 token 使用量
- 监控成本，设置预算提醒

### 3. 优化 Prompt

- 根据用户反馈调整 System Prompt
- 让生成的内容更加个性化和准确

### 4. 添加重试机制

- 当 API 调用失败时自动重试
- 提高服务可用性

---

## ✅ 配置完成检查清单

- [ ] OpenAI API Key 已获取
- [ ] 云函数代码已更新
- [ ] 云函数已上传并部署
- [ ] 环境变量 `OPENAI_API_KEY` 已配置
- [ ] 在小程序中测试成功
- [ ] 在云函数控制台测试成功
- [ ] 查看了云函数日志，无错误
- [ ] OpenAI 账户余额充足

---

## 🎉 完成！

配置完成后，用户就可以在 MBTI 测试结果页面点击 "AI 深度解读" 按钮，获得个性化的性格分析报告了！

如果遇到问题，请查看云函数日志或联系技术支持。
