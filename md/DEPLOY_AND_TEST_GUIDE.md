# 🚀 云函数部署和测试完整指南

## 📋 前置准备

### 1. 确认 OpenAI API Key

- 访问：https://platform.openai.com/api-keys
- 确认你的 API Key 有效（格式：`sk-proj-...` 或 `sk-...`）
- 确认账户有余额（至少 $1）

### 2. 确认云开发环境

- 在微信开发者工具中点击"云开发"
- 确认已创建云开发环境
- 记录环境 ID

---

## 🔧 部署步骤

### 步骤 1：部署 common 公共模块

1. **在微信开发者工具左侧文件树中找到：**
   ```
   cloudfunctions/common
   ```

2. **右键点击 `common` 文件夹**

3. **选择"上传并部署：云端安装依赖"**

4. **等待部署完成**
   - 查看控制台输出
   - 确认显示"上传成功"

### 步骤 2：部署 mbti-analyze 云函数

1. **在微信开发者工具左侧文件树中找到：**
   ```
   cloudfunctions/mbti-analyze
   ```

2. **右键点击 `mbti-analyze` 文件夹**

3. **选择"上传并部署：云端安装依赖"**
   - ⚠️ 必须选择"云端安装依赖"
   - 不要选择"全部文件"

4. **等待部署完成**
   - 查看控制台输出
   - 确认显示"上传成功"
   - 部署时间约 1-2 分钟

### 步骤 3：配置环境变量

1. **打开云开发控制台**
   - 方式 1：在微信开发者工具中点击"云开发"按钮
   - 方式 2：访问 https://console.cloud.tencent.com/tcb

2. **进入云函数配置**
   - 点击左侧菜单"云函数"
   - 找到 `mbti-analyze` 函数
   - 点击函数名称进入详情页

3. **添加环境变量**
   - 点击"函数配置"标签
   - 找到"环境变量"部分
   - 点击"编辑"
   - 添加环境变量：
     - **变量名：** `OPENAI_API_KEY`
     - **变量值：** 粘贴你的 OpenAI API Key
   - 点击"保存"

4. **等待配置生效**
   - 环境变量修改后，云函数会自动重启
   - 等待 1-2 分钟

---

## 🧪 测试步骤

### 测试 1：在云开发控制台测试

1. **打开云开发控制台**
2. **进入云函数 → mbti-analyze**
3. **点击"测试"标签**
4. **输入测试数据：**
   ```json
   {
     "type": "INFJ",
     "scores": {
       "E": 5,
       "I": 13,
       "S": 8,
       "N": 10,
       "T": 7,
       "F": 10,
       "J": 11,
       "P": 6
     }
   }
   ```
5. **点击"测试"按钮**
6. **查看返回结果**

**预期结果：**
```json
{
  "success": true,
  "analysis": "【核心特质总结】...",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

**如果失败，查看日志：**
- 点击"日志"标签
- 查看详细错误信息
- 根据错误信息排查问题

### 测试 2：在微信开发者工具 Console 测试

1. **打开微信开发者工具**
2. **点击底部的"Console"标签**
3. **复制并粘贴以下代码：**

```javascript
console.log('=== 开始测试 MBTI AI 解读云函数 ===\n');

const testData = {
  type: 'INFJ',
  scores: {
    E: 5,
    I: 13,
    S: 8,
    N: 10,
    T: 7,
    F: 10,
    J: 11,
    P: 6
  }
};

console.log('测试数据：', testData);
console.log('调用云函数...\n');

wx.cloud.callFunction({
  name: 'mbti-analyze',
  data: testData
}).then(res => {
  console.log('✅ 云函数调用成功！');
  console.log('返回结果：', res);
  
  if (res.result && res.result.success) {
    console.log('\n✅ 解读生成成功！');
    console.log('解读内容预览：');
    console.log(res.result.analysis.substring(0, 200) + '...');
  } else {
    console.error('\n❌ 云函数返回失败！');
    console.error('错误信息：', res.result);
  }
}).catch(err => {
  console.error('❌ 云函数调用失败！');
  console.error('错误信息：', err);
});
```

4. **按回车执行**
5. **查看输出结果**

### 测试 3：在小程序中测试

1. **在小程序中进入 MBTI 测试页面**
2. **完成所有 70 道题目**
3. **查看测试结果页面**
4. **点击"获取 AI 深度解读"按钮**
5. **查看控制台输出**
6. **确认是否显示 AI 解读内容**

---

## 🔍 查看日志

### 在云开发控制台查看日志

1. **打开云开发控制台**
2. **进入云函数 → mbti-analyze**
3. **点击"日志"标签**
4. **查看最近的调用日志**

**日志中应该包含：**
- ✅ `=== MBTI 分析云函数开始执行 ===`
- ✅ `接收到的参数: {...}`
- ✅ `✅ 参数校验通过`
- ✅ `✅ 环境变量已配置`
- ✅ `=== OpenAI Client 开始执行 ===`
- ✅ `📡 发送 HTTPS 请求...`
- ✅ `📥 收到响应，状态码: 200`
- ✅ `✅ OpenAI 返回分析结果`

**如果出现错误，日志会显示：**
- ❌ `❌ 环境变量 OPENAI_API_KEY 未配置`
- ❌ `❌ OpenAI API 错误`
- ❌ `❌ OpenAI API 请求超时`

---

## ❓ 常见问题

### 问题 1：云函数调用失败 - "function not found"

**解决方法：**
1. 确认云函数已上传
2. 在云开发控制台查看云函数列表
3. 重新部署云函数

### 问题 2：环境变量未生效

**解决方法：**
1. 在云开发控制台确认环境变量已保存
2. 等待 1-2 分钟让配置生效
3. 重新部署云函数

### 问题 3：OpenAI API 调用失败

**解决方法：**
1. 检查 API Key 是否正确
2. 访问 https://platform.openai.com/account/usage 查看余额
3. 确认网络连接正常
4. 查看云函数日志中的详细错误信息

---

## ✅ 部署成功标志

完成以上步骤后，如果看到以下情况，说明部署成功：

- ✅ 云函数列表中显示 `mbti-analyze`
- ✅ 环境变量中显示 `OPENAI_API_KEY`
- ✅ 云开发控制台测试通过
- ✅ 小程序中能正常获取 AI 解读

---

## 📞 需要帮助？

如果按照以上步骤仍然无法解决问题，请提供：

1. 云函数日志截图
2. 控制台错误信息
3. 云函数测试结果
4. OpenAI API Key 状态（不要泄露完整 Key）

