# 云存储部署指南 - 解决主包体积超限问题 ☁️

## 🎯 问题概述

**当前问题**：主包体积超过 1.5MB 限制，无法上传
- 塔罗牌图片：206MB（81 张图片）
- 音频文件：6.3MB
- 冥想封面：10MB

**解决方案**：将大文件上传到微信云存储，通过 URL 加载

---

## 📋 部署步骤

### 步骤 1：打开云开发控制台（2 分钟）

1. 在微信开发者工具中，点击顶部菜单栏的 **"云开发"** 按钮
2. 如果是第一次使用，需要开通云开发：
   - 点击 **"开通"**
   - 选择 **"按量付费"**（免费额度足够使用）
   - 创建环境（环境名称：`cloud1-5gc5jltwbcbef586`）
3. 等待环境初始化完成（约 1-2 分钟）

---

### 步骤 2：创建云存储文件夹（1 分钟）

1. 在云开发控制台中，点击左侧 **"存储"**
2. 点击 **"文件管理"**
3. 创建以下文件夹：
   - `tarot/` - 存放塔罗牌图片
   - `meditation/` - 存放冥想封面
   - `audio/` - 存放音频文件

---

### 步骤 3：上传塔罗牌图片（10 分钟）

#### 方法 A：手动上传（推荐，简单）

1. 在云开发控制台的 **"存储"** -> **"文件管理"** 中
2. 进入 `tarot/` 文件夹
3. 点击 **"上传文件"** 按钮
4. 选择 `images/tarrot-cards/PNG/` 目录下的所有图片
5. 批量上传（可以一次选择多个文件）

**重要**：上传时保持原文件名，例如：
- `0-The Fool.png`
- `1-The Magician.png`
- `2-The High Priestess.png`
- ...

#### 方法 B：使用云开发 CLI（高级）

```bash
# 安装云开发 CLI
npm install -g @cloudbase/cli

# 登录
tcb login

# 批量上传
tcb storage upload images/tarrot-cards/PNG/ tarot/
```

---

### 步骤 4：获取云存储文件 ID（5 分钟）

上传完成后，每个文件会自动获得一个云存储 ID，格式如下：

```
cloud://环境ID.xxxx/tarot/0-The Fool.png
```

**示例**：
```
cloud://cloud1-5gc5jltwbcbef586.636c-cloud1-5gc5jltwbcbef586-1330238286/tarot/0-The Fool.png
```

**如何获取完整的云存储 ID**：
1. 在云开发控制台的文件列表中
2. 点击任意文件
3. 复制 **"File ID"**（文件 ID）
4. 记录下环境 ID 的完整格式（包括后面的数字部分）

---

### 步骤 5：更新数据库配置（3 分钟）

我已经为您准备好了更新后的 `tarotCards.json` 文件。

**操作步骤**：
1. 打开云开发控制台
2. 点击 **"数据库"**
3. 找到 `tarotCards` 集合
4. 点击 **"导入"**
5. 选择更新后的 `database/init-data/tarotCards-cloud.json` 文件
6. 选择 **"覆盖导入"**

---

### 步骤 6：上传音频文件（2 分钟）

1. 在云开发控制台的 **"存储"** 中
2. 进入 `audio/` 文件夹
3. 上传 `database/顶轮之光.mp3`
4. 获取文件 ID

---

### 步骤 7：上传冥想封面（可选，5 分钟）

如果冥想封面图片也很大，可以同样上传到云存储：

1. 进入 `meditation/` 文件夹
2. 上传 `images/meditation/` 中的所有图片
3. 更新 `meditations.json` 中的图片路径

---

### 步骤 8：删除本地大文件（1 分钟）

上传完成并确认功能正常后，删除本地的大文件：

```bash
# 备份原文件（可选）
mkdir ~/Desktop/InnerSeed-backup
cp -r images/tarrot-cards ~/Desktop/InnerSeed-backup/
cp database/顶轮之光.mp3 ~/Desktop/InnerSeed-backup/

# 删除本地文件
rm -rf images/tarrot-cards
rm database/顶轮之光.mp3
```

---

### 步骤 9：测试功能（5 分钟）

1. 在微信开发者工具中点击 **"编译"**
2. 进入 **"塔罗牌"** 页面
3. 测试抽牌功能
4. 确认图片能正常显示

**如果图片无法显示**：
- 检查云存储文件 ID 是否正确
- 检查云存储权限设置（应该是 **"所有用户可读"**）
- 查看控制台是否有错误信息

---

### 步骤 10：重新上传小程序（2 分钟）

1. 点击微信开发者工具顶部的 **"上传"** 按钮
2. 填写版本号和备注
3. 点击 **"上传"**
4. 等待上传完成

**预期结果**：
- ✅ 主包体积：< 1.5MB
- ✅ 代码质量检查：通过
- ✅ 功能正常：塔罗牌图片正常显示

---

## 📊 优化效果对比

| 项目 | 优化前 | 优化后 | 节省 |
|------|--------|--------|------|
| 塔罗牌图片 | 206MB（本地） | 0MB（云存储） | 206MB |
| 音频文件 | 6.3MB（本地） | 0MB（云存储） | 6.3MB |
| 主包体积 | > 200MB | < 1.5MB | > 200MB |
| 上传状态 | ❌ 失败 | ✅ 成功 | - |

---

## 🔧 云存储权限设置

确保云存储文件的权限设置正确：

1. 在云开发控制台的 **"存储"** -> **"权限设置"** 中
2. 添加以下规则：

```json
{
  "read": true,
  "write": false
}
```

这样所有用户都可以读取文件，但不能修改。

---

## 📝 更新后的文件路径

### 塔罗牌图片
```javascript
// 优化前
image: "/images/tarot/fool.png"

// 优化后
image: "cloud://cloud1-5gc5jltwbcbef586.636c-cloud1-5gc5jltwbcbef586-1330238286/tarot/0-The Fool.png"
```

### 音频文件
```javascript
// 优化前
audioUrl: "/database/顶轮之光.mp3"

// 优化后
audioUrl: "cloud://cloud1-5gc5jltwbcbef586.636c-cloud1-5gc5jltwbcbef586-1330238286/audio/顶轮之光.mp3"
```

---

## ⚠️ 注意事项

1. **环境 ID**：请将示例中的环境 ID 替换为您实际的环境 ID
2. **文件名**：上传时保持原文件名，避免中文和特殊字符
3. **权限**：确保云存储权限设置为 "所有用户可读"
4. **备份**：删除本地文件前，务必备份原文件
5. **测试**：上传后务必测试所有功能是否正常

---

## 🐛 常见问题

### Q1: 图片无法显示，显示空白
**A**: 检查云存储文件 ID 是否正确，确保包含完整的环境 ID

### Q2: 提示 "云存储权限不足"
**A**: 在云开发控制台设置权限为 "所有用户可读"

### Q3: 上传后主包体积还是很大
**A**: 确认已删除本地的大文件，并重新编译

### Q4: 云存储费用问题
**A**: 微信云存储有免费额度：
- 存储空间：5GB
- 下载流量：5GB/月
- 对于个人小程序完全够用

---

## 🎉 完成检查清单

- [ ] 开通云开发环境
- [ ] 创建云存储文件夹（tarot、meditation、audio）
- [ ] 上传塔罗牌图片到云存储
- [ ] 获取云存储文件 ID
- [ ] 更新 tarotCards.json 配置
- [ ] 上传音频文件到云存储
- [ ] 删除本地大文件
- [ ] 测试塔罗牌功能
- [ ] 重新上传小程序
- [ ] 验证主包体积 < 1.5MB

---

## 📚 相关文档

- [微信云存储官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/storage.html)
- [云存储 API 文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/storage/Cloud.uploadFile.html)
- [小程序包大小限制](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/limits.html)

---

如有任何问题，请随时联系！🌟

