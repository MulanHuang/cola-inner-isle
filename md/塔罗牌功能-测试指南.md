# 塔罗牌功能测试指南 🔮

## ✅ 已完成的修复

### 1. JSON 文件格式修复

- ✅ 修复了 `database/init-data/tarotCards-cloud.json` 的格式错误
- ✅ 添加了数组包裹符号 `[` 和 `]`
- ✅ 在所有对象之间添加了逗号分隔符
- ✅ 文件现在是有效的 JSON 格式

### 2. 数据准备

- ✅ 78 张塔罗牌数据已准备好（22 张大阿尔卡纳 + 56 张小阿尔卡纳）
- ✅ 所有图片使用云存储 URL
- ✅ 环境 ID：`cloud1-5gc5jltwbcbef586.636c-cloud1-5gc5jltwbcbef586-1386967363`

---

## 🚀 测试步骤

### 步骤 1：导入塔罗牌数据到云数据库（5 分钟）

#### 方法 A：通过云开发控制台导入（推荐）

1. 打开微信开发者工具
2. 点击顶部菜单 **"云开发"**
3. 进入 **"数据库"** 标签
4. 找到或创建 **`tarotCards`** 集合
5. 点击 **"导入"** 按钮
6. 选择文件：`database/init-data/tarotCards-cloud.json`
7. 导入模式：**"覆盖导入"**（如果已有数据）或 **"追加导入"**（如果是新集合）
8. 点击 **"确定"**
9. 等待导入完成，应该显示 **78 条记录**

#### 方法 B：通过代码导入（备选）

如果云开发控制台导入失败，可以使用代码导入：

```javascript
// 在小程序中临时添加这段代码
const db = wx.cloud.database();
const tarotData = require("./database/init-data/tarotCards-cloud.json");

async function importTarotCards() {
  const batchSize = 20; // 每次导入 20 条
  for (let i = 0; i < tarotData.length; i += batchSize) {
    const batch = tarotData.slice(i, i + batchSize);
    await db.collection("tarotCards").add({
      data: batch,
    });
    console.log(`已导入 ${i + batch.length} / ${tarotData.length} 条`);
  }
  console.log("导入完成！");
}
```

---

### 步骤 2：上传塔罗牌图片到云存储（10 分钟）

⚠️ **重要**：如果您还没有上传塔罗牌图片到云存储，请先完成这一步。

1. 进入云开发控制台 → **存储**
2. 创建文件夹：`tarot/PNG/`
3. 上传 78 张塔罗牌图片（参考 `塔罗牌文件映射表.md`）
4. 确认文件名与 JSON 中的路径一致

**示例文件名**：

- `0-The Fool.png`
- `1-The Magician.png`
- `C1-Ace of Cups.png`
- `W-King of Wands.png`

---

### 步骤 3：设置云存储权限（1 分钟）

1. 云开发控制台 → **存储** → **权限设置**
2. 添加规则：
   ```json
   {
     "read": true,
     "write": false
   }
   ```
3. 保存

---

### 步骤 4：测试塔罗牌功能（5 分钟）

#### 4.1 编译小程序

1. 在微信开发者工具中点击 **"编译"**
2. 确认没有编译错误

#### 4.2 进入塔罗牌页面

1. 在模拟器中点击底部导航栏的 **"塔罗牌"** 图标
2. 应该看到：
   - 标题：🔮 每日塔罗
   - 副标题：静心冥想，抽取今日指引
   - 5 张卡牌背面图片

#### 4.3 选择卡牌

1. 点击任意一张卡牌
2. 卡牌应该有选中效果（边框或高亮）
3. **"抽取塔罗牌"** 按钮应该变为可点击状态

#### 4.4 抽取塔罗牌

1. 点击 **"抽取塔罗牌"** 按钮
2. 应该显示 **"抽取中..."** 加载提示
3. 抽取成功后应该显示：
   - ✅ 塔罗牌正面图片
   - ✅ 塔罗牌名称（如：愚者）
   - ✅ 关键词（如：新开始、冒险、纯真）
   - ✅ 问题输入框
   - ✅ **"获取解读"** 按钮

#### 4.5 测试 AI 解读（可选）

1. 在问题输入框中输入问题（如：我今天应该注意什么？）
2. 点击 **"获取解读"** 按钮
3. 应该显示 AI 生成的解读内容

---

## 🐛 常见问题排查

### 问题 1：点击"抽取塔罗牌"后显示"抽取失败"

**可能原因**：

- 数据库中没有塔罗牌数据
- 云开发环境未初始化

**解决方法**：

1. 检查云开发控制台 → 数据库 → tarotCards 集合
2. 确认有 78 条记录
3. 检查 `app.js` 中的云开发初始化代码：
   ```javascript
   wx.cloud.init({
     env: "cloud1-5gc5jltwbcbef586",
     traceUser: true,
   });
   ```

---

### 问题 2：塔罗牌图片显示空白

**可能原因**：

- 云存储中没有图片
- 环境 ID 不正确
- 云存储权限未设置

**解决方法**：

1. 检查云存储中是否有 `tarot/PNG/` 文件夹和图片
2. 检查环境 ID 是否与实际一致
3. 设置云存储权限为 "所有用户可读"

**验证环境 ID**：

1. 在云存储中上传一个测试文件
2. 查看文件的 File ID
3. 对比 JSON 中的环境 ID 是否一致

---

### 问题 3：控制台显示 "cloud file not found"

**可能原因**：

- 文件名不匹配
- 文件路径不正确

**解决方法**：

1. 检查云存储中的文件名是否与 JSON 中的一致
2. 注意大小写和空格
3. 确认路径格式：`cloud://环境ID/tarot/PNG/文件名.png`

---

### 问题 4：今天已经抽过牌，无法再次抽取

**说明**：这是正常行为，每天只能抽取一次塔罗牌。

**如果需要测试**：

1. 在云数据库中删除 `tarotDraws` 集合中的今日记录
2. 或者修改代码中的日期检查逻辑（仅用于测试）

---

## 📊 测试检查清单

### 数据准备

- [ ] tarotCards-cloud.json 格式正确（有效的 JSON）
- [ ] 云数据库中有 78 条塔罗牌记录
- [ ] 云存储中有 78 张塔罗牌图片
- [ ] 云存储权限设置为 "所有用户可读"

### 功能测试

- [ ] 能进入塔罗牌页面
- [ ] 能看到 5 张卡牌背面
- [ ] 能选择卡牌（有选中效果）
- [ ] 能点击"抽取塔罗牌"按钮
- [ ] 抽取后能看到塔罗牌正面图片
- [ ] 能看到塔罗牌名称和关键词
- [ ] 能输入问题
- [ ] 能获取 AI 解读（如果配置了 API）

### 视觉效果

- [ ] 卡牌背面图片正常显示
- [ ] 卡牌正面图片正常显示（云存储）
- [ ] 选中效果明显
- [ ] 加载提示正常
- [ ] 布局美观，无错位

---

## 🎯 预期效果

### 抽取前

```
┌─────────────────────────────────┐
│       🔮 每日塔罗                │
│   静心冥想，抽取今日指引          │
│                                 │
│  [卡背] [卡背] [卡背] [卡背] [卡背] │
│                                 │
│    [抽取塔罗牌] (按钮)           │
└─────────────────────────────────┘
```

### 抽取后

```
┌─────────────────────────────────┐
│      [塔罗牌正面图片]            │
│                                 │
│         愚者                     │
│    新开始、冒险、纯真            │
│                                 │
│  💭 你想问什么？                 │
│  [输入框]                        │
│                                 │
│    [获取解读] (按钮)             │
│                                 │
│  ✨ AI 解读                      │
│  [解读内容]                      │
└─────────────────────────────────┘
```

---

## 📝 测试记录

测试日期：****\_\_****

| 测试项   | 结果          | 备注 |
| -------- | ------------- | ---- |
| 数据导入 | ☐ 通过 ☐ 失败 |      |
| 图片上传 | ☐ 通过 ☐ 失败 |      |
| 权限设置 | ☐ 通过 ☐ 失败 |      |
| 进入页面 | ☐ 通过 ☐ 失败 |      |
| 选择卡牌 | ☐ 通过 ☐ 失败 |      |
| 抽取功能 | ☐ 通过 ☐ 失败 |      |
| 图片显示 | ☐ 通过 ☐ 失败 |      |
| AI 解读  | ☐ 通过 ☐ 失败 |      |

---

## 🎉 完成标志

当您看到以下情况时，说明塔罗牌功能正常运行：

1. ✅ 能成功抽取塔罗牌
2. ✅ 塔罗牌正面图片正常显示
3. ✅ 塔罗牌信息完整（名称、关键词、含义）
4. ✅ 能输入问题并获取解读
5. ✅ 控制台无错误信息

---

祝您测试顺利！🎊

如有问题，请查看 `云存储部署指南.md` 或告诉我具体的错误信息。
