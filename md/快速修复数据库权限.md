# 🚀 快速修复数据库权限问题

## 问题症状

- ❌ 保存塔罗记录失败
- ❌ 保存行动计划失败  
- ❌ 获取历史记录失败
- ❌ 错误提示：`database permission denied`

---

## ⚡ 5分钟快速修复

### 步骤 1：打开云开发控制台（30秒）

1. 打开微信开发者工具
2. 点击顶部菜单：**云开发** → **云开发控制台**
3. 左侧菜单选择：**数据库**

---

### 步骤 2：批量配置权限（3分钟）

#### 需要配置的集合清单：

| 集合名称 | 权限设置 | 说明 |
|---------|---------|------|
| ✅ tarotDraws | 仅创建者可读写 | 塔罗抽牌记录 |
| ✅ tarotDraw | 仅创建者可读写 | 塔罗抽牌记录（备用） |
| ✅ emotions | 仅创建者可读写 | 情绪记录 |
| ✅ chats | 仅创建者可读写 | 对话记录 |
| ✅ meditationHistory | 仅创建者可读写 | 冥想历史 |
| ✅ users | 仅创建者可读写 | 用户信息 |
| ✅ chakra_history | 仅创建者可读写 | 脉轮测试历史 |
| 📖 tarotCards | 所有用户可读 | 塔罗牌数据（公共） |
| 📖 quotes | 所有用户可读 | 每日一句（公共） |
| 📖 meditations | 所有用户可读 | 冥想音频（公共） |

---

### 步骤 3：配置方法（每个集合30秒）

#### 方法 A：仅创建者可读写（用户数据）

1. 点击集合名称（如 `tarotDraws`）
2. 点击右上角 **权限设置**
3. 选择：**仅创建者可读写**
4. 点击 **确定**

**权限规则**：
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 方法 B：所有用户可读（公共数据）

1. 点击集合名称（如 `tarotCards`）
2. 点击右上角 **权限设置**
3. 选择：**所有用户可读，仅创建者可写**
4. 或者自定义规则：

```json
{
  "read": true,
  "write": false
}
```

5. 点击 **确定**

---

### 步骤 4：测试（1分钟）

1. 回到微信开发者工具
2. 点击 **编译** 重新编译小程序
3. 进入 **塔罗牌** 页面
4. 尝试抽取塔罗牌
5. 查看是否能成功保存

---

## 🎯 重点集合（必须配置）

如果时间紧张，至少配置这3个：

### 1. tarotDraws（最重要）
```
权限：仅创建者可读写
用途：保存塔罗抽牌记录
```

### 2. tarotCards（必须）
```
权限：所有用户可读
用途：读取塔罗牌数据
```

### 3. emotions（推荐）
```
权限：仅创建者可读写
用途：保存情绪记录
```

---

## 🔍 验证权限配置

### 检查清单

在云开发控制台 → 数据库中，检查每个集合的权限设置：

- [ ] tarotDraws - 显示 "仅创建者可读写"
- [ ] tarotCards - 显示 "所有用户可读，仅创建者可写" 或自定义
- [ ] emotions - 显示 "仅创建者可读写"
- [ ] chats - 显示 "仅创建者可读写"
- [ ] users - 显示 "仅创建者可读写"

---

## ❓ 常见问题

### Q1: 集合不存在怎么办？

**A**: 先创建集合
1. 点击 **添加集合**
2. 输入集合名称（如 `tarotDraws`）
3. 点击 **确定**
4. 然后配置权限

### Q2: 配置后还是报错？

**A**: 尝试以下步骤
1. 清除缓存：**工具** → **清除缓存** → **清除全部**
2. 重新编译：点击 **编译**
3. 重启开发者工具

### Q3: 如何确认权限生效？

**A**: 查看控制台
1. 打开 **控制台** 标签
2. 尝试保存数据
3. 如果没有权限错误，说明配置成功

---

## 📱 测试步骤

### 测试 1：抽取塔罗牌
1. 进入塔罗牌页面
2. 输入问题
3. 点击抽取
4. ✅ 应该显示 "抽取成功"

### 测试 2：保存行动计划
1. 抽取塔罗牌后
2. 输入行动计划
3. 点击保存
4. ✅ 应该显示 "已保存"

### 测试 3：查看历史
1. 点击 "查看历史"
2. ✅ 应该能看到之前的记录

---

## 🎉 完成

配置完成后，所有保存功能都应该正常工作了！

如果还有问题，请查看详细文档：《数据库权限配置指南.md》

