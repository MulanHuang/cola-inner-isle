# ğŸ” æ‚¬æµ®æŒ‰é’®æ˜¾ç¤ºé—®é¢˜è¯Šæ–­

## é—®é¢˜æè¿°
- âœ… é™ªä¼´é¡µé¢å’Œä¸ªäººä¸­å¿ƒé¡µé¢å¯ä»¥çœ‹åˆ°æ‚¬æµ®æŒ‰é’®
- âŒ é¦–é¡µå’Œå†¥æƒ³é¡µé¢çœ‹ä¸åˆ°æ‚¬æµ®æŒ‰é’®

---

## ğŸ”§ å¯èƒ½çš„åŸå› 

### **åŸå› 1ï¼šç»„ä»¶æœªæ­£ç¡®åŠ è½½**
- å…¨å±€æ³¨å†Œå·²ç¡®è®¤æ­£ç¡®ï¼ˆ`app.json` ä¸­å·²é…ç½®ï¼‰
- æ‰€æœ‰é¡µé¢çš„ WXML ä¸­éƒ½å·²æ·»åŠ  `<audio-float />`
- å¯èƒ½æ˜¯ç»„ä»¶åˆå§‹åŒ–æ—¶æœºé—®é¢˜

### **åŸå› 2ï¼šåˆå§‹ä½ç½®è¶…å‡ºå±å¹•**
- ç»„ä»¶ä½¿ç”¨ `position: fixed` å®šä½
- åˆå§‹ä½ç½®é€šè¿‡ `left` å’Œ `top` è®¡ç®—
- å¯èƒ½åœ¨æŸäº›é¡µé¢è®¡ç®—é”™è¯¯å¯¼è‡´æŒ‰é’®è¶…å‡ºå±å¹•

### **åŸå› 3ï¼šz-index å±‚çº§é—®é¢˜**
- æŸäº›é¡µé¢çš„å…ƒç´  z-index å¯èƒ½æ›´é«˜
- å¯¼è‡´æŒ‰é’®è¢«é®æŒ¡

### **åŸå› 4ï¼šé¡µé¢æ ·å¼å†²çª**
- æŸäº›é¡µé¢å¯èƒ½æœ‰å…¨å±€æ ·å¼è¦†ç›–
- å¯¼è‡´æŒ‰é’®ä¸å¯è§

---

## ğŸš€ è§£å†³æ–¹æ¡ˆ

### **æ–¹æ¡ˆ1ï¼šæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. æ‰“å¼€"æ§åˆ¶å°"æ ‡ç­¾
2. æ’­æ”¾éŸ³é¢‘
3. æŸ¥çœ‹æ˜¯å¦æœ‰ `[AudioFloat]` å¼€å¤´çš„æ—¥å¿—
4. æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

**é¢„æœŸæ—¥å¿—ï¼š**
```
[AudioFloat] éŸ³é¢‘å¼€å§‹æ’­æ”¾
```

å¦‚æœæ²¡æœ‰è¿™æ¡æ—¥å¿—ï¼Œè¯´æ˜ç»„ä»¶çš„ `onPlay` äº‹ä»¶æ²¡æœ‰è§¦å‘ã€‚

---

### **æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®ï¼ˆè°ƒè¯•ç”¨ï¼‰**

ä¸´æ—¶ä¿®æ”¹ `audio-float.js`ï¼Œåœ¨ `attached()` ä¸­å¼ºåˆ¶æ˜¾ç¤ºï¼š

```javascript
attached() {
  this.audioManager = wx.getBackgroundAudioManager();
  this.getSystemInfo();
  this.initAudioManager();
  this.checkInitialState();
  
  // ä¸´æ—¶ï¼šå¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®ï¼ˆè°ƒè¯•ç”¨ï¼‰
  setTimeout(() => {
    this.setData({
      visible: true,
      playing: true,
      title: 'æµ‹è¯•æ˜¾ç¤º'
    });
  }, 1000);
}
```

å¦‚æœè¿™æ ·å¯ä»¥çœ‹åˆ°æŒ‰é’®ï¼Œè¯´æ˜é—®é¢˜åœ¨äºéŸ³é¢‘äº‹ä»¶ç›‘å¬ã€‚

---

### **æ–¹æ¡ˆ3ï¼šæ£€æŸ¥éŸ³é¢‘ç®¡ç†å™¨çŠ¶æ€**

åœ¨ `checkInitialState()` ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```javascript
checkInitialState() {
  const manager = this.audioManager;
  
  console.log('[AudioFloat] æ£€æŸ¥åˆå§‹çŠ¶æ€');
  console.log('[AudioFloat] src:', manager.src);
  console.log('[AudioFloat] paused:', manager.paused);
  console.log('[AudioFloat] title:', manager.title);
  
  if (manager.src && !manager.paused) {
    console.log('[AudioFloat] æ£€æµ‹åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘');
    this.setData({
      visible: true,
      playing: true,
      title: manager.title || 'æ­£åœ¨æ’­æ”¾',
    });
  } else {
    console.log('[AudioFloat] æ²¡æœ‰æ£€æµ‹åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘');
  }
}
```

---

### **æ–¹æ¡ˆ4ï¼šä¿®å¤åˆå§‹ä½ç½®è®¡ç®—**

ç¡®ä¿åˆå§‹ä½ç½®åœ¨æ‰€æœ‰é¡µé¢éƒ½æ­£ç¡®ï¼š

```javascript
getSystemInfo() {
  const systemInfo = wx.getSystemInfoSync();
  const windowWidth = systemInfo.windowWidth;
  const windowHeight = systemInfo.windowHeight;
  
  console.log('[AudioFloat] çª—å£å°ºå¯¸:', windowWidth, windowHeight);

  // è®¾ç½®åˆå§‹ä½ç½®ï¼ˆå³ä¸‹è§’ï¼‰
  const left = windowWidth - 150;
  const top = windowHeight - 180;
  
  console.log('[AudioFloat] åˆå§‹ä½ç½®:', left, top);

  this.setData({
    windowWidth,
    windowHeight,
    left,
    top,
  });
}
```

---

### **æ–¹æ¡ˆ5ï¼šæ£€æŸ¥é¡µé¢å±‚çº§**

åœ¨é¦–é¡µå’Œå†¥æƒ³é¡µé¢çš„ WXSS ä¸­ï¼Œç¡®ä¿æ²¡æœ‰é«˜ z-index çš„å…ƒç´ ï¼š

```css
/* æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼è¿™æ ·çš„æ ·å¼ */
.some-element {
  z-index: 10000; /* å¦‚æœå¤§äº9999ï¼Œä¼šé®æŒ¡æŒ‰é’® */
}
```

---

### **æ–¹æ¡ˆ6ï¼šä½¿ç”¨é¡µé¢çº§æ³¨å†Œï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰**

åœ¨é¦–é¡µçš„ `home.json` ä¸­æ·»åŠ ï¼š

```json
{
  "navigationBarTitleText": "",
  "navigationStyle": "custom",
  "usingComponents": {
    "audio-float": "/components/audio-float/audio-float"
  }
}
```

å¦‚æœè¿™æ ·å¯ä»¥æ˜¾ç¤ºï¼Œè¯´æ˜å…¨å±€æ³¨å†Œæœ‰é—®é¢˜ã€‚

---

## ğŸ§ª å¿«é€Ÿæµ‹è¯•æ­¥éª¤

### **æ­¥éª¤1ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—**

ä¿®æ”¹ `components/audio-float/audio-float.js`ï¼š

```javascript
lifetimes: {
  attached() {
    console.log('[AudioFloat] ç»„ä»¶å·²åŠ è½½');
    this.audioManager = wx.getBackgroundAudioManager();
    this.getSystemInfo();
    this.initAudioManager();
    this.checkInitialState();
  }
}
```

### **æ­¥éª¤2ï¼šé‡æ–°ç¼–è¯‘**
1. ä¿å­˜æ‰€æœ‰æ–‡ä»¶
2. ç‚¹å‡»"ç¼–è¯‘"æŒ‰é’®
3. æ¸…é™¤ç¼“å­˜ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰

### **æ­¥éª¤3ï¼šæµ‹è¯•é¦–é¡µ**
1. è¿›å…¥é¦–é¡µ
2. æ‰“å¼€æ§åˆ¶å°
3. æŸ¥çœ‹æ˜¯å¦æœ‰ `[AudioFloat] ç»„ä»¶å·²åŠ è½½` æ—¥å¿—

### **æ­¥éª¤4ï¼šæ’­æ”¾éŸ³é¢‘**
1. è¿›å…¥å†¥æƒ³é¡µé¢
2. æ’­æ”¾ä»»æ„éŸ³é¢‘
3. è¿”å›é¦–é¡µ
4. æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºæŒ‰é’®

---

## ğŸ’¡ æ¨èçš„è°ƒè¯•ä»£ç 

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° `audio-float.js` ä¸­ï¼Œå¸®åŠ©è¯Šæ–­é—®é¢˜ï¼š

```javascript
// components/audio-float/audio-float.js
Component({
  data: {
    visible: false,
    title: "æ­£åœ¨æ’­æ”¾",
    playing: false,
    left: 0,
    top: 0,
    startX: 0,
    startY: 0,
    isDragging: false,
    windowWidth: 375,
    windowHeight: 667,
  },

  lifetimes: {
    attached() {
      console.log("[AudioFloat] ========== ç»„ä»¶åŠ è½½ ==========");
      console.log("[AudioFloat] å½“å‰é¡µé¢:", getCurrentPages().pop().route);
      
      this.audioManager = wx.getBackgroundAudioManager();
      this.getSystemInfo();
      this.initAudioManager();
      this.checkInitialState();
    },

    detached() {
      console.log("[AudioFloat] ========== ç»„ä»¶å¸è½½ ==========");
      if (this.audioManager) {
        this.audioManager.onPlay(() => {});
        this.audioManager.onPause(() => {});
        this.audioManager.onStop(() => {});
        this.audioManager.onEnded(() => {});
        this.audioManager.onError(() => {});
      }
    },
  },

  methods: {
    getSystemInfo() {
      const systemInfo = wx.getSystemInfoSync();
      const windowWidth = systemInfo.windowWidth;
      const windowHeight = systemInfo.windowHeight;

      const left = windowWidth - 150;
      const top = windowHeight - 180;

      console.log("[AudioFloat] çª—å£å°ºå¯¸:", windowWidth, "x", windowHeight);
      console.log("[AudioFloat] åˆå§‹ä½ç½®: left =", left, ", top =", top);

      this.setData({
        windowWidth,
        windowHeight,
        left,
        top,
      });
    },

    initAudioManager() {
      const manager = this.audioManager;

      manager.onPlay(() => {
        console.log("[AudioFloat] ========== æ’­æ”¾äº‹ä»¶è§¦å‘ ==========");
        console.log("[AudioFloat] æ ‡é¢˜:", manager.title);
        console.log("[AudioFloat] å½“å‰é¡µé¢:", getCurrentPages().pop().route);
        
        this.setData({
          visible: true,
          playing: true,
          title: manager.title || "æ­£åœ¨æ’­æ”¾",
        });
        
        console.log("[AudioFloat] æŒ‰é’®çŠ¶æ€: visible =", this.data.visible);
        console.log("[AudioFloat] æŒ‰é’®ä½ç½®: left =", this.data.left, ", top =", this.data.top);
      });

      manager.onPause(() => {
        console.log("[AudioFloat] éŸ³é¢‘æš‚åœ");
        this.setData({
          playing: false,
        });
      });

      manager.onStop(() => {
        console.log("[AudioFloat] éŸ³é¢‘åœæ­¢");
        this.setData({
          visible: false,
          playing: false,
        });
      });

      manager.onEnded(() => {
        console.log("[AudioFloat] éŸ³é¢‘æ’­æ”¾ç»“æŸ");
        this.setData({
          visible: false,
          playing: false,
        });
      });

      manager.onError((err) => {
        console.error("[AudioFloat] éŸ³é¢‘æ’­æ”¾é”™è¯¯", err);
        this.setData({
          visible: false,
          playing: false,
        });
      });
    },

    checkInitialState() {
      const manager = this.audioManager;

      console.log("[AudioFloat] ========== æ£€æŸ¥åˆå§‹çŠ¶æ€ ==========");
      console.log("[AudioFloat] src:", manager.src);
      console.log("[AudioFloat] paused:", manager.paused);
      console.log("[AudioFloat] title:", manager.title);

      if (manager.src && !manager.paused) {
        console.log("[AudioFloat] âœ… æ£€æµ‹åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘");
        this.setData({
          visible: true,
          playing: true,
          title: manager.title || "æ­£åœ¨æ’­æ”¾",
        });
      } else {
        console.log("[AudioFloat] âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘");
      }
    },

    // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
  },
});
```

---

## ğŸ“Š é¢„æœŸçš„æ§åˆ¶å°è¾“å‡º

### **æ­£å¸¸æƒ…å†µï¼ˆæŒ‰é’®æ˜¾ç¤ºï¼‰**
```
[AudioFloat] ========== ç»„ä»¶åŠ è½½ ==========
[AudioFloat] å½“å‰é¡µé¢: pages/home/home
[AudioFloat] çª—å£å°ºå¯¸: 375 x 667
[AudioFloat] åˆå§‹ä½ç½®: left = 225 , top = 487
[AudioFloat] ========== æ£€æŸ¥åˆå§‹çŠ¶æ€ ==========
[AudioFloat] src: cloud://xxx.mp3
[AudioFloat] paused: false
[AudioFloat] title: é¡¶è½®ä¹‹å…‰
[AudioFloat] âœ… æ£€æµ‹åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
```

### **å¼‚å¸¸æƒ…å†µï¼ˆæŒ‰é’®ä¸æ˜¾ç¤ºï¼‰**
```
[AudioFloat] ========== ç»„ä»¶åŠ è½½ ==========
[AudioFloat] å½“å‰é¡µé¢: pages/home/home
[AudioFloat] çª—å£å°ºå¯¸: 375 x 667
[AudioFloat] åˆå§‹ä½ç½®: left = 225 , top = 487
[AudioFloat] ========== æ£€æŸ¥åˆå§‹çŠ¶æ€ ==========
[AudioFloat] src: undefined
[AudioFloat] paused: true
[AudioFloat] title: undefined
[AudioFloat] âŒ æ²¡æœ‰æ£€æµ‹åˆ°æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
```

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æ·»åŠ è°ƒè¯•æ—¥å¿—**ï¼šä½¿ç”¨ä¸Šé¢çš„è°ƒè¯•ä»£ç æ›¿æ¢ç°æœ‰ä»£ç 
2. **é‡æ–°ç¼–è¯‘**ï¼šä¿å­˜å¹¶é‡æ–°ç¼–è¯‘å°ç¨‹åº
3. **æµ‹è¯•æ’­æ”¾**ï¼šæ’­æ”¾éŸ³é¢‘å¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
4. **æˆªå›¾åé¦ˆ**ï¼šå°†æ§åˆ¶å°è¾“å‡ºæˆªå›¾å‘ç»™æˆ‘
5. **æ ¹æ®æ—¥å¿—å®šä½é—®é¢˜**ï¼šæˆ‘ä¼šæ ¹æ®æ—¥å¿—å¸®ä½ æ‰¾åˆ°å…·ä½“åŸå› 

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿ** è®©æˆ‘ä»¬ä¸€èµ·æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼ğŸ’ª

