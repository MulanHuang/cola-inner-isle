# ğŸš€ æ¥å£è¿ç§» - å…³é”®ä»£ç é€ŸæŸ¥è¡¨

## ğŸ“¦ 1. utils/request.jsï¼ˆç»Ÿä¸€è¯·æ±‚å·¥å…·ï¼‰

```javascript
// utils/request.js
const API_BASE_URL = "https://api.cola.center";

function postChatMessage(message, extraData = {}) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${API_BASE_URL}/chat`,
      method: "POST",
      header: {
        "Content-Type": "application/json",
      },
      data: {
        message,
        ...extraData,
      },
      success(res) {
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res);
        } else {
          reject(new Error(`Bad status code: ${res.statusCode}`));
        }
      },
      fail(err) {
        reject(err);
      },
    });
  });
}

module.exports = {
  postChatMessage,
};
```

---

## ğŸ“ 2. MBTI ç»“æœé¡µé¢ï¼ˆpages/mbti-result/mbti-result.jsï¼‰

### å¼•å…¥ä¾èµ–
```javascript
const { getMbtiTypeInfo } = require("../../utils/mbti.js");
const { postChatMessage } = require("../../utils/request.js");
```

### è°ƒç”¨ AI è§£è¯»
```javascript
callBackendAPI(type, scores) {
  console.log("ğŸ“¤ å‘é€æ•°æ®åˆ°åç«¯ API:", { type, scores });

  // æ„é€  AI æç¤ºè¯
  const scoresText = Object.entries(scores)
    .map(([key, value]) => `${key}: ${value}`)
    .join(", ");
  
  const message = `è¯·ä¸º MBTI ç±»å‹ ${type} ç”Ÿæˆä¸€ä»½æ·±åº¦è§£è¯»ã€‚ç”¨æˆ·çš„å„ç»´åº¦å¾—åˆ†ä¸ºï¼š${scoresText}ã€‚è¯·ç”¨æ¸©æŸ”ã€é¼“åŠ±çš„è¯­æ°”ï¼Œä»æ€§æ ¼ç‰¹è´¨ã€ä¼˜åŠ¿ã€æˆé•¿æ–¹å‘ç­‰è§’åº¦è¿›è¡Œè¯¦ç»†åˆ†æï¼Œå­—æ•°åœ¨ 300-500 å­—å·¦å³ã€‚`;

  postChatMessage(message, {
    type: "mbti_analysis",
    mbtiType: type,
    scores: scores,
  })
    .then((res) => {
      console.log("ğŸ“¥ AI åŸå§‹è¿”å›ï¼š", res);
      console.log("ğŸ“¦ AI è¿”å›æ•°æ®ï¼š", res.data);

      wx.hideLoading();

      if (res.data && res.data.reply) {
        console.log("âœ… AI è§£è¯»æˆåŠŸï¼Œæ˜¾ç¤ºå†…å®¹");
        console.log("ğŸ“ AI è¿”å›ç»“æœï¼š", res.data.reply);

        wx.showToast({
          title: "è§£è¯»ç”ŸæˆæˆåŠŸ",
          icon: "success",
          duration: 1500,
        });

        this.setData({
          analysis: res.data.reply,
          showAnalysis: true,
        });
      } else {
        console.error("âŒ AI è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸:", res.data);
        wx.showToast({
          title: "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨",
          icon: "none",
          duration: 2000,
        });
        this.showDefaultAnalysis();
      }
    })
    .catch((err) => {
      wx.hideLoading();
      console.error("âŒ AI è¯·æ±‚å¤±è´¥:", err);

      wx.showToast({
        title: "AI æœåŠ¡å™¨é”™è¯¯",
        icon: "none",
        duration: 2000,
      });

      this.showDefaultAnalysis();
    });
}
```

---

## ğŸŒ€ 3. è„‰è½®ç»“æœé¡µé¢ï¼ˆpages/chakraResult/index.jsï¼‰

### å¼•å…¥ä¾èµ–
```javascript
const {
  CHAKRA_INFO,
  getChakraInterpretation,
} = require("../chakraTest/data/chakraInfo.js");
const { postChatMessage } = require("../../utils/request.js");
```

### è°ƒç”¨ AI åˆ†æ
```javascript
// æ„é€  AI æç¤ºè¯
const chakraNames = {
  root: "æµ·åº•è½®",
  sacral: "è„è½®",
  solarPlexus: "å¤ªé˜³ç¥ç»ä¸›è½®",
  heart: "å¿ƒè½®",
  throat: "å–‰è½®",
  thirdEye: "çœ‰å¿ƒè½®",
  crown: "é¡¶è½®",
};

const scoresText = Object.entries(chakraScores)
  .map(([key, value]) => `${chakraNames[key] || key}: ${value}åˆ†`)
  .join(", ");

const message = `è¯·ä¸ºç”¨æˆ·çš„è„‰è½®æµ‹è¯•ç»“æœç”Ÿæˆä¸€ä»½æ¸©æŸ”ã€é¼“åŠ±çš„åˆ†ææŠ¥å‘Šã€‚

ç”¨æˆ·çš„è„‰è½®å¾—åˆ†ï¼š${scoresText}
æ•´ä½“å¹³è¡¡ç­‰çº§ï¼š${level}

è¯·ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œåˆ†æï¼š
1. æ•´ä½“èƒ½é‡çŠ¶æ€æ€»ç»“
2. å„ä¸ªè„‰è½®çš„å…·ä½“æƒ…å†µå’Œå¯èƒ½çš„æ„Ÿå—
3. ä¼˜åŠ¿ä¸æˆé•¿æ–¹å‘
4. ç®€å•æ˜“è¡Œçš„æ—¥å¸¸ç»ƒä¹ å»ºè®®

è¯­æ°”è¦æ¸©æŸ”ã€éè¯„åˆ¤ã€é¼“åŠ±æ€§ï¼Œé¿å…åŒ»å­¦è¯Šæ–­è¯æ±‡ï¼Œå­—æ•°åœ¨ 400-600 å­—å·¦å³ã€‚`;

// è°ƒç”¨åç«¯ API
const res = await postChatMessage(message, {
  type: "chakra_analysis",
  chakraScores,
  level,
  strongChakras,
  weakChakras,
});

console.log("ğŸ“¥ AI åŸå§‹è¿”å›ï¼š", res);
console.log("ğŸ“¦ AI è¿”å›æ•°æ®ï¼š", res.data);

if (res.data && res.data.reply) {
  console.log("âœ… AI åˆ†ææˆåŠŸ");
  console.log("ğŸ“ AI è¿”å›ç»“æœï¼š", res.data.reply);

  this.setData({
    aiAnalysis: {
      overall_summary: res.data.reply,
    },
    isAnalyzing: false,
    analysisError: false,
  });
}
```

---

## ğŸ¯ 4. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼

```javascript
.catch((err) => {
  console.error("âŒ AI è¯·æ±‚å¤±è´¥:", err);
  
  wx.showToast({
    title: "AI æœåŠ¡å™¨é”™è¯¯",
    icon: "none",
  });
  
  // æ˜¾ç¤ºå…œåº•å†…å®¹
  this.showDefaultAnalysis();
});
```

---

## ğŸ“Š 5. ç»Ÿä¸€çš„æ—¥å¿—è¾“å‡º

```javascript
console.log("ğŸ“¥ AI åŸå§‹è¿”å›ï¼š", res);
console.log("ğŸ“¦ AI è¿”å›æ•°æ®ï¼š", res.data);
console.log("ğŸ“ AI è¿”å›ç»“æœï¼š", res.data.reply);
```

---

## âœ… 6. åç«¯ API æ•°æ®æ ¼å¼

### è¯·æ±‚æ ¼å¼
```javascript
{
  message: "AI æç¤ºè¯",
  type: "mbti_analysis" | "chakra_analysis",
  // å…¶ä»–ä¸šåŠ¡æ•°æ®
  mbtiType: "INFJ",
  scores: { E: 5, I: 13, ... },
  chakraScores: { root: 38, ... },
  ...
}
```

### å“åº”æ ¼å¼
```javascript
{
  data: {
    reply: "AI ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹"
  }
}
```

---

## ğŸ” 7. éªŒè¯å‘½ä»¤

```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰äº‘å‡½æ•°è°ƒç”¨
grep -r "wx\.cloud\.callFunction\|cloud\.callFunction" --include="*.js" --exclude-dir=cloudfunctions pages/ utils/

# åº”è¯¥è¾“å‡ºï¼šâœ… æœªæ‰¾åˆ°äº‘å‡½æ•°è°ƒç”¨
```

---

## ğŸ“ 8. æ³¨æ„äº‹é¡¹

1. **ä¿ç•™çš„äº‘å¼€å‘åŠŸèƒ½**ï¼š
   - `wx.cloud.database()` - æ•°æ®åº“æ“ä½œ
   - `wx.cloud.init()` - äº‘å¼€å‘åˆå§‹åŒ–
   - è¿™äº›ä¸æ˜¯äº‘å‡½æ•°ï¼Œæ˜¯æ­£å¸¸çš„æ•°æ®åº“ API

2. **ç»Ÿä¸€ä½¿ç”¨ Promise**ï¼š
   - æ‰€æœ‰ AI è¯·æ±‚éƒ½ä½¿ç”¨ `.then().catch()` æ¨¡å¼
   - é¿å…æ—§çš„ `success/fail` å›è°ƒæ–¹å¼

3. **ç»Ÿä¸€çš„è¿”å›å­—æ®µ**ï¼š
   - æ‰€æœ‰ AI è¿”å›éƒ½ä½¿ç”¨ `res.data.reply`
   - ä¸å†æœ‰ `success: undefined` çš„é—®é¢˜

---

**æœ€åæ›´æ–°**: 2025-11-23

