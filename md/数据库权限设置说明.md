# æ•°æ®åº“æƒé™è®¾ç½®è¯´æ˜ ğŸ”

## ğŸ”´ å½“å‰é—®é¢˜

çœŸæœºè°ƒè¯•æ—¶å‡ºç°é”™è¯¯ï¼š
```
errCode: -501003
errMsg: "Permission denied è¯·å‰å¾€å¼€å‘è€…å·¥å…·äº‘å¼€å‘æ§åˆ¶å°è®¾ç½®æƒé™"
```

**åŸå› **ï¼šæ•°æ®åº“ `meditations` é›†åˆçš„æƒé™è®¾ç½®ä¸æ­£ç¡®ï¼ŒçœŸæœºæ— æ³•è¯»å–æ•°æ®ã€‚

---

## âœ… è§£å†³æ–¹æ³•

### æ–¹æ³• 1ï¼šè®¾ç½®æ•°æ®åº“æƒé™ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

#### æ­¥éª¤ 1ï¼šæ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
1. å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. é¡¶éƒ¨èœå• â†’ **"äº‘å¼€å‘"**
3. å·¦ä¾§èœå• â†’ **"æ•°æ®åº“"**

#### æ­¥éª¤ 2ï¼šæ‰¾åˆ° meditations é›†åˆ
1. åœ¨æ•°æ®åº“åˆ—è¡¨ä¸­æ‰¾åˆ° **`meditations`** é›†åˆ
2. ç‚¹å‡»è¿›å…¥

#### æ­¥éª¤ 3ï¼šè®¾ç½®æƒé™
1. ç‚¹å‡»å³ä¸Šè§’ **"æƒé™è®¾ç½®"** æŒ‰é’®
2. é€‰æ‹© **"è‡ªå®šä¹‰å®‰å…¨è§„åˆ™"**
3. è¾“å…¥ä»¥ä¸‹è§„åˆ™ï¼š

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**è¯´æ˜**ï¼š
- `"read": true` - æ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼ˆåŒ…æ‹¬æœªç™»å½•ç”¨æˆ·ï¼‰
- `"write": "doc._openid == auth.openid"` - åªæœ‰åˆ›å»ºè€…å¯å†™

#### æ­¥éª¤ 4ï¼šä¿å­˜å¹¶æµ‹è¯•
1. ç‚¹å‡» **"ä¿å­˜"**
2. é‡æ–°è¿›è¡ŒçœŸæœºè°ƒè¯•
3. æŸ¥çœ‹æ˜¯å¦èƒ½æ­£å¸¸æ’­æ”¾éŸ³é¢‘

---

### æ–¹æ³• 2ï¼šä½¿ç”¨é¢„è®¾æƒé™æ¨¡æ¿

å¦‚æœä½ çš„å°ç¨‹åºéœ€è¦ç”¨æˆ·ç™»å½•ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æƒé™ï¼š

```json
{
  "read": "auth.openid != null",
  "write": "doc._openid == auth.openid"
}
```

**è¯´æ˜**ï¼š
- `"read": "auth.openid != null"` - åªæœ‰ç™»å½•ç”¨æˆ·å¯è¯»
- `"write": "doc._openid == auth.openid"` - åªæœ‰åˆ›å»ºè€…å¯å†™

---

### æ–¹æ³• 3ï¼šä½¿ç”¨äº‘å‡½æ•°ï¼ˆæ›´å®‰å…¨ï¼Œä½†æ›´å¤æ‚ï¼‰

å¦‚æœä½ ä¸æƒ³å¼€æ”¾æ•°æ®åº“æƒé™ï¼Œå¯ä»¥åˆ›å»ºäº‘å‡½æ•°æ¥è¯»å–æ•°æ®ã€‚

#### æ­¥éª¤ 1ï¼šåˆ›å»ºäº‘å‡½æ•°

åœ¨ `cloudfunctions` ç›®å½•ä¸‹åˆ›å»º `getMeditation` äº‘å‡½æ•°ï¼š

```javascript
// cloudfunctions/getMeditation/index.js
const cloud = require('wx-server-sdk');
cloud.init();
const db = cloud.database();

exports.main = async (event, context) => {
  const { audioId } = event;
  
  try {
    const res = await db
      .collection('meditations')
      .doc(audioId)
      .get();
    
    return {
      success: true,
      data: res.data,
    };
  } catch (err) {
    return {
      success: false,
      error: err,
    };
  }
};
```

#### æ­¥éª¤ 2ï¼šä¿®æ”¹ player.js

```javascript
// ä¿®æ”¹ loadAudioInfo å‡½æ•°
async loadAudioInfo() {
  console.log("[player] ========== åŠ è½½éŸ³é¢‘ä¿¡æ¯ ==========");
  console.log("[player] audioId:", this.data.audioId);
  
  try {
    // ä½¿ç”¨äº‘å‡½æ•°è¯»å–æ•°æ®
    const res = await wx.cloud.callFunction({
      name: 'getMeditation',
      data: {
        audioId: this.data.audioId,
      },
    });

    console.log("[player] äº‘å‡½æ•°è¿”å›ç»“æœ:", res);

    if (res.result.success && res.result.data) {
      const audioData = res.result.data;
      const fileId = audioData.audioUrl || audioData.audioURL;

      console.log("[player] éŸ³é¢‘æ•°æ®:");
      console.log("[player] - title:", audioData.title);
      console.log("[player] - æœ€ç»ˆä½¿ç”¨çš„ fileId:", fileId);

      if (!fileId) {
        console.error("[player] âŒ æ•°æ®åº“ä¸­æ²¡æœ‰ audioUrl æˆ– audioURL å­—æ®µ");
        wx.showModal({
          title: "æ’­æ”¾å¤±è´¥",
          content: "éŸ³é¢‘æ–‡ä»¶åœ°å€ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“é…ç½®",
          showCancel: false,
        });
        return;
      }

      this.setData({
        audio: audioData,
      });

      await this.prepareAndPlay(fileId);
      this.recordPlayHistory();
    } else {
      console.error("[player] âŒ äº‘å‡½æ•°è¿”å›å¤±è´¥");
      wx.showToast({
        title: "åŠ è½½å¤±è´¥",
        icon: "none",
      });
    }
  } catch (err) {
    console.error("[player] âŒ è°ƒç”¨äº‘å‡½æ•°å¤±è´¥", err);
    wx.showModal({
      title: "åŠ è½½å¤±è´¥",
      content: `äº‘å‡½æ•°è°ƒç”¨å¤±è´¥: ${err.message || "æœªçŸ¥é”™è¯¯"}`,
      showCancel: false,
    });
  }
}
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ³• 1**ï¼ˆè®¾ç½®æ•°æ®åº“æƒé™ï¼‰ï¼Œå› ä¸ºï¼š
- âœ… æœ€ç®€å•ï¼Œåªéœ€è¦åœ¨æ§åˆ¶å°ç‚¹å‡ ä¸‹
- âœ… ä¸éœ€è¦ä¿®æ”¹ä»£ç 
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆç›´æ¥è¯»å–æ•°æ®åº“ï¼Œä¸éœ€è¦ç»è¿‡äº‘å‡½æ•°ï¼‰

å¦‚æœä½ çš„å°ç¨‹åºå¯¹å®‰å…¨æ€§è¦æ±‚å¾ˆé«˜ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ³• 3ï¼ˆäº‘å‡½æ•°ï¼‰ã€‚

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

è®¾ç½®å®Œæƒé™åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ•°æ®åº“ `meditations` é›†åˆçš„æƒé™å·²è®¾ç½®ä¸º "æ‰€æœ‰ç”¨æˆ·å¯è¯»"
- [ ] ç‚¹å‡» "ä¿å­˜" æŒ‰é’®
- [ ] é‡æ–°è¿›è¡ŒçœŸæœºè°ƒè¯•ï¼ˆä¸æ˜¯é¢„è§ˆï¼‰
- [ ] æŸ¥çœ‹ vConsole æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰ `-501003` é”™è¯¯

---

## ğŸ‰ é¢„æœŸç»“æœ

è®¾ç½®æƒé™åï¼ŒçœŸæœºè°ƒè¯•æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š

```
[player] ========== åŠ è½½éŸ³é¢‘ä¿¡æ¯ ==========
[player] æ•°æ®åº“æŸ¥è¯¢ç»“æœ: { data: {...} }
[player] éŸ³é¢‘æ•°æ®:
[player] - title: é¡¶è½®ä¹‹å…‰
[player] âœ… æˆåŠŸè·å–ä¸´æ—¶é“¾æ¥: https://xxx
[player] âœ… éŸ³é¢‘å¼€å§‹æ’­æ”¾
```

---

**æœ€åæ›´æ–°**: 2025-11-23

