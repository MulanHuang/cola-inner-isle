# 📸 数据库权限配置 - 图文教程

## 🎯 目标

解决保存失败的问题，让用户能够正常保存塔罗记录、情绪记录等数据。

---

## 📋 准备工作

### 需要配置的集合

#### 用户数据集合（仅创建者可读写）
- `tarotDraws` - 塔罗抽牌记录 ⭐⭐⭐
- `tarotDraw` - 塔罗抽牌记录（备用）
- `emotions` - 情绪记录
- `chats` - 对话记录
- `meditationHistory` - 冥想历史
- `users` - 用户信息
- `chakra_history` - 脉轮测试历史

#### 公共数据集合（所有用户可读）
- `tarotCards` - 塔罗牌数据 ⭐⭐⭐
- `quotes` - 每日一句
- `meditations` - 冥想音频

---

## 🚀 配置步骤

### 第一步：打开云开发控制台

```
微信开发者工具 → 顶部菜单栏 → 云开发 → 云开发控制台
```

**位置说明**：
- 在微信开发者工具的顶部菜单栏
- 找到 "云开发" 按钮
- 点击后选择 "云开发控制台"

---

### 第二步：进入数据库管理

```
云开发控制台 → 左侧菜单 → 数据库
```

**你会看到**：
- 左侧：数据库集合列表
- 右侧：集合内容和操作按钮

---

### 第三步：配置用户数据集合权限

#### 以 `tarotDraws` 为例：

**1. 找到集合**
```
在集合列表中找到 "tarotDraws"
点击集合名称
```

**2. 打开权限设置**
```
点击右上角的 "权限设置" 按钮
```

**3. 选择权限模式**
```
选择：仅创建者可读写
```

**4. 确认权限规则**
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**含义**：
- ✅ 用户只能读取自己创建的记录
- ✅ 用户只能修改自己创建的记录
- ❌ 用户无法看到其他用户的记录

**5. 保存**
```
点击 "确定" 按钮
```

---

### 第四步：配置公共数据集合权限

#### 以 `tarotCards` 为例：

**1. 找到集合**
```
在集合列表中找到 "tarotCards"
点击集合名称
```

**2. 打开权限设置**
```
点击右上角的 "权限设置" 按钮
```

**3. 选择权限模式**
```
方式一：选择 "所有用户可读，仅创建者可写"
方式二：自定义规则（推荐）
```

**4. 自定义权限规则**
```json
{
  "read": true,
  "write": false
}
```

**含义**：
- ✅ 所有用户都可以读取塔罗牌数据
- ❌ 普通用户无法修改塔罗牌数据
- ℹ️ 只有管理员可以通过控制台修改

**5. 保存**
```
点击 "确定" 按钮
```

---

## 📝 配置清单

### 用户数据集合（7个）

#### ✅ tarotDraws
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

#### ✅ tarotDraw
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

#### ✅ emotions
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

#### ✅ chats
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

#### ✅ meditationHistory
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

#### ✅ users
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

#### ✅ chakra_history
```
权限：仅创建者可读写
规则：doc._openid == auth.openid
```

---

### 公共数据集合（3个）

#### 📖 tarotCards
```
权限：所有用户可读
规则：{ "read": true, "write": false }
```

#### 📖 quotes
```
权限：所有用户可读
规则：{ "read": true, "write": false }
```

#### 📖 meditations
```
权限：所有用户可读
规则：{ "read": true, "write": false }
```

---

## 🧪 测试验证

### 测试 1：塔罗抽牌
```
1. 编译小程序
2. 进入塔罗牌页面
3. 输入问题并抽取
4. 预期：显示 "抽取成功"
```

### 测试 2：保存行动计划
```
1. 抽取塔罗牌后
2. 输入行动计划
3. 点击保存
4. 预期：显示 "已保存"
```

### 测试 3：查看历史
```
1. 点击 "查看历史"
2. 预期：能看到之前的记录
3. 下拉刷新正常工作
```

---

## ⚠️ 注意事项

### 1. 集合不存在
如果某个集合不存在，需要先创建：
```
数据库 → 添加集合 → 输入集合名称 → 确定
```

### 2. 权限不生效
配置后需要：
```
1. 清除缓存（工具 → 清除缓存 → 清除全部）
2. 重新编译（点击编译按钮）
3. 重启开发者工具（如果还不行）
```

### 3. 查看错误信息
```
打开控制台标签 → 查看红色错误信息
错误信息会显示具体是哪个集合的权限问题
```

---

## 🎉 完成

配置完成后，所有保存功能都应该正常工作了！

**下一步**：
- 测试所有功能
- 查看是否还有其他错误
- 如有问题，查看控制台错误信息

