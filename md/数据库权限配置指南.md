# 🔐 数据库权限配置指南

## ❌ 当前问题

保存塔罗记录时出现错误：
```
Error: errCode: -502003 database permission denied
Permission denied 请前往开发 AI 小助手查看问题
```

这是因为数据库集合的权限设置不正确，导致用户无法写入数据。

---

## ✅ 解决方案：配置数据库权限

### 📍 第一步：打开云开发控制台

1. 打开微信开发者工具
2. 点击顶部菜单：**云开发** → **云开发控制台**
3. 在左侧菜单选择：**数据库**

---

### 📍 第二步：配置 tarotDraws 集合权限

#### 1. 找到 `tarotDraws` 集合
- 在数据库集合列表中找到 `tarotDraws`
- 点击集合名称进入

#### 2. 设置权限
- 点击右上角的 **权限设置** 按钮
- 选择权限模式：**仅创建者可读写**

```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

**说明**：
- ✅ 用户只能读写自己创建的记录
- ✅ 自动使用 `_openid` 字段识别用户
- ✅ 最安全的权限配置

#### 3. 保存设置
- 点击 **确定** 保存权限配置

---

### 📍 第三步：配置其他集合权限

按照相同方式配置以下集合的权限：

#### 1. **tarotDraw**（备用集合）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 2. **emotions**（情绪记录）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 3. **chats**（对话记录）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 4. **meditationHistory**（冥想历史）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 5. **users**（用户信息）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 6. **chakra_history**（脉轮测试历史）
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

---

### 📍 第四步：配置公共数据集合权限

以下集合是公共数据，所有用户可读，但不能写：

#### 1. **tarotCards**（塔罗牌数据）
```json
{
  "read": true,
  "write": false
}
```

#### 2. **quotes**（每日一句）
```json
{
  "read": true,
  "write": false
}
```

#### 3. **meditations**（冥想音频）
```json
{
  "read": true,
  "write": false
}
```

---

## 🧪 测试权限配置

### 1. 测试塔罗抽牌
1. 在小程序中进入 **塔罗牌** 页面
2. 输入问题并抽取塔罗牌
3. 查看是否能成功保存记录
4. 点击 **查看历史** 查看是否能读取记录

### 2. 测试行动计划保存
1. 抽取塔罗牌后
2. 输入行动计划
3. 点击保存
4. 应该显示 **"已保存"** 提示

### 3. 测试历史记录
1. 进入 **塔罗历史** 页面
2. 应该能看到之前的抽牌记录
3. 下拉刷新应该正常工作

---

## 🔍 常见问题

### Q1: 如果集合不存在怎么办？
**A**: 需要先创建集合：
1. 在云开发控制台 → 数据库
2. 点击 **添加集合**
3. 输入集合名称（如 `tarotDraws`）
4. 创建后再配置权限

### Q2: 权限配置后还是报错？
**A**: 尝试以下步骤：
1. 重新编译小程序（点击 **编译**）
2. 清除缓存：**工具** → **清除缓存** → **清除全部**
3. 重新预览或真机调试

### Q3: 如何查看详细错误信息？
**A**: 
1. 打开微信开发者工具的 **控制台**
2. 查看红色错误信息
3. 错误信息会显示具体是哪个集合的权限问题

---

## 📋 权限配置检查清单

配置完成后，请检查以下项目：

- [ ] `tarotDraws` - 仅创建者可读写
- [ ] `tarotDraw` - 仅创建者可读写
- [ ] `emotions` - 仅创建者可读写
- [ ] `chats` - 仅创建者可读写
- [ ] `meditationHistory` - 仅创建者可读写
- [ ] `users` - 仅创建者可读写
- [ ] `chakra_history` - 仅创建者可读写
- [ ] `tarotCards` - 所有用户可读
- [ ] `quotes` - 所有用户可读
- [ ] `meditations` - 所有用户可读

---

## 🎉 完成

配置完成后，所有保存功能应该都能正常工作了！

如果还有问题，请查看控制台的详细错误信息。

