# 真机音频播放调试指南 🔧

## 🎯 问题描述
- **开发者工具**：音频可以正常播放 ✅
- **真机预览/调试**：点击播放按钮后，没有声音 ❌

## 🔍 已修复的问题

### 1. ✅ 云开发环境 ID 配置
**问题**：使用 `DYNAMIC_CURRENT_ENV` 在真机上可能不稳定

**修复**：在 `app.js` 中使用具体的环境 ID
```javascript
const cloudEnvId = "cloud1-5gc5jltwbcbef586"; // ← 请替换为你的实际环境 ID
wx.cloud.init({
  env: cloudEnvId,
  traceUser: true,
});
```

**如何获取你的环境 ID**：
1. 打开微信开发者工具
2. 点击顶部菜单 "云开发"
3. 进入 "设置" → "环境设置"
4. 复制 "环境 ID"

### 2. ✅ BackgroundAudioManager 必须设置 title
**问题**：iOS 真机如果不设置 `title`，可能无法播放

**修复**：在设置 `src` 之前，必须先设置 `title`
```javascript
audioManager.title = "冥想音频"; // ← 必须设置
audioManager.epname = "可乐心岛冥想";
audioManager.singer = "可乐心岛";
audioManager.coverImgUrl = coverUrl;
audioManager.src = tempUrl; // ← 最后设置
```

### 3. ✅ 增加详细的真机调试日志
**修复**：在所有关键步骤添加 `console.log`，方便真机调试时查看

## 📱 真机调试步骤

### 步骤 1：开启真机调试
1. 在微信开发者工具中，点击 "预览" → "真机调试"
2. 用手机微信扫码
3. 在手机上打开 vConsole（右下角悬浮按钮）

### 步骤 2：查看日志
在 vConsole 中查看以下关键日志：

#### ✅ 云开发初始化成功
```
[App] ========== 小程序启动 ==========
[App] 云开发初始化成功，环境 ID: cloud1-5gc5jltwbcbef586
```

#### ✅ 加载音频信息成功
```
[player] ========== 加载音频信息 ==========
[player] audioId: xxx
[player] 音频数据:
[player] - title: 顶轮之光
[player] - 最终使用的 fileId: cloud://xxx/audio/xxx.mp3
```

#### ✅ 获取临时链接成功
```
[player] ========== 开始准备播放 ==========
[player] 📡 正在调用 wx.cloud.getTempFileURL...
[player] ✅ 成功获取临时链接: https://xxx.tcb.qcloud.la/xxx
```

#### ✅ 音频管理器配置成功
```
[player] 🎵 开始设置音频管理器属性...
[player] - title: 顶轮之光
[player] - src: https://xxx.tcb.qcloud.la/xxx
[player] ✅ 音频管理器配置完成，等待播放...
```

#### ✅ 音频开始播放
```
[player] ✅ 音频开始播放
[player] 当前 src: https://xxx.tcb.qcloud.la/xxx
[player] 当前 title: 顶轮之光
```

### 步骤 3：排查错误

#### ❌ 如果看到 "获取临时链接失败"
```
[player] ❌ 获取临时链接失败
[player] - 错误码: -1
[player] - 错误信息: xxx
```

**可能原因**：
1. 云存储文件不存在
2. 云存储权限设置不正确
3. 环境 ID 配置错误

**解决方法**：
1. 检查云存储中是否有该文件
2. 设置云存储权限为 "所有用户可读"
3. 确认 `app.js` 中的环境 ID 是否正确

#### ❌ 如果看到 "音频播放错误"
```
[player] ❌ 音频播放错误
[player] 错误码: 10001
[player] 错误信息: xxx
```

**常见错误码**：
- `10001`：系统错误
- `10002`：网络错误
- `10003`：文件错误
- `10004`：格式错误

**解决方法**：
1. 检查音频文件格式（建议使用 MP3）
2. 检查网络连接
3. 检查临时链接是否有效

## 🔧 常见问题排查

### Q1: 数据库中 audioUrl 字段是什么格式？
**A**: 应该是云存储的 fileID，格式如下：
```
cloud://环境ID/路径/文件名.mp3
```

示例：
```
cloud://cloud1-5gc5jltwbcbef586.636c-cloud1-5gc5jltwbcbef586-1330238286/audio/顶轮之光.mp3
```

### Q2: 如何检查云存储权限？
**A**: 
1. 打开微信开发者工具
2. 点击 "云开发" → "存储"
3. 点击右上角 "权限设置"
4. 设置为 "所有用户可读，仅创建者可写"

### Q3: 真机上看不到日志怎么办？
**A**: 
1. 确保使用 "真机调试" 而不是 "预览"
2. 在手机上打开 vConsole（右下角悬浮按钮）
3. 切换到 "Log" 标签页

### Q4: iOS 和 Android 表现不一致？
**A**: 
- iOS 对 BackgroundAudioManager 的要求更严格
- 必须设置 `title`、`epname`、`singer` 等字段
- 建议在两个平台上都测试

## 📝 检查清单

在真机调试前，请确认：

- [ ] `app.js` 中的环境 ID 已替换为实际的环境 ID
- [ ] 数据库 `meditations` 集合中的 `audioUrl` 字段格式正确
- [ ] 云存储中的音频文件已上传
- [ ] 云存储权限设置为 "所有用户可读"
- [ ] 使用 "真机调试" 而不是 "预览"
- [ ] 手机上已打开 vConsole

## 🎉 预期结果

修复后，真机上应该能够：
1. ✅ 点击播放按钮后，音频正常播放
2. ✅ 可以看到播放进度条
3. ✅ 可以暂停、快进、快退
4. ✅ 可以调整播放速度
5. ✅ 可以循环播放
6. ✅ 锁屏后仍然可以播放（后台播放）

---

**最后更新**: 2025-11-23

