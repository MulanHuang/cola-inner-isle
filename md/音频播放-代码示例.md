# éŸ³é¢‘æ’­æ”¾ä»£ç ç¤ºä¾‹ ğŸ“

## ğŸ“‹ ç›®å½•ç»“æ„

```
pages/
  meditation/
    meditation.js          # å†¥æƒ³åˆ—è¡¨é¡µï¼ˆç‚¹å‡»è·³è½¬åˆ°æ’­æ”¾å™¨ï¼‰
    meditation.wxml
    player/
      player.js            # æ’­æ”¾å™¨é¡µé¢ï¼ˆå®é™…æ’­æ”¾éŸ³é¢‘ï¼‰
      player.wxml
```

## ğŸµ æ–¹æ¡ˆè¯´æ˜

å½“å‰é¡¹ç›®ä½¿ç”¨çš„æ˜¯ **é¡µé¢è·³è½¬** æ–¹å¼ï¼š
1. åœ¨å†¥æƒ³åˆ—è¡¨é¡µç‚¹å‡»éŸ³é¢‘
2. è·³è½¬åˆ°æ’­æ”¾å™¨é¡µé¢
3. åœ¨æ’­æ”¾å™¨é¡µé¢æ’­æ”¾éŸ³é¢‘

è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹ï¼š
- âœ… ä»£ç ç»“æ„æ¸…æ™°
- âœ… æ’­æ”¾å™¨é¡µé¢æœ‰å®Œæ•´çš„ UI æ§åˆ¶
- âœ… æ”¯æŒåå°æ’­æ”¾ï¼ˆBackgroundAudioManagerï¼‰

## ğŸ“„ ä»£ç ç¤ºä¾‹

### 1. å†¥æƒ³åˆ—è¡¨é¡µï¼ˆmeditation.wxmlï¼‰

```xml
<!-- éŸ³é¢‘åˆ—è¡¨ -->
<view class="audio-list">
  <view 
    wx:for="{{audioList}}" 
    wx:key="_id"
    class="audio-item"
    bindtap="playAudio"
    data-audio="{{item}}">
    
    <image class="audio-cover" src="{{item.cover}}" mode="aspectFill"></image>
    
    <view class="audio-info">
      <view class="audio-title">{{item.title}}</view>
      <text class="audio-desc">{{item.description}}</text>
      <view class="audio-meta">
        <text class="audio-duration">{{item.duration}}</text>
        <text class="audio-plays">{{item.plays || 0}} æ¬¡æ’­æ”¾</text>
      </view>
    </view>
    
    <view class="audio-play-icon">â–¶</view>
  </view>
</view>
```

### 2. å†¥æƒ³åˆ—è¡¨é¡µï¼ˆmeditation.jsï¼‰

```javascript
// pages/meditation/meditation.js
const db = wx.cloud.database();

Page({
  data: {
    audioList: [],
  },

  onLoad() {
    this.loadAudioList();
  },

  // åŠ è½½éŸ³é¢‘åˆ—è¡¨
  async loadAudioList() {
    wx.showLoading({ title: "åŠ è½½ä¸­..." });

    try {
      const res = await db
        .collection("meditations")
        .where({ category: "emotion" })
        .orderBy("order", "asc")
        .get();

      this.setData({
        audioList: res.data || [],
      });

      wx.hideLoading();
    } catch (err) {
      console.error("åŠ è½½éŸ³é¢‘åˆ—è¡¨å¤±è´¥", err);
      wx.hideLoading();
      wx.showToast({
        title: "åŠ è½½å¤±è´¥",
        icon: "none",
      });
    }
  },

  // æ’­æ”¾éŸ³é¢‘ï¼ˆè·³è½¬åˆ°æ’­æ”¾å™¨é¡µé¢ï¼‰
  playAudio(e) {
    const audio = e.currentTarget.dataset.audio;
    console.log("ç‚¹å‡»æ’­æ”¾éŸ³é¢‘:", audio.title);
    
    // è·³è½¬åˆ°æ’­æ”¾å™¨é¡µé¢
    wx.navigateTo({
      url: `/pages/meditation/player/player?id=${audio._id}`,
    });
  },
});
```

### 3. æ’­æ”¾å™¨é¡µé¢ï¼ˆplayer.jsï¼‰- æ ¸å¿ƒä»£ç 

```javascript
// pages/meditation/player/player.js
const db = wx.cloud.database();
const audioManager = wx.getBackgroundAudioManager();

Page({
  data: {
    audioId: "",
    audio: {},
    playing: false,
  },

  onLoad(options) {
    if (options.id) {
      this.setData({ audioId: options.id });
      this.loadAudioInfo();
      this.initAudioManager();
    }
  },

  // åŠ è½½éŸ³é¢‘ä¿¡æ¯
  async loadAudioInfo() {
    try {
      const res = await db
        .collection("meditations")
        .doc(this.data.audioId)
        .get();

      if (res.data) {
        const audioData = res.data;
        const fileId = audioData.audioUrl || audioData.audioURL;

        this.setData({ audio: audioData });

        // å¼€å§‹æ’­æ”¾
        await this.playAudioByFileID(fileId, audioData.title, audioData.cover);
      }
    } catch (err) {
      console.error("åŠ è½½éŸ³é¢‘ä¿¡æ¯å¤±è´¥", err);
      wx.showToast({ title: "åŠ è½½å¤±è´¥", icon: "none" });
    }
  },

  // ğŸ”´ æ ¸å¿ƒå‡½æ•°ï¼šé€šè¿‡ fileID æ’­æ”¾éŸ³é¢‘
  async playAudioByFileID(fileId, title, cover) {
    console.log("[æ’­æ”¾éŸ³é¢‘] fileId:", fileId);
    console.log("[æ’­æ”¾éŸ³é¢‘] title:", title);

    if (!fileId) {
      wx.showToast({ title: "éŸ³é¢‘åœ°å€ç¼ºå¤±", icon: "none" });
      return;
    }

    wx.showLoading({ title: "åŠ è½½éŸ³é¢‘..." });

    try {
      // æ­¥éª¤1ï¼šè·å–ä¸´æ—¶é“¾æ¥
      const res = await wx.cloud.getTempFileURL({ fileList: [fileId] });
      const fileInfo = res?.fileList?.[0];

      if (!fileInfo || fileInfo.status !== 0 || !fileInfo.tempFileURL) {
        console.error("è·å–ä¸´æ—¶é“¾æ¥å¤±è´¥", fileInfo);
        wx.showToast({ title: "éŸ³é¢‘åŠ è½½å¤±è´¥", icon: "none" });
        return;
      }

      const tempUrl = fileInfo.tempFileURL;
      console.log("[æ’­æ”¾éŸ³é¢‘] ä¸´æ—¶é“¾æ¥:", tempUrl);

      // æ­¥éª¤2ï¼šè®¾ç½® BackgroundAudioManager
      // âš ï¸ é‡è¦ï¼šiOS çœŸæœºå¿…é¡»å…ˆè®¾ç½® title
      audioManager.title = title || "å†¥æƒ³éŸ³é¢‘";
      audioManager.epname = "å¯ä¹å¿ƒå²›å†¥æƒ³";
      audioManager.singer = "å¯ä¹å¿ƒå²›";
      audioManager.coverImgUrl = cover || "";
      
      // âš ï¸ é‡è¦ï¼šsrc å¿…é¡»æœ€åè®¾ç½®ï¼Œè®¾ç½®åä¼šè‡ªåŠ¨æ’­æ”¾
      audioManager.src = tempUrl;

      console.log("[æ’­æ”¾éŸ³é¢‘] é…ç½®å®Œæˆï¼Œç­‰å¾…æ’­æ”¾...");
    } catch (error) {
      console.error("æ’­æ”¾å¤±è´¥", error);
      wx.showToast({ title: "æ’­æ”¾å¤±è´¥", icon: "none" });
    } finally {
      wx.hideLoading();
    }
  },

  // åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨äº‹ä»¶ç›‘å¬
  initAudioManager() {
    audioManager.onPlay(() => {
      console.log("âœ… éŸ³é¢‘å¼€å§‹æ’­æ”¾");
      this.setData({ playing: true });
    });

    audioManager.onPause(() => {
      console.log("â¸ éŸ³é¢‘æš‚åœ");
      this.setData({ playing: false });
    });

    audioManager.onEnded(() => {
      console.log("ğŸ éŸ³é¢‘æ’­æ”¾ç»“æŸ");
      this.setData({ playing: false });
    });

    audioManager.onError((err) => {
      console.error("âŒ éŸ³é¢‘æ’­æ”¾é”™è¯¯", err);
      wx.showModal({
        title: "æ’­æ”¾å¤±è´¥",
        content: `é”™è¯¯ç : ${err.errCode}\n${err.errMsg}`,
        showCancel: false,
      });
    });
  },

  // åˆ‡æ¢æ’­æ”¾/æš‚åœ
  togglePlay() {
    if (this.data.playing) {
      audioManager.pause();
    } else {
      audioManager.play();
    }
  },
});
```

## ğŸ”‘ å…³é”®è¦ç‚¹

### 1. BackgroundAudioManager ä½¿ç”¨è§„èŒƒ

```javascript
// âœ… æ­£ç¡®çš„é¡ºåº
audioManager.title = "éŸ³é¢‘æ ‡é¢˜";      // 1. å…ˆè®¾ç½® titleï¼ˆiOS å¿…é¡»ï¼‰
audioManager.epname = "ä¸“è¾‘åç§°";     // 2. è®¾ç½®å…¶ä»–å±æ€§
audioManager.singer = "æ­Œæ‰‹åç§°";
audioManager.coverImgUrl = "å°é¢URL";
audioManager.src = "https://...";    // 3. æœ€åè®¾ç½® srcï¼ˆä¼šè‡ªåŠ¨æ’­æ”¾ï¼‰

// âŒ é”™è¯¯çš„é¡ºåº
audioManager.src = "https://...";    // å…ˆè®¾ç½® src
audioManager.title = "éŸ³é¢‘æ ‡é¢˜";      // åè®¾ç½® titleï¼ˆiOS å¯èƒ½æ— æ³•æ’­æ”¾ï¼‰
```

### 2. getTempFileURL çš„æ­£ç¡®ç”¨æ³•

```javascript
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥è¿”å›ç»“æœ
const res = await wx.cloud.getTempFileURL({ fileList: [fileId] });
const fileInfo = res?.fileList?.[0];

if (fileInfo && fileInfo.status === 0 && fileInfo.tempFileURL) {
  const tempUrl = fileInfo.tempFileURL;
  // ä½¿ç”¨ tempUrl
} else {
  // å¤„ç†é”™è¯¯
  console.error("è·å–å¤±è´¥", fileInfo);
}

// âŒ é”™è¯¯ï¼šä¸æ£€æŸ¥è¿”å›ç»“æœ
const res = await wx.cloud.getTempFileURL({ fileList: [fileId] });
const tempUrl = res.fileList[0].tempFileURL; // å¯èƒ½æŠ¥é”™
```

### 3. çœŸæœºè°ƒè¯•æ—¥å¿—

```javascript
// âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—
console.log("[æ’­æ”¾éŸ³é¢‘] fileId:", fileId);
console.log("[æ’­æ”¾éŸ³é¢‘] ä¸´æ—¶é“¾æ¥:", tempUrl);
console.log("[æ’­æ”¾éŸ³é¢‘] é…ç½®å®Œæˆ");

// åœ¨çœŸæœºè°ƒè¯•æ—¶ï¼Œæ‰“å¼€ vConsole æŸ¥çœ‹è¿™äº›æ—¥å¿—
```

## ğŸ“± æµ‹è¯•æ­¥éª¤

1. **å¼€å‘è€…å·¥å…·æµ‹è¯•**
   - ç‚¹å‡»éŸ³é¢‘åˆ—è¡¨ä¸­çš„ä»»æ„éŸ³é¢‘
   - è·³è½¬åˆ°æ’­æ”¾å™¨é¡µé¢
   - éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾

2. **çœŸæœºè°ƒè¯•æµ‹è¯•**
   - ä½¿ç”¨ "çœŸæœºè°ƒè¯•" åŠŸèƒ½
   - æ‰“å¼€ vConsole æŸ¥çœ‹æ—¥å¿—
   - æµ‹è¯•æ’­æ”¾ã€æš‚åœã€å¿«è¿›ç­‰åŠŸèƒ½

---

**æœ€åæ›´æ–°**: 2025-11-23

