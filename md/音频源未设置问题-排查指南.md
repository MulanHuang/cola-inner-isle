# 🔧 音频源未设置问题 - 排查指南

## 📱 问题现象
- 点击"🔧 诊断"按钮显示：**"音频源: 未设置"**
- 点击"强制播放"显示：**"音频源未设置"**
- 过一会儿显示：**"播放失败，错误码 undefined，错误信息 undefined"**

这说明 `audioManager.src` 没有被设置，音频加载过程失败了。

---

## 🔍 可能的原因

### 原因1：页面跳转时 ID 没有传递
**检查方法**：
查看控制台日志中的第一行：
```
[player] ========== 页面加载 ==========
[player] options: { id: "xxx" }  ← 检查这里
```

**如果 `id` 为空或 undefined**：
- 说明从冥想列表跳转时没有传递 ID
- 需要检查 `meditation.js` 中的 `playAudio` 函数

---

### 原因2：数据库查询失败
**检查方法**：
查看控制台日志：
```
[player] ========== 加载音频信息 ==========
[player] audioId: xxx
[player] 数据库查询结果: { data: {...} }  ← 检查这里
```

**如果看到错误**：
- 可能是数据库权限问题
- 可能是 ID 不存在

---

### 原因3：audioUrl 字段缺失
**检查方法**：
查看控制台日志：
```
[player] 音频数据:
[player] - audioUrl: cloud://xxx  ← 检查这里
[player] - audioURL: cloud://xxx  ← 或这里
[player] - 最终使用的 fileId: cloud://xxx  ← 重点检查
```

**如果 fileId 为空**：
- 说明数据库中没有 `audioUrl` 或 `audioURL` 字段
- 需要检查数据库数据

---

### 原因4：getTempFileURL 失败
**检查方法**：
查看控制台日志：
```
[player] 📡 正在调用 wx.cloud.getTempFileURL...
[player] 📡 getTempFileURL 返回结果:
[player] - 完整响应: {...}  ← 检查这里
[player] - status: 0  ← 应该是 0
[player] - tempFileURL: https://xxx  ← 应该有值
```

**如果 status 不是 0**：
- 说明获取临时链接失败
- 可能是云存储权限问题
- 可能是 fileID 格式错误

---

### 原因5：网络问题
**检查方法**：
- 查看是否有网络连接
- 查看是否能访问其他云开发功能

---

## 🚀 立即执行的操作

### 步骤1：清除缓存并重新编译
```
1. 微信开发者工具 → 编译 → 清除缓存 → 清除全部缓存
2. 重新编译
3. 真机调试
```

### 步骤2：查看完整日志
```
1. 打开小程序
2. 进入冥想页面
3. 点击任意音频
4. 在控制台中查看从"页面加载"到"准备播放"的所有日志
5. 截图所有日志
```

### 步骤3：检查数据库
```
1. 打开微信开发者工具
2. 点击"云开发"
3. 点击"数据库"
4. 打开 meditations 集合
5. 找到你要播放的音频记录
6. 检查是否有 audioUrl 或 audioURL 字段
7. 检查字段值是否以 "cloud://" 开头
```

---

## 📋 关键日志检查清单

请在控制台中查找以下日志，并记录结果：

### 1. 页面加载
```
[player] ========== 页面加载 ==========
[player] options: ?  ← 记录这里的值
```

### 2. 音频 ID
```
[player] ========== 加载音频信息 ==========
[player] audioId: ?  ← 记录这里的值
```

### 3. 数据库查询
```
[player] 数据库查询结果: ?  ← 记录这里的值
```

### 4. 文件 ID
```
[player] - 最终使用的 fileId: ?  ← 记录这里的值
```

### 5. 临时链接
```
[player] ✅ 成功获取临时链接: ?  ← 记录这里的值
```

### 6. 音频源设置
```
[player] - src: ?  ← 记录这里的值
```

### 7. 错误信息
```
[player] ❌ xxx  ← 记录所有错误日志
```

---

## 🎯 根据日志定位问题

### 情况1：options 中没有 id
**问题**：页面跳转时没有传递 ID
**解决**：检查 `meditation.js` 中的 `playAudio` 函数

### 情况2：数据库查询失败
**问题**：数据库权限或 ID 不存在
**解决**：检查数据库权限和数据

### 情况3：fileId 为空
**问题**：数据库中没有 audioUrl 字段
**解决**：在数据库中添加 audioUrl 字段

### 情况4：getTempFileURL 失败
**问题**：云存储权限或 fileID 格式错误
**解决**：检查云存储权限设置

### 情况5：没有任何日志
**问题**：页面根本没有加载
**解决**：检查页面路径配置

---

## 💡 快速测试方法

### 方法1：手动设置音频源
在控制台执行：
```javascript
const audioManager = wx.getBackgroundAudioManager()
audioManager.title = '测试音频'
audioManager.src = 'https://example.com/test.mp3'
```

如果这个能播放，说明是数据加载的问题。

### 方法2：检查数据库数据
在控制台执行：
```javascript
const db = wx.cloud.database()
db.collection('meditations').get().then(res => {
  console.log('数据库数据:', res.data)
})
```

查看返回的数据中是否有 `audioUrl` 或 `audioURL` 字段。

---

## 📸 需要反馈的信息

请提供以下信息：

1. **完整的控制台日志**（从"页面加载"开始）
2. **数据库截图**（meditations 集合中的一条记录）
3. **诊断按钮截图**（已有）
4. **是否有任何错误提示**

---

## 🆘 紧急修复方案

如果以上方法都不行，可以尝试：

### 方案1：直接使用 HTTPS 链接
如果你的音频文件有公开的 HTTPS 链接，可以直接在数据库中使用 HTTPS 链接，而不是 fileID。

### 方案2：重新上传音频文件
1. 删除云存储中的音频文件
2. 重新上传
3. 获取新的 fileID
4. 更新数据库中的 audioUrl 字段

### 方案3：使用 InnerAudioContext
如果 BackgroundAudioManager 有问题，可以临时使用 InnerAudioContext：
```javascript
const audio = wx.createInnerAudioContext()
audio.src = tempUrl
audio.play()
```

---

## 📞 下一步

1. **重新编译并真机调试**
2. **查看完整的控制台日志**
3. **截图所有关键日志**
4. **检查数据库数据**
5. **反馈结果**

