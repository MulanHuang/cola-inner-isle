<!--pages/emotion/emotion.wxml-->
<view class="container emotion-container">
  <!-- 顶部精简 Hero -->
  <view class="hero-card">
    <view class="hero-content">
      <view class="quote-text">{{emotionQuote.content}}</view>
      <view class="quote-author" wx:if="{{emotionQuote.author}}">— {{emotionQuote.author}}</view>
      <view class="quote-refresh" bindtap="refreshEmotionQuote">
        <text class="refresh-icon">↻</text>
      </view>
    </view>
  </view>

  <!-- 进度指示器 -->
  <view class="progress-bar">
    <view class="progress-fill" style="width: {{completionScore / completionTotal * 100}}%"></view>
    <view class="progress-text">{{completionScore}}/{{completionTotal}}</view>
  </view>

  <!-- 情绪选择 -->
  <view class="section emotion-select-section">
    <view class="section-title">此刻感受如何？</view>
    <view class="emotion-grid">
      <view
        wx:for="{{showAllEmotions ? emotions : emotions.slice(0, 6)}}"
        wx:key="id"
        class="emotion-item {{selectedEmotion === item.id ? 'selected' : ''}}"
        bindtap="selectEmotion"
        data-id="{{item.id}}">
        <view class="emotion-icon">{{item.icon}}</view>
        <view class="emotion-name">{{item.name}}</view>
      </view>
    </view>
    <view class="show-more-emotions" bindtap="toggleAllEmotions" wx:if="{{emotions.length > 6}}">
      <text>{{showAllEmotions ? '收起' : '更多情绪'}}</text>
      <text class="arrow">{{showAllEmotions ? '↑' : '↓'}}</text>
    </view>
  </view>

  <!-- 情绪反馈 -->
  <view wx:if="{{emotionFeedback}}" class="emotion-feedback">
    <view class="feedback-text">{{emotionFeedback}}</view>
  </view>

  <!-- 今日能量指数 -->
  <view class="section energy-section">
    <view class="section-title">今日能量</view>
    <view class="energy-stars">
      <view
        wx:for="{{[1,2,3,4,5]}}"
        wx:key="*this"
        class="star-item {{energyLevel >= item ? 'active' : ''}}"
        bindtap="setEnergyLevel"
        data-level="{{item}}">
        <text class="star-icon">{{energyLevel >= item ? '⭐' : '☆'}}</text>
      </view>
    </view>
    <view class="energy-hint" wx:if="{{energyLevel > 0}}">
      <text wx:if="{{energyLevel === 1}}">需要好好休息</text>
      <text wx:elif="{{energyLevel === 2}}">慢慢来就好</text>
      <text wx:elif="{{energyLevel === 3}}">状态不错</text>
      <text wx:elif="{{energyLevel === 4}}">能量满满</text>
      <text wx:elif="{{energyLevel === 5}}">超级充沛</text>
    </view>
  </view>

  <!-- 今日亮点 (Tab 切换: 感恩/成就) -->
  <view class="section highlights-section">
    <view class="section-title">今日亮点</view>
    <view class="tab-bar">
      <view class="tab {{highlightTab === 'gratitude' ? 'active' : ''}}" bindtap="switchHighlightTab" data-tab="gratitude">感恩</view>
      <view class="tab {{highlightTab === 'success' ? 'active' : ''}}" bindtap="switchHighlightTab" data-tab="success">成就</view>
    </view>

    <!-- 感恩内容 -->
    <view class="tab-content" wx:if="{{highlightTab === 'gratitude'}}">
      <scroll-view scroll-x="true" class="template-scroll" show-scrollbar="{{false}}">
        <view class="template-buttons">
          <view
            wx:for="{{gratitudeTemplates}}"
            wx:key="id"
            class="template-btn-small"
            bindtap="insertGratitudeTemplate"
            data-text="{{item.text}}"
            hover-class="template-btn-hover">
            <text class="template-icon-small">{{item.icon}}</text>
            <text class="template-label-small">{{item.label}}</text>
          </view>
        </view>
      </scroll-view>

      <view class="input-list">
        <view
          wx:for="{{gratitudeItems}}"
          wx:key="index"
          wx:if="{{index === 0 || (index === 1 && showMoreGratitude) || (index === 2 && (showThirdGratitude || item))}}"
          class="input-item {{gratitudeFocusStates[index] ? 'focused' : ''}}">
          <view class="item-number">{{index + 1}}</view>
          <view class="item-content">
            <textarea
              class="item-textarea"
              placeholder="{{index === 0 ? '今天我感激的是…' : index === 1 ? '让我微笑的瞬间…' : '温暖我的人或事…'}}"
              placeholder-class="input-placeholder"
              value="{{item}}"
              bindinput="onGratitudeInput"
              bindfocus="onGratitudeFocus"
              bindblur="onGratitudeBlur"
              data-index="{{index}}"
              maxlength="{{maxTextLength}}"
              auto-height="{{true}}"
            />
          </view>
        </view>
      </view>
      <view class="list-toggle" bindtap="toggleGratitudeList" wx:if="{{!showThirdGratitude && !gratitudeItems[2]}}">
        <text>+ 添加更多</text>
      </view>
    </view>

    <!-- 成就内容 -->
    <view class="tab-content" wx:if="{{highlightTab === 'success'}}">
      <scroll-view scroll-x="true" class="template-scroll" show-scrollbar="{{false}}">
        <view class="template-buttons">
          <view
            wx:for="{{successTemplates}}"
            wx:key="id"
            class="template-btn-small"
            bindtap="insertSuccessTemplate"
            data-text="{{item.text}}"
            hover-class="template-btn-hover">
            <text class="template-icon-small">{{item.icon}}</text>
            <text class="template-label-small">{{item.label}}</text>
          </view>
        </view>
      </scroll-view>

      <view class="input-list">
        <view
          wx:for="{{successItems}}"
          wx:key="index"
          wx:if="{{index === 0 || (index === 1 && showMoreSuccess) || (index === 2 && (showThirdSuccess || item))}}"
          class="input-item {{successFocusStates[index] ? 'focused' : ''}}">
          <view class="item-number">{{index + 1}}</view>
          <view class="item-content">
            <textarea
              class="item-textarea"
              placeholder="{{index === 0 ? '我做得好的事…' : index === 1 ? '我坚持的一件事…' : '我进步的地方…'}}"
              placeholder-class="input-placeholder"
              value="{{item}}"
              bindinput="onSuccessInput"
              bindfocus="onSuccessFocus"
              bindblur="onSuccessBlur"
              data-index="{{index}}"
              maxlength="{{maxTextLength}}"
              auto-height="{{true}}"
            />
          </view>
        </view>
      </view>
      <view class="list-toggle" bindtap="toggleSuccessList" wx:if="{{!showThirdSuccess && !successItems[2]}}">
        <text>+ 添加更多</text>
      </view>
    </view>
  </view>

  <!-- 自由输入区 -->
  <view class="section free-text-section">
    <view class="section-title">自由记录</view>
    <textarea
      class="emotion-textarea"
      placeholder="还有什么想说的..."
      value="{{description}}"
      bindinput="onDescriptionInput"
      maxlength="500"
      placeholder-class="textarea-placeholder"
    ></textarea>
    <view class="char-count" wx:if="{{description.length > 0}}">{{description.length}}/500</view>
  </view>

  <!-- 标签选择 -->
  <view class="section tags-section">
    <view class="section-title">添加标签</view>
    <view class="tag-list">
      <view
        wx:for="{{tags}}"
        wx:key="id"
        class="tag-item {{selectedTags.includes(item.id) ? 'selected' : ''}}"
        catchtap="toggleTag"
        data-id="{{item.id}}"
        hover-class="tag-item-hover">
        <text class="tag-icon">{{item.icon}}</text>
        <text class="tag-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- AI 温柔回声 (简化为可折叠区域) -->
  <view class="section ai-section-collapsed" wx:if="{{!aiReply && !aiLoading}}">
    <view class="ai-trigger" bindtap="getAIReflection" wx:if="{{selectedEmotion || description}}">
      <text class="ai-trigger-icon">🌙</text>
      <text class="ai-trigger-text">获取温柔回声</text>
    </view>
    <view class="ai-disclaimer" wx:if="{{selectedEmotion || description}}">AI生成，仅供参考</view>
  </view>

  <!-- AI 回复内容 -->
  <view wx:if="{{aiReply || aiLoading}}" class="section ai-section">
    <view class="ai-header">
      <view class="ai-title">温柔回声</view>
      <view class="ai-reask" bindtap="getAIReflection">↻</view>
    </view>
    <view wx:if="{{aiLoading && !aiReply}}" class="ai-loading">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    <view wx:if="{{aiReply}}" class="ai-content">{{aiReply}}</view>
  </view>

  <!-- 合规免责声明 -->
  <view class="compliance-disclaimer">
    本内容由AI生成，仅供自我探索参考，不构成心理诊断或医疗建议
  </view>

  <!-- 底部操作条 -->
  <view class="action-bar">
    <button class="btn-secondary" bindtap="viewHistory">历史</button>
    <button class="btn-primary btn-save" bindtap="saveEmotion" disabled="{{!selectedEmotion}}">
      {{selectedEmotion ? '保存记录' : '请先选择情绪'}}
    </button>
  </view>
</view>

<!-- 全局悬浮音乐控制按钮 -->
<audio-float />
