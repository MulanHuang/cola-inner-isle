<!--pages/explore/monthly-plan/monthly-plan.wxml-->
<view class="container monthly-plan-container">
  <!-- é¡¶éƒ¨æ“ä½œ -->
  <view class="header-bar">
    <view class="icon-btn" bindtap="goBack">â€¹</view>
    <view class="icon-btn" bindtap="viewHistory">ğŸ“…</view>
  </view>

  <!-- å¤§æœˆä»½æ ‡é¢˜åŒº -->
  <view class="month-hero">
    <view class="hero-month-num">{{currentMonth < 10 ? '0' + currentMonth : currentMonth}}</view>
    <view class="hero-meta">
      <view class="hero-year-row">
        <text class="hero-year">{{currentYear}}</text>
        <text class="hero-month-en">{{monthNameEn}}</text>
      </view>
      <text class="plan-label">Monthly Plan</text>
      <view class="hero-nav">
        <view class="nav-btn nav-outline" bindtap="prevMonth">â€¹</view>
        <view class="nav-btn nav-outline" bindtap="nextMonth">â€º</view>
      </view>
    </view>
  </view>

  <scroll-view scroll-y class="main-scroll">
    <!-- æœ¬æœˆä»»åŠ¡åŒºå— -->
    <view class="section-block tasks-section">
      <view class="section-head">
        <view class="section-title">æœ¬æœˆä»»åŠ¡</view>
        <view class="section-caption">ä¼˜å…ˆçº§å’Œæˆªæ­¢æ—¥æ¸…æ™°æ’å¸ƒï¼ŒåŒæ è¡¨æ ¼é£æ ¼</view>
      </view>
      <view class="tasks-table framed">
        <view class="tasks-body task-list-panel">
          <view wx:for="{{tasks}}" wx:key="id" class="task-row todo-style">
            <view class="list-checkbox {{item.completed ? 'checked' : ''}}" catchtap="toggleTaskComplete" data-index="{{index}}">
              <text wx:if="{{item.completed}}" class="check-icon">âœ“</text>
            </view>
            <view class="task-content" bindtap="onTaskTap" data-index="{{index}}">
              <view class="task-title {{item.completed ? 'completed' : ''}}">{{item.title || 'æœªå‘½åä»»åŠ¡'}}</view>
              <view class="task-meta">
                <text wx:if="{{item.priorityLabel}}" class="meta-priority {{item.priority}}">{{item.priorityLabel}}</text>
                <text wx:if="{{item.deadline}}" class="meta-deadline">{{item.deadline}}</text>
              </view>
              <view wx:if="{{item.completed}}" class="strikethrough-line"></view>
            </view>
            <view class="task-delete" catchtap="removeTask" data-index="{{index}}">Ã—</view>
          </view>
          <view class="add-row" bindtap="onAddTask">+ æ·»åŠ ä»»åŠ¡</view>
        </view>
      </view>
    </view>

    <!-- æˆªæ­¢æ—¶é—´æ ‡æ³¨ï¼ˆç®€æ´æ—¥å†ï¼‰ -->
    <view class="section-block calendar-section">
      <view class="section-head">
        <view class="section-title">æˆªæ­¢æ—¶é—´æ ‡æ³¨</view>
        <view class="section-caption">ç”¨å›¾æ ‡ä¸é¢œè‰²æ ‡å‡ºæœ¬æœˆè®°å¿†ç‚¹</view>
      </view>
      <view class="calendar-wrapper">
        <view class="calendar-frame">
          <!-- æ˜ŸæœŸè¡¨å¤´ -->
          <view class="weekdays-row">
            <text wx:for="{{weekDaysWithIcon}}" wx:key="index" class="weekday">
              <text class="weekday-text">{{item.name}}</text>
            </text>
          </view>
          <!-- æ—¥æœŸæ ¼ç½‘æ ¼ -->
          <view class="calendar-grid">
            <view wx:for="{{calendarDays}}"
                  wx:key="index"
                  class="calendar-cell {{item.isCurrentMonth ? '' : 'other-month'}} {{item.isToday ? 'is-today' : ''}} {{item.hasContent ? 'has-content' : ''}} {{item.hasDailyRecord ? 'has-daily-record' : ''}}"
                  bindtap="onCellContentTap"
                  data-date-str="{{item.dateStr}}"
                  data-index="{{index}}">
              <view class="cell-date-row">
                <text class="cell-date-num">{{item.day}}</text>
                <!-- æ¯æ—¥è®°å½•å­˜åœ¨æ ‡è®°ï¼ˆæŸ”å’Œå°åœ†ç‚¹ï¼‰ -->
                <view wx:if="{{item.hasDailyRecord}}" class="daily-record-dot"></view>
              </view>
              <view wx:if="{{item.contentPreview && item.contentPreview.length}}" class="cell-notes">
                <text wx:for="{{item.contentPreview}}"
                      wx:key="idx"
                      class="cell-note-line">{{item}}</text>
              </view>
            </view>
          </view>
          <view class="calendar-bottom-bar"></view>
        </view>
      </view>
    </view>

    <!-- æœ¬æœˆå¤ç›˜å…¥å£ -->
    <view class="section-block review-section" bindtap="goToReview">
      <view class="review-main">
        <text class="review-title">æœ¬æœˆå¤ç›˜</text>
        <!-- æœ¬æœˆæ¯æ—¥è®°å½•æ•°é‡æç¤ºï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
        <text wx:if="{{monthDailyCount > 0}}" class="review-hint-text">è¿™ä¸ªæœˆï¼Œä½ è®°å½•äº† {{monthDailyCount}} å¤©</text>
      </view>
      <text class="review-arrow">â†’</text>
    </view>

    <!-- æœ¬æœˆå‘¨è®°å½•å…¥å£ï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
    <view wx:if="{{monthWeekRecords.length > 0}}" class="section-block week-link-section" bindtap="showMonthWeekSheet">
      <view class="week-link-main">
        <text class="week-link-title">æŸ¥çœ‹æœ¬æœˆçš„å‘¨è®°å½•</text>
        <text class="week-link-count">{{monthWeekRecords.length}} å‘¨</text>
      </view>
      <text class="week-link-arrow">â†’</text>
    </view>

    <!-- ğŸ§­ AI æˆé•¿æ•™ç»ƒæ¨¡å—ï¼ˆå¿…é¡»åœ¨å¤ç›˜æ¨¡å—ä¸‹æ–¹ï¼‰ -->
    <view class="section-block ai-coach-section">
      <view class="ai-coach-header">
        <text class="ai-coach-title">ğŸ§­ å’Œæˆé•¿æ•™ç»ƒä¸€èµ·å¤ç›˜æœ¬æœˆ</text>
      </view>
      <view class="ai-coach-desc">
        <text class="ai-coach-desc-line">å½“æ—¶é—´æ‹‰é•¿ï¼Œ</text>
        <text class="ai-coach-desc-line">æœ‰äº›æ¨¡å¼ä¼šæ…¢æ…¢æµ®ç°ã€‚</text>
      </view>
      <button class="ai-coach-btn" bindtap="triggerMonthlyAICoach" disabled="{{aiCoachLoading}}">
        <text wx:if="{{!aiCoachLoading}}">å¤ç›˜æœ¬æœˆ</text>
        <text wx:else>æ­£åœ¨æ•´ç†æ€ç»ª...</text>
      </button>
      <view class="ai-coach-tip">AIç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</view>

      <!-- AI æ•™ç»ƒè¾“å‡ºå¡ç‰‡ï¼ˆå¯æŠ˜å ï¼‰ -->
      <view wx:if="{{aiCoachResponse}}" class="ai-coach-result">
        <view class="ai-result-header" bindtap="toggleAICoachResult">
          <text class="ai-result-label">ğŸŒ¿ æˆé•¿æ•™ç»ƒçš„è§†è§’</text>
          <text class="ai-result-toggle">{{aiCoachResultExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        <view class="ai-result-content {{aiCoachResultExpanded ? 'expanded' : 'collapsed'}}">
          <text class="ai-result-text">{{aiCoachResponse}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨ç•™ç™½ -->
    <view class="bottom-spacer"></view>
  </scroll-view>

  <!-- æœ¬æœˆå‘¨è®°å½•åˆ—è¡¨å¼¹å±‚ï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
  <view class="week-sheet {{showMonthWeekSheet ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="week-sheet-mask" bindtap="hideMonthWeekSheet"></view>
    <view class="week-sheet-content">
      <view class="week-sheet-header">
        <text class="week-sheet-title">æœ¬æœˆçš„å‘¨è®°å½•</text>
        <view class="week-sheet-close" bindtap="hideMonthWeekSheet">Ã—</view>
      </view>
      <scroll-view class="week-sheet-list" scroll-y>
        <view wx:for="{{monthWeekRecords}}" wx:key="weekKey" class="week-item" bindtap="goToWeekDetail" data-week-key="{{item.weekKey}}" data-year="{{item.year}}" data-week="{{item.weekOfYear}}">
          <text class="week-item-title">{{item.displayTitle}}</text>
          <text class="week-item-preview">{{item.preview}}</text>
          <text class="week-item-arrow">â€º</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- æ—¥æœŸè®°å½•ç¼–è¾‘å¼¹å±‚ -->
  <view class="edit-sheet {{showEditSheet ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="sheet-mask" bindtap="closeEditSheet"></view>
    <view class="sheet-content">
      <view class="sheet-header">
        <text class="sheet-date">{{editingDateDisplay}}</text>
        <view class="sheet-close" bindtap="closeEditSheet">Ã—</view>
      </view>
      <!-- æ¯æ—¥è®°å½•å›çœ‹å…¥å£ï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
      <view wx:if="{{editingDateHasDailyRecord}}" class="daily-link-hint" bindtap="goToDailyPlan">
        <text class="daily-link-text">è¿™ä¸€å¤©ï¼Œä½ å†™è¿‡ä¸€æ¡æ¯æ—¥è®°å½•</text>
        <text class="daily-link-arrow">â€º</text>
      </view>
      <view class="sheet-body">
        <view class="todo-sheet">
          <view class="todo-list">
            <view wx:for="{{editingTodos}}" wx:key="index" class="todo-row">
              <view class="todo-checkbox {{item.completed ? 'checked' : ''}}"
                    bindtap="toggleTodoItem"
                    data-index="{{index}}">
                <text wx:if="{{item.completed}}" class="check-icon">âœ“</text>
              </view>
              <view class="todo-input-wrap">
                <textarea class="todo-input {{item.completed ? 'completed' : ''}}"
                          placeholder="{{index === 0 && editingTodos.length === 1 ? 'è®°å½•è¿™ä¸€å¤©...' : 'å†™ç‚¹ä»€ä¹ˆ'}}"
                          placeholder-class="todo-placeholder"
                          value="{{item.text}}"
                          bindinput="onTodoItemInput"
                          data-index="{{index}}"
                          auto-height
                          maxlength="-1" />
                <view wx:if="{{item.completed}}" class="strikethrough-line"></view>
              </view>
              <view wx:if="{{editingTodos.length > 1}}" class="todo-delete" bindtap="removeTodoItem" data-index="{{index}}">Ã—</view>
            </view>
          </view>
          <view class="todo-add" bindtap="addTodoItem">+ æ·»åŠ </view>
        </view>
      </view>
      <view class="sheet-footer">
        <button class="btn-confirm" bindtap="confirmEdit">å®Œæˆ</button>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡ç¼–è¾‘å¼¹å±‚ -->
  <view class="edit-sheet {{showTaskSheet ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="sheet-mask" bindtap="closeTaskSheet"></view>
    <view class="sheet-content task-sheet">
      <view class="sheet-header">
        <text class="sheet-date">{{editingTaskIndex >= 0 ? 'ç¼–è¾‘ä»»åŠ¡' : 'æ·»åŠ ä»»åŠ¡'}}</text>
        <view class="sheet-close" bindtap="closeTaskSheet">Ã—</view>
      </view>
      <view class="sheet-body task-form">
        <view class="form-item">
          <text class="form-label">äº‹é¡¹</text>
          <textarea class="form-input task-title-input"
                    placeholder="ä»»åŠ¡å†…å®¹"
                    placeholder-class="form-placeholder"
                    value="{{editingTask.title}}"
                    auto-height
                    bindinput="onTaskTitleInput"></textarea>
        </view>
        <view class="form-item">
          <text class="form-label">ä¼˜å…ˆçº§</text>
          <view class="priority-options">
            <view class="priority-opt {{editingTask.priority === 'high' ? 'active' : ''}}"
                  data-priority="high" bindtap="onPrioritySelect">é«˜</view>
            <view class="priority-opt {{editingTask.priority === 'medium' ? 'active' : ''}}"
                  data-priority="medium" bindtap="onPrioritySelect">ä¸­</view>
            <view class="priority-opt {{editingTask.priority === 'low' ? 'active' : ''}}"
                  data-priority="low" bindtap="onPrioritySelect">ä½</view>
          </view>
        </view>
        <view class="form-item">
          <text class="form-label">æˆªæ­¢æ—¥æœŸ</text>
          <picker mode="date" value="{{editingTask.deadline}}" bindchange="onDeadlineChange">
            <view class="form-input picker-value">{{editingTask.deadline || 'é€‰æ‹©æ—¥æœŸ'}}</view>
          </picker>
        </view>
      </view>
      <view class="sheet-footer task-footer">
        <button wx:if="{{editingTaskIndex >= 0}}" class="btn-delete" bindtap="deleteTask">åˆ é™¤</button>
        <button class="btn-confirm" bindtap="confirmTask">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>
