<!--pages/explore/week-plan/week-plan.wxml-->
<view class="container week-plan-container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header-bar">
    <view class="back-btn" bindtap="goBack">
      <view class="back-icon"></view>
    </view>
    <view class="header-title">å‘¨è®¡åˆ’è¡¨</view>
    <view class="history-btn" bindtap="viewHistory">
      <text class="history-icon">ğŸ“…</text>
    </view>
  </view>

  <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
  <view class="top-info-bar">
    <text class="top-info-text">{{currentYear}} ï½œ å‘¨è®¡åˆ’ ï½œ {{currentMonth}}æœˆ Â· ç¬¬{{weekOfMonth}}å‘¨</text>
  </view>

  <!-- å‘¨åˆ‡æ¢å¯¼èˆª -->
  <view class="week-nav">
    <view class="nav-btn" bindtap="prevWeek">
      <text>â€¹</text>
    </view>
    <view class="week-display">{{weekRangeDisplay}}</view>
    <view class="nav-btn" bindtap="nextWeek">
      <text>â€º</text>
    </view>
  </view>

  <!-- çº¸è´¨æ‰‹è´¦ä¸»ä½“ -->
  <view class="notebook-wrapper">
    <!-- ä¸»å†…å®¹åŒº - å·¦å³åˆ†æ  -->
    <view class="main-content">
      <!-- å·¦ä¾§æ  - å‘¨ä»»åŠ¡åˆ†è§£ -->
      <view class="left-column">
        <view class="section-header task-header">
          <text class="section-title">å‘¨ä»»åŠ¡åˆ†è§£</text>
        </view>
        
        <!-- æŒ‰å¤©åˆ†ç»„çš„ä»»åŠ¡åˆ—è¡¨ -->
        <view wx:for="{{weekDays}}" wx:key="index" class="day-task-group">
          <view class="day-label" style="background: {{item.color}};">
            <text class="day-label-text">{{item.label}}</text>
          </view>
          <view class="day-tasks">
            <view class="list-items">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:for-index="taskIndex" wx:key="taskIndex" class="list-row task-row">
                <view class="task-dot" style="background: {{item.dotColor}};"></view>
                <view class="list-checkbox {{task.completed ? 'checked' : ''}}"
                      bindtap="toggleDayTaskComplete"
                      data-day-index="{{index}}"
                      data-task-index="{{taskIndex}}">
                  <text wx:if="{{task.completed}}" class="check-icon">âœ“</text>
                </view>
                <view class="list-input-wrapper">
                  <textarea class="list-input {{task.completed ? 'completed' : ''}}"
                            placeholder="{{taskIndex === 0 && item.tasks.length === 1 ? 'å†™ä¸‹æ¥å°±å·²ç»å¾ˆå¥½äº†' : ''}}"
                            placeholder-class="input-placeholder"
                            value="{{task.text}}"
                            bindinput="onDayTaskInput"
                            data-day-index="{{index}}"
                            data-task-index="{{taskIndex}}"
                            auto-height
                            maxlength="-1" />
                  <view wx:if="{{task.completed}}" class="strikethrough-line"></view>
                </view>
                <view wx:if="{{item.tasks.length > 1}}" class="remove-btn" bindtap="removeDayTask" data-day-index="{{index}}" data-task-index="{{taskIndex}}">Ã—</view>
              </view>
            </view>
            <view class="add-row add-task-row" bindtap="addDayTask" data-day-index="{{index}}">+ æ·»åŠ </view>
          </view>
        </view>
      </view>

      <!-- å³ä¾§æ  -->
      <view class="right-column">
        <!-- å‘¨æ—¥å† -->
        <view class="calendar-section">
          <view class="calendar-header">
            <text class="calendar-month">{{currentMonth}}æœˆ</text>
            <text class="calendar-week-num">ç¬¬{{weekOfMonth}}å‘¨</text>
          </view>
          <view class="mini-calendar">
            <view class="cal-weekdays">
              <text wx:for="{{calWeekDays}}" wx:key="*this" class="cal-weekday">{{item}}</text>
            </view>
            <view class="cal-days-grid">
              <view wx:for="{{calendarDays}}" wx:key="index"
                    class="cal-day {{item.isCurrentWeek ? 'current-week' : ''}} {{item.hasDailyRecord ? 'has-record' : ''}} {{item.isToday ? 'is-today' : ''}}"
                    bindtap="{{item.hasDailyRecord ? 'onCalDayTap' : ''}}"
                    data-date-str="{{item.dateStr}}"
                    data-has-record="{{item.hasDailyRecord}}">
                <text wx:if="{{item.day}}" class="cal-day-num">{{item.day}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- å…³é”®äº‹ä»¶ -->
        <view class="key-events-section">
          <view class="section-header-right">
            <text class="section-title-right">å…³é”®äº‹ä»¶</text>
          </view>
          <view class="list-items">
            <view wx:for="{{keyEvents}}" wx:key="index" class="list-row">
              <view class="list-checkbox {{item.completed ? 'checked' : ''}}"
                    bindtap="toggleKeyEventComplete"
                    data-index="{{index}}">
                <text wx:if="{{item.completed}}" class="check-icon">âœ“</text>
              </view>
              <view class="list-input-wrapper">
                <textarea class="list-input {{item.completed ? 'completed' : ''}}"
                          placeholder="{{index === 0 && keyEvents.length === 1 ? 'å“ªæ€•åªæœ‰ä¸€ä»¶' : ''}}"
                          placeholder-class="input-placeholder"
                          value="{{item.text}}"
                          bindinput="onKeyEventInput"
                          data-index="{{index}}"
                          auto-height
                          maxlength="-1" />
                <view wx:if="{{item.completed}}" class="strikethrough-line"></view>
              </view>
              <view wx:if="{{keyEvents.length > 1}}" class="remove-btn" bindtap="removeKeyEvent" data-index="{{index}}">Ã—</view>
            </view>
          </view>
          <view class="add-row" bindtap="addKeyEvent">+ æ·»åŠ </view>
        </view>

        <!-- ä¸Šå‘¨å¤ç›˜ -->
        <view class="review-section">
          <view class="section-header-right">
            <text class="section-title-right">ä¸Šå‘¨å¤ç›˜</text>
          </view>
          <!-- ä¸Šå‘¨æ¯æ—¥è®°å½•æ•°é‡æç¤ºï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
          <view wx:if="{{lastWeekDailyCount > 0}}" class="review-hint">
            <text class="review-hint-text">ä¸Šå‘¨ï¼Œä½ ä¸ºè‡ªå·±ç•™ä¸‹äº† {{lastWeekDailyCount}} æ¡æ¯æ—¥è®°å½•</text>
          </view>
          <view class="text-area-wrapper">
            <textarea class="review-textarea"
                      placeholder="ä¸Šå‘¨æœ‰å“ªäº›è®©ä½ è®°å¾—çš„äº‹æƒ…ï¼Ÿ"
                      placeholder-class="input-placeholder"
                      value="{{lastWeekReview}}"
                      bindinput="onLastWeekReviewInput"
                      maxlength="-1"
                      auto-height />
          </view>
        </view>

        <!-- æœ¬å‘¨å¾…æå‡ -->
        <view class="improve-section">
          <view class="section-header-right">
            <text class="section-title-right">æœ¬å‘¨å¾…æå‡</text>
          </view>
          <view class="text-area-wrapper">
            <textarea class="improve-textarea"
                      placeholder="è¿™ä¸€å‘¨ï¼Œä½ æƒ³å¯¹è‡ªå·±æ¸©æŸ”ä¸€ç‚¹çš„åœ°æ–¹ã€‚"
                      placeholder-class="input-placeholder"
                      value="{{weekImprovement}}"
                      bindinput="onWeekImprovementInput"
                      maxlength="-1"
                      auto-height />
          </view>
        </view>

        <!-- æœ¬å‘¨æ¯æ—¥è®°å½•å…¥å£ï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
        <view wx:if="{{thisWeekDailyRecords.length > 0}}" class="week-daily-section" bindtap="showWeekDailySheet">
          <text class="week-daily-title">æŸ¥çœ‹æœ¬å‘¨çš„æ¯æ—¥è®°å½•</text>
          <text class="week-daily-count">{{thisWeekDailyRecords.length}} æ¡</text>
          <text class="week-daily-arrow">â€º</text>
        </view>

        <!-- ğŸŒ± AI æˆé•¿æ•™ç»ƒæ¨¡å—ï¼ˆå¿…é¡»åœ¨å¤ç›˜æ¨¡å—ä¸‹æ–¹ï¼‰ -->
        <view class="ai-coach-section">
          <view class="ai-coach-header">
            <text class="ai-coach-title">ğŸŒ± å’Œæˆé•¿æ•™ç»ƒä¸€èµ·å¤ç›˜æœ¬å‘¨</text>
          </view>
          <view class="ai-coach-desc">
            <text class="ai-coach-desc-line">ä¸æ˜¯å¯¹é”™åˆ¤æ–­ï¼Œ</text>
            <text class="ai-coach-desc-line">åªæ˜¯æ¢ä¸€ä¸ªè§’åº¦çœ‹çœ‹ä½ æ­£åœ¨å¦‚ä½•ç”Ÿæ´»ã€‚</text>
          </view>
          <button class="ai-coach-btn" bindtap="triggerWeeklyAICoach" disabled="{{aiCoachLoading}}">
            <text wx:if="{{!aiCoachLoading}}">å¤ç›˜æœ¬å‘¨</text>
            <text wx:else>æ­£åœ¨æ•´ç†æ€ç»ª...</text>
          </button>
          <view class="ai-coach-tip">AIç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</view>
        </view>

        <!-- AI æ•™ç»ƒè¾“å‡ºå¡ç‰‡ï¼ˆå¯æŠ˜å ï¼‰ -->
        <view wx:if="{{aiCoachResponse}}" class="ai-coach-result">
          <view class="ai-result-header" bindtap="toggleAICoachResult">
            <text class="ai-result-label">ğŸŒ¿ æˆé•¿æ•™ç»ƒçš„è§†è§’</text>
            <text class="ai-result-toggle">{{aiCoachResultExpanded ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
          </view>
          <view class="ai-result-content {{aiCoachResultExpanded ? 'expanded' : 'collapsed'}}">
            <text class="ai-result-text">{{aiCoachResponse}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æœ¬å‘¨æ¯æ—¥è®°å½•åˆ—è¡¨å¼¹å±‚ï¼ˆè”åŠ¨åŠŸèƒ½ï¼‰ -->
  <view class="daily-sheet {{showWeekDailySheet ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="daily-sheet-mask" bindtap="hideWeekDailySheet"></view>
    <view class="daily-sheet-content">
      <view class="daily-sheet-header">
        <text class="daily-sheet-title">æœ¬å‘¨çš„æ¯æ—¥è®°å½•</text>
        <view class="daily-sheet-close" bindtap="hideWeekDailySheet">Ã—</view>
      </view>
      <scroll-view class="daily-sheet-list" scroll-y>
        <view wx:for="{{thisWeekDailyRecords}}" wx:key="date" class="daily-item" bindtap="goToDailyDetail" data-date="{{item.date}}">
          <text class="daily-item-date">{{item.displayDate}}</text>
          <text class="daily-item-preview">{{item.preview}}</text>
          <text class="daily-item-arrow">â€º</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="action-bar">
    <button class="btn-save" bindtap="saveRecord">ä¿å­˜æœ¬å‘¨è®¡åˆ’</button>
  </view>
</view>
