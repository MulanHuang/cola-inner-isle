<!--pages/tarot/tarot.wxml-->
<!-- ============================================================ -->
<!-- å¡”ç½—ç‰ŒæŠ½å–é¡µé¢ - ä¸“ä¸šçº§äº¤äº’ä¸åŠ¨ç”»                              -->
<!-- é˜¶æ®µæµç¨‹: idle â†’ shuffling â†’ spreading â†’ selecting â†’ selected â†’ result -->
<!-- å‡çº§ç‰ˆ: ç¥ç§˜ã€æ¸©æŸ”ã€çµæ€§ã€æ²»æ„ˆã€iOSçº§åˆ«è´¨æ„Ÿ                      -->
<!-- 360åº¦æ— é™æ—‹è½¬: æ”¯æŒå·¦å³æ»‘åŠ¨è¿ç»­æ—‹è½¬å¡ç‰Œåœ†ç¯                       -->
<!-- ============================================================ -->

<!-- å›ºå®šå®šä½èƒŒæ™¯å±‚ - ç¡®ä¿è¦†ç›–æ•´ä¸ªå±å¹•åŒ…æ‹¬æº¢å‡ºåŒºåŸŸ -->
<view class="tarot-bg-layer"></view>

<brand-navbar title="å¯ä¹å¿ƒå²›" showBack="{{true}}" bind:ready="onNavReady" />

<view
  class="container tarot-container page-with-custom-navbar phase-{{phase}} {{isDragging ? 'is-dragging' : ''}}"
  style="padding-top: {{navBarHeight}}px;"
>

  <!-- æ¡£æ¡ˆå®Œå–„æç¤ºæ¡ -->
  <view class="profile-tip-banner" wx:if="{{showProfileTip && phase === 'idle'}}">
    <view class="profile-tip-content" bindtap="goToProfileInfo">
      <text class="profile-tip-icon">ğŸ””</text>
      <text class="profile-tip-text">å®Œå–„ä¸ªäººä¿¡æ¯ï¼Œå¡”ç½—è§£è¯»æ›´å‡†ç¡®å“¦ï¼</text>
      <text class="profile-tip-arrow">å»å®Œå–„ â€º</text>
    </view>
    <view class="profile-tip-close" catchtap="closeProfileTip">âœ•</view>
  </view>

  <!-- æ˜Ÿå…‰ç²’å­æ•ˆæœå±‚ - ç»†è…»è½»æŸ” -->
  <view class="stars-container">
    <view class="constellation-layer"></view>
    <view class="star star-1"></view>
    <view class="star star-2"></view>
    <view class="star star-3"></view>
    <view class="star star-4"></view>
    <view class="star star-5"></view>
    <view class="star star-6"></view>
    <view class="star star-7"></view>
    <view class="star star-8"></view>
  </view>

  <!-- ========== æœªæŠ½ç‰ŒçŠ¶æ€ (idle/shuffling/spreading/selecting/selected) ========== -->
  <view wx:if="{{phase !== 'result' && !drawnCard}}" class="draw-section">

    <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
    <view class="header-row">
      <view class="tarot-title">ğŸ”® æ¯æ—¥å¡”ç½—</view>
      <view class="header-actions">
      <view class="pill">ä»Šæ—¥ {{todayCount}}/100</view>
      <navigator url="/pages/tarot/history/history" class="history-link">
        <text>ğŸ“– å†å²è®°å½•</text>
      </navigator>
    </view>
  </view>
    <!-- åˆè§„æç¤º -->
    <view class="compliance-tip">å¡”ç½—å†…å®¹ä»…ä½œä¸ºè±¡å¾åæ€å·¥å…·ï¼Œä¸æä¾›ä»»ä½•é¢„æµ‹æˆ–å åœæŒ‡å¯¼</view>

    <!-- æµç¨‹æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <view class="flow-steps">
      <view class="step-item {{phase === 'idle' ? 'active' : 'done'}}">1 Â· æé—®</view>
      <view class="step-item {{phase === 'selecting' || phase === 'selected' ? 'active' : (phase === 'shuffling' || phase === 'spreading' ? 'current' : '')}}">2 Â· é€‰ç‰Œ</view>
      <view class="step-item {{phase === 'selected' ? 'active' : ''}}">3 Â· æŠ½ç‰Œ</view>
    </view>

    <!-- é—®é¢˜è¾“å…¥åŒºåŸŸ (ä»…åœ¨ idle é˜¶æ®µå¯ç¼–è¾‘ï¼Œç´§å‡‘ç‰ˆ) -->
    <view class="question-section question-section-compact" wx:if="{{phase === 'idle'}}">
      <view class="section-title">ğŸ’­ ä½ æƒ³é—®ä»€ä¹ˆï¼Ÿ</view>
      <scroll-view class="template-scroll" scroll-x="true">
        <view
          class="template-chip"
          wx:for="{{questionTemplates}}"
          wx:key="index"
          bindtap="selectTemplate"
          data-text="{{item}}"
        >
          {{item}}
        </view>
      </scroll-view>
      <textarea
        class="question-input question-input-compact"
        placeholder="å†™ä¸‹ä½ çš„é—®é¢˜ï¼Œå°å²›å¸®ä½ é€‰ç‰Œé˜µ"
        value="{{question}}"
        bindinput="onQuestionInput"
        maxlength="200"
      ></textarea>
      <view class="char-count">{{question.length}}/200</view>
    </view>

    <!-- ç‰Œé˜µä¿¡æ¯ (æ´—ç‰Œåéšè—ï¼Œç´§å‡‘ç‰ˆ) -->
    <view class="spread-info spread-info-inline" wx:if="{{phase === 'idle'}}">
      <text class="spread-label">ç‰Œé˜µï¼š</text>
      <text class="spread-name-inline">{{selectedSpread.name}}</text>
      <text class="spread-desc-inline">ï¼ˆ{{requiredCardCount}}å¼ ç‰Œï¼‰</text>
    </view>

    <!-- é€‰ç‰Œè¿›åº¦æŒ‡ç¤ºå™¨ (é€‰ç‰Œé˜¶æ®µæ˜¾ç¤º) -->
    <view class="card-progress" wx:if="{{phase === 'selecting' || phase === 'spreading' || phase === 'selected'}}">
      <view class="progress-info">
        <text class="progress-label">{{selectedSpread.name}}</text>
        <text class="progress-count">
          å·²é€‰ {{selectedCardIndices.length}} / {{requiredCardCount}} å¼ 
        </text>
      </view>
      <view class="progress-slots">
        <view
          wx:for="{{requiredCardCount}}"
          wx:key="index"
          class="progress-slot {{index < selectedCardIndices.length ? 'filled' : ''}}"
        >
          <text class="slot-label">
            {{selectedSpread.positions[index] || 'ç‰Œ' + (index + 1)}}
          </text>
        </view>
      </view>
    </view>

    <!-- ========== æ ¸å¿ƒç‰Œé˜µäº¤äº’åŒºåŸŸ ========== -->
    <!-- æ´—ç‰ŒåŠ¨ç”»åŒºåŸŸ -->
    <view class="cards-area-wrapper" wx:if="{{phase === 'idle' || phase === 'shuffling'}}">
      <view class="shuffle-animation-container {{phase === 'idle' ? 'shuffle-static' : (shuffleFadeOut ? 'shuffle-gather' : 'shuffle-animating')}}">
        <view class="shuffle-deck {{phase === 'idle' ? 'is-idle' : 'is-shuffling'}}">
          <block wx:if="{{phase === 'idle'}}">
            <view
              wx:for="{{8}}"
              wx:key="index"
              class="shuffle-card shuffle-card-idle-{{index}} shuffle-card-static"
            >
              <image class="shuffle-card-img" src="{{cardBackUrl}}" mode="aspectFill" />
            </view>
          </block>
          <block wx:else>
            <view
              wx:for="{{28}}"
              wx:key="index"
              class="shuffle-card shuffle-card-pos-{{index}} {{shuffleFadeOut ? 'shuffle-card-gather' : ('shuffle-card-' + (index % 8))}}"
            >
              <image class="shuffle-card-img" src="{{cardBackUrl}}" mode="aspectFill" />
            </view>
          </block>
        </view>
        <view wx:if="{{phase !== 'idle'}}" class="shuffle-text">
          {{shuffleFadeOut ? 'âœ¨ ç‰Œé˜µå±•å¼€ä¸­...' : 'âœ¨ æ­£åœ¨æ´—ç‰Œ...'}}
        </view>
      </view>
    </view>

    <!-- æ‰‡å½¢ç‰Œé˜µäº¤äº’åŒºåŸŸ - 360åº¦è¿ç»­æ—‹è½¬ + æƒ¯æ€§æ»‘åŠ¨ -->
    <view class="cards-area-wrapper" wx:if="{{phase === 'spreading' || phase === 'selecting' || phase === 'selected'}}">
      <!-- æ‰‹åŠ¿æç¤º (é¦–æ¬¡è¿›å…¥é€‰ç‰Œé˜¶æ®µæ—¶æ˜¾ç¤º) -->
      <view class="gesture-hint" wx:if="{{phase === 'selecting' && remainingCardCount === requiredCardCount}}">
        <text>ğŸ‘† å·¦å³æ»‘åŠ¨æ—‹è½¬åœ†ç¯ Â· åŒæŒ‡ç¼©æ”¾ Â· ç‚¹å‡»é€‰ç‰Œ</text>
      </view>

      <view
        class="fan-container {{phase === 'selected' ? 'cards-fading' : ''}} {{isDragging ? 'is-dragging' : ''}} {{pendingConfirmIndex >= 0 ? 'has-pending-confirm' : ''}}"
        bindtouchstart="onFanTouchStart"
        bindtouchmove="onFanTouchMove"
        bindtouchend="onFanTouchEnd"
        bindtouchcancel="onFanTouchEnd"
        style="--fan-scale: {{fanScale}}; --card-offset-angle: {{cardOffsetAngle}}deg;"
      >
        <view class="fan-deck fan-deck-interactive" data-angle="{{cardOffsetAngle}}">
          <view
            wx:for="{{deckCards}}"
            wx:key="id"
            class="fan-card-item {{item.isSpread ? 'spread' : ''}} {{item.isChosen ? 'card-chosen' : ''}} {{item.isPendingConfirm ? 'card-pending-confirm' : ''}} {{phase === 'selected' && showFlyingCard && selectedCardIndex === index ? 'card-flying' : ''}} {{phase === 'selected' && showFlyingCard && selectedCardIndex !== index ? 'card-dimmed' : ''}}"
            style="--base-angle: {{item.angle}}deg; --x: {{item.x}}rpx; --y: {{item.y}}rpx; --z-index: {{item.zIndex}}; --delay: {{item.animationDelay}}ms;"
            bindtap="onFanCardTap"
            data-index="{{index}}"
          >
            <image class="fan-card-img" src="{{cardBackUrl}}" mode="aspectFill" />

            <!-- é€‰ä¸­é¡ºåºæ ‡è®° -->
            <view wx:if="{{item.isChosen && item.selectionOrder > 0}}" class="card-selected-badge">
              <text>{{item.selectionOrder}}</text>
            </view>

            <!-- å¾…ç¡®è®¤çŠ¶æ€ï¼šæ˜¾ç¤ºä½ç½®åç§° -->
            <view wx:if="{{item.isPendingConfirm}}" class="card-confirm-label">
              <text class="confirm-position-name">{{pendingPositionName}}</text>
            </view>
          </view>
        </view>

        <!-- å¾…ç¡®è®¤çŠ¶æ€çš„æ’¤é”€æŒ‰é’®åŒºåŸŸ -->
        <view wx:if="{{pendingConfirmIndex >= 0}}" class="confirm-buttons-container">
          <view class="confirm-buttons">
            <view class="confirm-btn cancel-btn" catchtap="cancelCardConfirm">
              <text>æ’¤é”€</text>
            </view>
          </view>
        </view>

        <!-- é€‰ç‰Œæç¤º - å·²éšè— -->
        <!-- <view class="select-hint" wx:if="{{(phase === 'selecting' || phase === 'selected') && pendingConfirmIndex < 0}}">
          <text wx:if="{{remainingCardCount > 0}}">
            âœ¨ è¿˜éœ€é€‰æ‹© {{remainingCardCount}} å¼ ç‰Œ
          </text>
          <text wx:else>âœ¨ ç‰Œå·²é€‰å®Œï¼Œæ­£åœ¨æ­ç¤º...</text>
        </view> -->
      </view>

      <!-- é£å‡ºæ”¾å¤§ -->
      <view wx:if="{{showFlyingCard && selectedCardIndex >= 0}}" class="flying-card-overlay">
        <view class="flying-card">
          <image class="flying-card-img" src="{{cardBackUrl}}" mode="aspectFill" />
        </view>
        <view class="flying-card-hint">ğŸ”® æ­£åœ¨æ­ç¤ºä½ çš„ç‰Œé¢...</view>
      </view>
    </view>

    <!-- å¼€å§‹æ´—ç‰ŒæŒ‰é’® -->
    <button
      wx:if="{{phase === 'idle'}}"
      class="btn-primary draw-btn"
      bindtap="startShuffle"
      disabled="{{!question}}"
    >
      å¼€å§‹æ´—ç‰Œ
    </button>
    <view wx:if="{{phase === 'idle'}}" class="ai-disclaimer">æœ¬å†…å®¹ç”±AIç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</view>

  </view> <!-- æœªæŠ½ç‰ŒçŠ¶æ€ End -->

  <!-- ========== å·²æŠ½ç‰Œç»“æœçŠ¶æ€ ========== -->
  <view wx:if="{{phase === 'result' || drawnCard}}" class="result-section">

    <view class="spread-result-header">
      <view class="spread-result-title">ğŸ”® {{selectedSpread.name}}</view>
      <view class="spread-result-count">å…± {{drawnCards.length || 1}} å¼ ç‰Œ</view>
    </view>

    <!-- å¤šå¼  -->
    <scroll-view
      wx:if="{{drawnCards.length > 1}}"
      class="cards-scroll"
      scroll-x="true"
      enhanced="{{true}}"
      show-scrollbar="{{false}}"
    >
      <view class="cards-result-row">
        <view
          wx:for="{{drawnCards}}"
          wx:key="_id"
          class="card-result-item card-reveal-animation"
          style="animation-delay: {{index * 150}}ms"
        >
          <view class="card-image-wrapper">
            <image class="card-image-small {{item.isReversed ? 'reversed' : ''}}" src="{{item.image}}" mode="aspectFit" />
            <view wx:if="{{item.isReversed}}" class="reverse-badge">é€†ä½</view>
          </view>

          <view class="card-info-row">
            <view class="card-position-label">{{item.position}}</view>
            <view class="card-name-small">{{item.name}}</view>
          </view>

          <view class="card-keywords-small">{{item.isReversed ? item.reversedKeywords : item.keywords}}</view>
        </view>
      </view>
    </scroll-view>

    <!-- å•å¼  -->
    <view wx:elif="{{drawnCard}}" class="card-result card-reveal-animation">

      <view class="card-image-wrapper">
        <image class="card-image {{drawnCard.isReversed ? 'reversed' : ''}}" src="{{drawnCard.image}}" mode="aspectFit" />
        <view wx:if="{{drawnCard.isReversed}}" class="reverse-badge">é€†ä½</view>
      </view>

      <view class="card-info-row">
        <view wx:if="{{selectedSpread.positions[0]}}" class="card-position-label">
          {{selectedSpread.positions[0]}}
        </view>
        <view class="card-name">{{drawnCard.name}}</view>
      </view>

      <view class="card-keywords">{{drawnCard.isReversed ? drawnCard.reversedKeywords : drawnCard.keywords}}</view>
    </view>

    <!-- ç‰Œé˜µä½ç½®è¯´æ˜ -->
    <view class="spread-info compact" wx:if="{{drawnCards.length > 1}}">
      <view class="spread-positions">
        <view wx:for="{{drawnCards}}" wx:key="_id" class="pos-chip">
          <text class="pos-index">{{index + 1}}</text>
          <text class="pos-label">{{item.position}}: {{item.name}}{{item.isReversed ? 'ï¼ˆé€†ä½ï¼‰' : ''}}</text>
        </view>
      </view>
    </view>

    <!-- é—®é¢˜å±•ç¤º -->
    <view class="question-section" wx:if="{{question}}">
      <view class="section-title">ğŸ’­ ä½ çš„é—®é¢˜</view>
      <view class="question-display">{{question}}</view>

      <button class="btn-primary" bindtap="getInterpretation" disabled="{{!question || loading}}">
        {{loading ? 'è§£è¯»ä¸­...' : 'è·å–è§£è¯»'}}
      </button>
      <view class="ai-disclaimer">æœ¬å†…å®¹ç”±AIç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</view>
    </view>

    <!-- å°å²›è§£è¯» -->
    <view wx:if="{{interpretationBlocks.length > 0}}" class="interpretation-section">
      <view class="section-title">âœ¦ å°å²›è§£è¯»</view>

      <view class="interpretation-blocks">
        <view
          wx:for="{{interpretationBlocks}}"
          wx:key="index"
          class="interpretation-block"
          style="animation-delay: {{index * 100}}ms"
        >
          <view class="block-title">{{item.title}}</view>
          <text class="block-content" user-select="{{true}}">{{item.content}}</text>
        </view>
      </view>
    </view>

    <!-- è€ç‰ˆæœ¬å…¼å®¹ -->
    <view wx:elif="{{interpretation}}" class="interpretation-section">
      <view class="section-title">âœ¦ å°å²›è§£è¯»</view>
      <text class="interpretation-content" user-select="{{true}}">{{interpretation}}</text>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="btn-secondary" bindtap="resetDraw">é‡æ–°æŠ½å–</button>
      <navigator url="/pages/tarot/history/history" class="btn-secondary nav-btn">
        <text>æŸ¥çœ‹å†å²</text>
      </navigator>
    </view>

  </view> <!-- result-section END -->

</view>
