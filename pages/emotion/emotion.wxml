<!--pages/emotion/emotion.wxml-->
<view class="container emotion-container">
  <!-- é¡¶éƒ¨ç²¾ç®€ Hero -->
  <view class="hero-card">
    <view class="hero-content">
      <view class="quote-text">{{emotionQuote.content}}</view>
      <view class="quote-author" wx:if="{{emotionQuote.author}}">â€” {{emotionQuote.author}}</view>
      <view class="quote-refresh" bindtap="refreshEmotionQuote">
        <text class="refresh-icon">â†»</text>
      </view>
    </view>
  </view>

  <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
  <view class="progress-bar">
    <view class="progress-fill" style="width: {{completionScore / completionTotal * 100}}%"></view>
    <view class="progress-text">{{completionScore}}/{{completionTotal}}</view>
  </view>

  <!-- æƒ…ç»ªé€‰æ‹© -->
  <view class="section emotion-select-section">
    <view class="section-title">æ­¤åˆ»æ„Ÿå—å¦‚ä½•ï¼Ÿ</view>
    <view class="emotion-grid">
      <view
        wx:for="{{showAllEmotions ? emotions : emotions.slice(0, 6)}}"
        wx:key="id"
        class="emotion-item {{selectedEmotion === item.id ? 'selected' : ''}}"
        bindtap="selectEmotion"
        data-id="{{item.id}}">
        <view class="emotion-icon">{{item.icon}}</view>
        <view class="emotion-name">{{item.name}}</view>
      </view>
    </view>
    <view class="show-more-emotions" bindtap="toggleAllEmotions" wx:if="{{emotions.length > 6}}">
      <text>{{showAllEmotions ? 'æ”¶èµ·' : 'æ›´å¤šæƒ…ç»ª'}}</text>
      <text class="arrow">{{showAllEmotions ? 'â†‘' : 'â†“'}}</text>
    </view>
  </view>

  <!-- æƒ…ç»ªåé¦ˆ -->
  <view wx:if="{{emotionFeedback}}" class="emotion-feedback">
    <view class="feedback-text">{{emotionFeedback}}</view>
  </view>

  <!-- ä»Šæ—¥èƒ½é‡æŒ‡æ•° -->
  <view class="section energy-section">
    <view class="section-title">ä»Šæ—¥èƒ½é‡</view>
    <view class="energy-stars">
      <view
        wx:for="{{[1,2,3,4,5]}}"
        wx:key="*this"
        class="star-item {{energyLevel >= item ? 'active' : ''}}"
        bindtap="setEnergyLevel"
        data-level="{{item}}">
        <text class="star-icon">{{energyLevel >= item ? 'â­' : 'â˜†'}}</text>
      </view>
    </view>
    <view class="energy-hint" wx:if="{{energyLevel > 0}}">
      <text wx:if="{{energyLevel === 1}}">éœ€è¦å¥½å¥½ä¼‘æ¯</text>
      <text wx:elif="{{energyLevel === 2}}">æ…¢æ…¢æ¥å°±å¥½</text>
      <text wx:elif="{{energyLevel === 3}}">çŠ¶æ€ä¸é”™</text>
      <text wx:elif="{{energyLevel === 4}}">èƒ½é‡æ»¡æ»¡</text>
      <text wx:elif="{{energyLevel === 5}}">è¶…çº§å……æ²›</text>
    </view>
  </view>

  <!-- ä»Šæ—¥äº®ç‚¹ (Tab åˆ‡æ¢: æ„Ÿæ©/æˆå°±) -->
  <view class="section highlights-section">
    <view class="section-title">ä»Šæ—¥äº®ç‚¹</view>
    <view class="tab-bar">
      <view class="tab {{highlightTab === 'gratitude' ? 'active' : ''}}" bindtap="switchHighlightTab" data-tab="gratitude">æ„Ÿæ©</view>
      <view class="tab {{highlightTab === 'success' ? 'active' : ''}}" bindtap="switchHighlightTab" data-tab="success">æˆå°±</view>
    </view>

    <!-- æ„Ÿæ©å†…å®¹ -->
    <view class="tab-content" wx:if="{{highlightTab === 'gratitude'}}">
      <scroll-view scroll-x="true" class="template-scroll" show-scrollbar="{{false}}">
        <view class="template-buttons">
          <view
            wx:for="{{gratitudeTemplates}}"
            wx:key="id"
            class="template-btn-small"
            bindtap="insertGratitudeTemplate"
            data-text="{{item.text}}"
            hover-class="template-btn-hover">
            <text class="template-icon-small">{{item.icon}}</text>
            <text class="template-label-small">{{item.label}}</text>
          </view>
        </view>
      </scroll-view>

      <view class="input-list">
        <view
          wx:for="{{gratitudeItems}}"
          wx:key="index"
          wx:if="{{index === 0 || (index === 1 && showMoreGratitude) || (index === 2 && (showThirdGratitude || item))}}"
          class="input-item {{gratitudeFocusStates[index] ? 'focused' : ''}}">
          <view class="item-number">{{index + 1}}</view>
          <view class="item-content">
            <textarea
              class="item-textarea"
              placeholder="{{index === 0 ? 'ä»Šå¤©æˆ‘æ„Ÿæ¿€çš„æ˜¯â€¦' : index === 1 ? 'è®©æˆ‘å¾®ç¬‘çš„ç¬é—´â€¦' : 'æ¸©æš–æˆ‘çš„äººæˆ–äº‹â€¦'}}"
              placeholder-class="input-placeholder"
              value="{{item}}"
              bindinput="onGratitudeInput"
              bindfocus="onGratitudeFocus"
              bindblur="onGratitudeBlur"
              data-index="{{index}}"
              maxlength="{{maxTextLength}}"
              auto-height="{{true}}"
            />
          </view>
        </view>
      </view>
      <view class="list-toggle" bindtap="toggleGratitudeList" wx:if="{{!showThirdGratitude && !gratitudeItems[2]}}">
        <text>+ æ·»åŠ æ›´å¤š</text>
      </view>
    </view>

    <!-- æˆå°±å†…å®¹ -->
    <view class="tab-content" wx:if="{{highlightTab === 'success'}}">
      <scroll-view scroll-x="true" class="template-scroll" show-scrollbar="{{false}}">
        <view class="template-buttons">
          <view
            wx:for="{{successTemplates}}"
            wx:key="id"
            class="template-btn-small"
            bindtap="insertSuccessTemplate"
            data-text="{{item.text}}"
            hover-class="template-btn-hover">
            <text class="template-icon-small">{{item.icon}}</text>
            <text class="template-label-small">{{item.label}}</text>
          </view>
        </view>
      </scroll-view>

      <view class="input-list">
        <view
          wx:for="{{successItems}}"
          wx:key="index"
          wx:if="{{index === 0 || (index === 1 && showMoreSuccess) || (index === 2 && (showThirdSuccess || item))}}"
          class="input-item {{successFocusStates[index] ? 'focused' : ''}}">
          <view class="item-number">{{index + 1}}</view>
          <view class="item-content">
            <textarea
              class="item-textarea"
              placeholder="{{index === 0 ? 'æˆ‘åšå¾—å¥½çš„äº‹â€¦' : index === 1 ? 'æˆ‘åšæŒçš„ä¸€ä»¶äº‹â€¦' : 'æˆ‘è¿›æ­¥çš„åœ°æ–¹â€¦'}}"
              placeholder-class="input-placeholder"
              value="{{item}}"
              bindinput="onSuccessInput"
              bindfocus="onSuccessFocus"
              bindblur="onSuccessBlur"
              data-index="{{index}}"
              maxlength="{{maxTextLength}}"
              auto-height="{{true}}"
            />
          </view>
        </view>
      </view>
      <view class="list-toggle" bindtap="toggleSuccessList" wx:if="{{!showThirdSuccess && !successItems[2]}}">
        <text>+ æ·»åŠ æ›´å¤š</text>
      </view>
    </view>
  </view>

  <!-- è‡ªç”±è¾“å…¥åŒº -->
  <view class="section free-text-section">
    <view class="section-title">è‡ªç”±è®°å½•</view>
    <textarea
      class="emotion-textarea"
      placeholder="è¿˜æœ‰ä»€ä¹ˆæƒ³è¯´çš„..."
      value="{{description}}"
      bindinput="onDescriptionInput"
      maxlength="500"
      placeholder-class="textarea-placeholder"
    ></textarea>
    <view class="char-count" wx:if="{{description.length > 0}}">{{description.length}}/500</view>
  </view>

  <!-- æ ‡ç­¾é€‰æ‹© -->
  <view class="section tags-section">
    <view class="section-title">æ·»åŠ æ ‡ç­¾</view>
    <view class="tag-list">
      <view
        wx:for="{{tags}}"
        wx:key="id"
        class="tag-item {{selectedTags.includes(item.id) ? 'selected' : ''}}"
        catchtap="toggleTag"
        data-id="{{item.id}}"
        hover-class="tag-item-hover">
        <text class="tag-icon">{{item.icon}}</text>
        <text class="tag-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- AI æ¸©æŸ”å›å£° (ç®€åŒ–ä¸ºå¯æŠ˜å åŒºåŸŸ) -->
  <view class="section ai-section-collapsed" wx:if="{{!aiReply && !aiLoading}}">
    <view class="ai-trigger" bindtap="getAIReflection" wx:if="{{selectedEmotion || description}}">
      <text class="ai-trigger-icon">ğŸŒ™</text>
      <text class="ai-trigger-text">è·å–æ¸©æŸ”å›å£°</text>
    </view>
    <view class="ai-disclaimer" wx:if="{{selectedEmotion || description}}">AIç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</view>
  </view>

  <!-- AI å›å¤å†…å®¹ -->
  <view wx:if="{{aiReply || aiLoading}}" class="section ai-section">
    <view class="ai-header">
      <view class="ai-title">æ¸©æŸ”å›å£°</view>
      <view class="ai-reask" bindtap="getAIReflection">â†»</view>
    </view>
    <view wx:if="{{aiLoading && !aiReply}}" class="ai-loading">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    <view wx:if="{{aiReply}}" class="ai-content">{{aiReply}}</view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ¡ -->
  <view class="action-bar">
    <button class="btn-secondary" bindtap="viewHistory">å†å²</button>
    <button class="btn-primary btn-save" bindtap="saveEmotion" disabled="{{!selectedEmotion}}">
      {{selectedEmotion ? 'ä¿å­˜è®°å½•' : 'è¯·å…ˆé€‰æ‹©æƒ…ç»ª'}}
    </button>
  </view>
</view>

<!-- å…¨å±€æ‚¬æµ®éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
<audio-float />
