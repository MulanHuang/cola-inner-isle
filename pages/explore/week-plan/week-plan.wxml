<!--pages/explore/week-plan/week-plan.wxml-->
<view class="container week-plan-container">
  <!-- 顶部导航 -->
  <view class="header-bar">
    <view class="back-btn" bindtap="goBack">
      <view class="back-icon"></view>
    </view>
    <view class="header-title">周计划表</view>
    <view class="history-btn" bindtap="viewHistory">
      <text class="history-icon">📅</text>
    </view>
  </view>

  <!-- 顶部信息栏 -->
  <view class="top-info-bar">
    <text class="top-info-text">{{currentYear}} ｜ 周计划 ｜ {{currentMonth}}月 · 第{{weekOfMonth}}周</text>
  </view>

  <!-- 周切换导航 -->
  <view class="week-nav">
    <view class="nav-btn" bindtap="prevWeek">
      <text>‹</text>
    </view>
    <view class="week-display">{{weekRangeDisplay}}</view>
    <view class="nav-btn" bindtap="nextWeek">
      <text>›</text>
    </view>
  </view>

  <!-- 纸质手账主体 -->
  <view class="notebook-wrapper">
    <!-- 主内容区 - 左右分栏 -->
    <view class="main-content">
      <!-- 左侧栏 - 周任务分解 -->
      <view class="left-column">
        <view class="section-header task-header">
          <text class="section-title">周任务分解</text>
        </view>
        
        <!-- 按天分组的任务列表 -->
        <view wx:for="{{weekDays}}" wx:key="index" class="day-task-group">
          <view class="day-label" style="background: {{item.color}};">
            <text class="day-label-text">{{item.label}}</text>
          </view>
          <view class="day-tasks">
            <view class="list-items">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:for-index="taskIndex" wx:key="taskIndex" class="list-row task-row">
                <view class="task-dot" style="background: {{item.dotColor}};"></view>
                <view class="list-checkbox {{task.completed ? 'checked' : ''}}"
                      bindtap="toggleDayTaskComplete"
                      data-day-index="{{index}}"
                      data-task-index="{{taskIndex}}">
                  <text wx:if="{{task.completed}}" class="check-icon">✓</text>
                </view>
                <view class="list-input-wrapper">
                  <textarea class="list-input {{task.completed ? 'completed' : ''}}"
                            placeholder="{{taskIndex === 0 && item.tasks.length === 1 ? '写下来就已经很好了' : ''}}"
                            placeholder-class="input-placeholder"
                            value="{{task.text}}"
                            bindinput="onDayTaskInput"
                            data-day-index="{{index}}"
                            data-task-index="{{taskIndex}}"
                            auto-height
                            maxlength="-1" />
                  <view wx:if="{{task.completed}}" class="strikethrough-line"></view>
                </view>
                <view wx:if="{{item.tasks.length > 1}}" class="remove-btn" bindtap="removeDayTask" data-day-index="{{index}}" data-task-index="{{taskIndex}}">×</view>
              </view>
            </view>
            <view class="add-row add-task-row" bindtap="addDayTask" data-day-index="{{index}}">+ 添加</view>
          </view>
        </view>
      </view>

      <!-- 右侧栏 -->
      <view class="right-column">
        <!-- 周日历 -->
        <view class="calendar-section">
          <view class="calendar-header">
            <text class="calendar-month">{{currentMonth}}月</text>
            <text class="calendar-week-num">第{{weekOfMonth}}周</text>
          </view>
          <view class="mini-calendar">
            <view class="cal-weekdays">
              <text wx:for="{{calWeekDays}}" wx:key="*this" class="cal-weekday">{{item}}</text>
            </view>
            <view class="cal-days-grid">
              <view wx:for="{{calendarDays}}" wx:key="index"
                    class="cal-day {{item.isCurrentWeek ? 'current-week' : ''}} {{item.hasDailyRecord ? 'has-record' : ''}} {{item.isToday ? 'is-today' : ''}}"
                    bindtap="{{item.hasDailyRecord ? 'onCalDayTap' : ''}}"
                    data-date-str="{{item.dateStr}}"
                    data-has-record="{{item.hasDailyRecord}}">
                <text wx:if="{{item.day}}" class="cal-day-num">{{item.day}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 关键事件 -->
        <view class="key-events-section">
          <view class="section-header-right">
            <text class="section-title-right">关键事件</text>
          </view>
          <view class="list-items">
            <view wx:for="{{keyEvents}}" wx:key="index" class="list-row">
              <view class="list-checkbox {{item.completed ? 'checked' : ''}}"
                    bindtap="toggleKeyEventComplete"
                    data-index="{{index}}">
                <text wx:if="{{item.completed}}" class="check-icon">✓</text>
              </view>
              <view class="list-input-wrapper">
                <textarea class="list-input {{item.completed ? 'completed' : ''}}"
                          placeholder="{{index === 0 && keyEvents.length === 1 ? '哪怕只有一件' : ''}}"
                          placeholder-class="input-placeholder"
                          value="{{item.text}}"
                          bindinput="onKeyEventInput"
                          data-index="{{index}}"
                          auto-height
                          maxlength="-1" />
                <view wx:if="{{item.completed}}" class="strikethrough-line"></view>
              </view>
              <view wx:if="{{keyEvents.length > 1}}" class="remove-btn" bindtap="removeKeyEvent" data-index="{{index}}">×</view>
            </view>
          </view>
          <view class="add-row" bindtap="addKeyEvent">+ 添加</view>
        </view>

        <!-- 上周复盘 -->
        <view class="review-section">
          <view class="section-header-right">
            <text class="section-title-right">上周复盘</text>
          </view>
          <!-- 上周每日记录数量提示（联动功能） -->
          <view wx:if="{{lastWeekDailyCount > 0}}" class="review-hint">
            <text class="review-hint-text">上周，你为自己留下了 {{lastWeekDailyCount}} 条每日记录</text>
          </view>
          <view class="text-area-wrapper">
            <textarea class="review-textarea"
                      placeholder="上周有哪些让你记得的事情？"
                      placeholder-class="input-placeholder"
                      value="{{lastWeekReview}}"
                      bindinput="onLastWeekReviewInput"
                      maxlength="-1"
                      auto-height />
          </view>
        </view>

        <!-- 本周待提升 -->
        <view class="improve-section">
          <view class="section-header-right">
            <text class="section-title-right">本周待提升</text>
          </view>
          <view class="text-area-wrapper">
            <textarea class="improve-textarea"
                      placeholder="这一周，你想对自己温柔一点的地方。"
                      placeholder-class="input-placeholder"
                      value="{{weekImprovement}}"
                      bindinput="onWeekImprovementInput"
                      maxlength="-1"
                      auto-height />
          </view>
        </view>

        <!-- 本周每日记录入口（联动功能） -->
        <view wx:if="{{thisWeekDailyRecords.length > 0}}" class="week-daily-section" bindtap="showWeekDailySheet">
          <text class="week-daily-title">查看本周的每日记录</text>
          <text class="week-daily-count">{{thisWeekDailyRecords.length}} 条</text>
          <text class="week-daily-arrow">›</text>
        </view>

        <!-- 🌱 AI 成长教练模块（必须在复盘模块下方） -->
        <view class="ai-coach-section">
          <view class="ai-coach-header">
            <text class="ai-coach-title">🌱 和成长教练一起回顾这一周</text>
          </view>
          <view class="ai-coach-desc">
            <text class="ai-coach-desc-line">不是对错判断，</text>
            <text class="ai-coach-desc-line">只是换一个角度看看你正在如何生活。</text>
          </view>
          <button class="ai-coach-btn" bindtap="triggerWeeklyAICoach" disabled="{{aiCoachLoading}}">
            <text wx:if="{{!aiCoachLoading}}">换一个视角看看这一周</text>
            <text wx:else>正在整理思绪...</text>
          </button>
          <view class="ai-coach-tip">AI生成，仅供参考</view>
        </view>

        <!-- AI 教练输出卡片（可折叠） -->
        <view wx:if="{{aiCoachResponse}}" class="ai-coach-result">
          <view class="ai-result-header" bindtap="toggleAICoachResult">
            <text class="ai-result-label">🌿 成长教练的视角</text>
            <text class="ai-result-toggle">{{aiCoachResultExpanded ? '收起' : '展开'}}</text>
          </view>
          <view class="ai-result-content {{aiCoachResultExpanded ? 'expanded' : 'collapsed'}}">
            <text class="ai-result-text">{{aiCoachResponse}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 本周每日记录列表弹层（联动功能） -->
  <view class="daily-sheet {{showWeekDailySheet ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="daily-sheet-mask" bindtap="hideWeekDailySheet"></view>
    <view class="daily-sheet-content">
      <view class="daily-sheet-header">
        <text class="daily-sheet-title">本周的每日记录</text>
        <view class="daily-sheet-close" bindtap="hideWeekDailySheet">×</view>
      </view>
      <scroll-view class="daily-sheet-list" scroll-y>
        <view wx:for="{{thisWeekDailyRecords}}" wx:key="date" class="daily-item" bindtap="goToDailyDetail" data-date="{{item.date}}">
          <text class="daily-item-date">{{item.displayDate}}</text>
          <text class="daily-item-preview">{{item.preview}}</text>
          <text class="daily-item-arrow">›</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 底部操作区 -->
  <view class="action-bar">
    <button class="btn-save" bindtap="saveRecord">保存本周计划</button>
  </view>
</view>
