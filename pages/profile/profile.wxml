<!--pages/profile/profile.wxml-->
<!-- 自定义导航栏 -->
<view class="custom-navbar" style="padding-top: {{statusBarHeight}}px;">
  <view class="navbar-content">
    <image class="navbar-logo" src="/images/logo.svg" mode="aspectFit"></image>
    <view class="navbar-title">可乐心岛</view>
  </view>
</view>

<view class="profile-container page-with-custom-navbar" style="padding-top: {{navBarHeight}}px;">
  <!-- 卡片一：头像 + 名称 + 数据统计 -->
  <view class="card hero-card">
    <view class="hero-wave wave-one"></view>
    <view class="hero-wave wave-two"></view>
    <view class="hero-body">
      <!-- 头像选择按钮：点击显示选择菜单 -->
      <view class="avatar-shell avatar-btn" bindtap="showAvatarActionSheet">
        <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
        <view class="avatar-edit-hint">换</view>
      </view>
      <view class="hero-text">
        <view class="hero-name-row">
          <!-- 昵称输入框：type=nickname 会显示微信昵称键盘 -->
          <input type="nickname"
                 class="hero-name hero-name-input"
                 value="{{userInfo.name}}"
                 placeholder="点击设置昵称"
                 placeholder-class="hero-name-placeholder"
                 bindblur="onNicknameBlur"
                 bindinput="onNicknameInput"
                 maxlength="20" />
        </view>
        <view class="hero-meta-row">
          <!-- 星座展示：根据生日自动计算 -->
          <view class="hero-zodiac" wx:if="{{userZodiac}}" bindtap="goToProfileInfo">
            <text class="zodiac-emoji">{{userZodiac.emoji}}</text>
            <text class="zodiac-name">{{userZodiac.name}}</text>
          </view>
          <view class="hero-chip ghost" bindtap="goToProfileInfo">完善档案</view>
        </view>
        <view class="hero-sub hero-quote">
          <text class="quote-mark">“</text>
          <text class="quote-content">{{dailyAffirmation || '保持这份热情，你很闪耀 👋'}}</text>
          <text class="quote-mark">”</text>
        </view>
      </view>
    </view>
    <!-- 数据统计区 -->
    <view class="hero-stats">
      <view class="stat-item" bindtap="goToMeditationHistory">
        <text class="stat-value">{{stats.meditationCount || 0}}</text>
        <text class="stat-label">次冥想</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item" bindtap="goToTarotHistory">
        <text class="stat-value">{{stats.tarotCount || 0}}</text>
        <text class="stat-label">次塔罗</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-value">{{totalCheckinDays || 0}}</text>
        <text class="stat-label">天签到</text>
      </view>
    </view>
  </view>

  <!-- 卡片二：每日签到 -->
  <view class="card checkin-card">
    <view class="checkin-header">
      <view class="card-title">每日签到</view>
      <view class="checkin-stats">本周 {{weekCheckinCount}}/7 天</view>
    </view>
    <view class="checkin-track">
      <view
        wx:for="{{weekDays}}"
        wx:key="date"
        class="checkin-dot {{item.checked ? 'checked' : ''}} {{item.isToday ? 'today' : ''}} {{item.isPast && !item.checked ? 'missed' : ''}}"
      >
        <text wx:if="{{item.isToday}}">{{item.checked ? '✓' : '今'}}</text>
        <text wx:elif="{{item.checked}}">✓</text>
        <text wx:else>{{item.label}}</text>
      </view>
    </view>
    <view
      class="checkin-btn {{!todayChecked && !checkinLoading ? 'shimmer' : ''}} {{todayChecked ? 'checked' : ''}} {{checkinLoading ? 'loading' : ''}}"
      bindtap="handleCheckinTap"
    >
      {{checkinLoading ? '签到中...' : (todayChecked ? '今日已签到 ✓' : '立即签到')}}
    </view>
  </view>

  <!-- 卡片三：我的内容 -->
  <view class="card content-card">
    <view class="card-title">我的内容</view>
    <view class="content-grid">
      <view class="content-chip primary" bindtap="goToProfileInfo">
        <text class="chip-icon">🪪</text>
        <text class="chip-text">个人档案</text>
      </view>
      <view class="content-chip primary" bindtap="goToMeditationHistory">
        <text class="chip-icon">🧘</text>
        <text class="chip-text">冥想记录</text>
      </view>
      <view class="content-chip primary" bindtap="goToTarotHistory">
        <text class="chip-icon">🔮</text>
        <text class="chip-text">塔罗历史</text>
      </view>
      <view class="content-chip" bindtap="goToExplore">
        <text class="chip-icon">🌱</text>
        <text class="chip-text">自我探索</text>
      </view>
      <view class="content-chip primary" bindtap="goToEmotionHistory">
        <text class="chip-icon">📝</text>
        <text class="chip-text">情绪历史</text>
      </view>
      <view class="content-chip" bindtap="showAbout">
        <text class="chip-icon">ℹ️</text>
        <text class="chip-text">关于我们</text>
      </view>
    </view>
  </view>

  <!-- 页面底部信息 -->
  <view class="page-footer">
    <text class="footer-text">可乐心岛 v1.0.0</text>
    <text class="footer-sub">你的心灵陪伴者 💖</text>
  </view>
</view>

<!-- 全局悬浮音乐控制按钮 -->
<audio-float />

<!-- 隐私协议授权弹窗 -->
<view class="privacy-popup-mask" wx:if="{{showPrivacyPopup}}" catchtouchmove="preventTouchMove">
  <view class="privacy-popup">
    <view class="privacy-popup-title">隐私保护提示</view>
    <view class="privacy-popup-content">
      <text>为了更好地为您提供服务，我们需要获取您的相关权限。请阅读并同意</text>
      <text class="privacy-link" bindtap="openPrivacyContract">《用户隐私保护指引》</text>
    </view>
    <view class="privacy-popup-buttons">
      <button class="privacy-btn privacy-btn-cancel" bindtap="handleDisagreePrivacy">拒绝</button>
      <button class="privacy-btn privacy-btn-confirm" id="agree-btn" open-type="agreePrivacyAuthorization" bindagreeprivacyauthorization="handleAgreePrivacy">同意</button>
    </view>
  </view>
</view>
