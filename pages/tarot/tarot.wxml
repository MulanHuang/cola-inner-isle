<!--pages/tarot/tarot.wxml-->
<!-- ============================================================ -->
<!-- å¡”ç½—ç‰ŒæŠ½å–é¡µé¢ - ä¸“ä¸šçº§äº¤äº’ä¸åŠ¨ç”»                              -->
<!-- é˜¶æ®µæµç¨‹: idle â†’ shuffling â†’ spreading â†’ selecting â†’ selected â†’ result -->
<!-- å‡çº§ç‰ˆ: ç¥ç§˜ã€æ¸©æŸ”ã€çµæ€§ã€æ²»æ„ˆã€iOSçº§åˆ«è´¨æ„Ÿ                      -->
<!-- ============================================================ -->
<view class="container tarot-container phase-{{phase}}">

<!-- æ˜Ÿå…‰ç²’å­æ•ˆæœå±‚ - ç»†è…»è½»æŸ” -->
<view class="stars-container">
  <view class="star star-1"></view>
  <view class="star star-2"></view>
  <view class="star star-3"></view>
  <view class="star star-4"></view>
  <view class="star star-5"></view>
  <view class="star star-6"></view>
  <view class="star star-7"></view>
  <view class="star star-8"></view>
</view>

<!-- ========== æœªæŠ½ç‰ŒçŠ¶æ€ (idle/shuffling/spreading/selecting/selected) ========== -->
<view wx:if="{{phase !== 'result' && !drawnCard}}" class="draw-section">

  <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
  <view class="header-row">
    <view class="tarot-title">ğŸ”® æ¯æ—¥å¡”ç½—</view>
    <view class="header-actions">
      <view class="pill">ä»Šæ—¥ {{todayCount}}/100</view>
      <navigator url="/pages/tarot/history/history" class="history-link">
        <text>ğŸ“– å†å²è®°å½•</text>
      </navigator>
    </view>
  </view>
  <view class="tarot-subtitle">å…ˆå†™ä¸‹ä½ çš„é—®é¢˜ï¼Œå°å²›ä¼šè‡ªåŠ¨æŒ‘é€‰åˆé€‚çš„ç‰Œé˜µå¹¶é«˜äº®æŒ‡å¼•</view>

  <!-- æµç¨‹æ­¥éª¤æŒ‡ç¤ºå™¨ -->
  <view class="flow-steps">
    <view class="step-item {{phase === 'idle' ? 'active' : 'done'}}">1 Â· æé—®</view>
    <view class="step-item {{phase === 'selecting' || phase === 'selected' ? 'active' : (phase === 'shuffling' || phase === 'spreading' ? 'current' : '')}}">2 Â· é€‰ç‰Œ</view>
    <view class="step-item {{phase === 'selected' ? 'active' : ''}}">3 Â· æŠ½ç‰Œ</view>
  </view>

  <!-- é—®é¢˜è¾“å…¥åŒºåŸŸ (ä»…åœ¨ idle é˜¶æ®µå¯ç¼–è¾‘ï¼Œç´§å‡‘ç‰ˆ) -->
  <view class="question-section question-section-compact" wx:if="{{phase === 'idle'}}">
    <view class="section-title">ğŸ’­ ä½ æƒ³é—®ä»€ä¹ˆï¼Ÿ</view>
    <scroll-view class="template-scroll" scroll-x="true">
      <view
        class="template-chip"
        wx:for="{{questionTemplates}}"
        wx:key="index"
        bindtap="selectTemplate"
        data-text="{{item}}"
      >
        {{item}}
      </view>
    </scroll-view>
    <textarea
      class="question-input question-input-compact"
      placeholder="å†™ä¸‹ä½ çš„é—®é¢˜ï¼Œå°å²›å¸®ä½ é€‰ç‰Œé˜µ"
      value="{{question}}"
      bindinput="onQuestionInput"
      maxlength="200"
    ></textarea>
    <view class="char-count">{{question.length}}/200</view>
  </view>

  <!-- ç‰Œé˜µä¿¡æ¯ (æ´—ç‰Œåéšè—ï¼Œç´§å‡‘ç‰ˆ) -->
  <view class="spread-info spread-info-inline" wx:if="{{phase === 'idle'}}">
    <text class="spread-label">ç‰Œé˜µï¼š</text>
    <text class="spread-name-inline">{{selectedSpread.name}}</text>
    <text class="spread-desc-inline">ï¼ˆ{{requiredCardCount}}å¼ ç‰Œï¼‰</text>
  </view>

  <!-- é€‰ç‰Œè¿›åº¦æŒ‡ç¤ºå™¨ (é€‰ç‰Œé˜¶æ®µæ˜¾ç¤º) -->
  <view class="card-progress" wx:if="{{phase === 'selecting' || phase === 'spreading' || phase === 'selected'}}">
    <view class="progress-info">
      <text class="progress-label">{{selectedSpread.name}}</text>
      <text class="progress-count">å·²é€‰ {{selectedCardIndices.length}} / {{requiredCardCount}} å¼ </text>
    </view>
    <view class="progress-slots">
      <view
        wx:for="{{requiredCardCount}}"
        wx:key="index"
        class="progress-slot {{index < selectedCardIndices.length ? 'filled' : ''}}"
      >
        <text class="slot-label">
          {{selectedSpread.positions[index] || 'ç‰Œ' + (index + 1)}}
        </text>
      </view>
    </view>
  </view>

  <!-- ========== æ ¸å¿ƒç‰Œé˜µäº¤äº’åŒºåŸŸ ========== -->
  <!-- æ´—ç‰ŒåŠ¨ç”»åŒºåŸŸ (idleæ—¶é™æ€é¢„è§ˆï¼Œshufflingæ—¶æ’­æ”¾åŠ¨ç”»ï¼Œç»“æŸæ—¶æ·¡å‡º) -->
  <view class="cards-area-wrapper" wx:if="{{phase === 'idle' || phase === 'shuffling'}}">
    <view class="shuffle-animation-container {{phase === 'idle' ? 'shuffle-static' : (shuffleFadeOut ? 'shuffle-fade-out' : 'shuffle-animating')}}">
      <view class="shuffle-deck">
        <!-- 8å¼ ç‰Œï¼šidleæ—¶é™æ€æ‘†æ”¾ï¼Œshufflingæ—¶æ’­æ”¾åŠ¨ç”» -->
        <view
          wx:for="{{8}}"
          wx:key="index"
          class="shuffle-card {{phase === 'shuffling' ? 'shuffle-card-' + index : 'shuffle-card-static'}}"
        >
          <image class="shuffle-card-img" src="{{cardBackUrl}}" mode="aspectFill" />
        </view>
      </view>
      <view class="shuffle-text">
        {{phase === 'idle' ? 'ğŸƒ å‡†å¤‡å¥½ä½ çš„é—®é¢˜ï¼Œå¼€å§‹æ´—ç‰Œ' : (shuffleFadeOut ? 'âœ¨ ç‰Œé˜µå±•å¼€ä¸­...' : 'âœ¨ æ­£åœ¨æ´—ç‰Œ...')}}
      </view>
    </view>
  </view>

  <!-- æ‰‡å½¢ç‰Œé˜µäº¤äº’åŒºåŸŸ (spreading/selecting/selected é˜¶æ®µ) -->
  <view
    class="cards-area-wrapper"
    wx:if="{{phase === 'spreading' || phase === 'selecting' || phase === 'selected'}}"
  >
    <view class="fan-container {{phase === 'selected' ? 'cards-fading' : ''}}">
      <!-- æ‰‡å½¢ç‰Œé˜µ -->
      <view class="fan-deck">
        <view
          wx:for="{{deckCards}}"
          wx:key="id"
          class="fan-card-item {{item.isSpread ? 'spread' : ''}} {{item.isChosen ? 'card-chosen' : ''}} {{phase === 'selected' && showFlyingCard && selectedCardIndex === index ? 'card-flying' : ''}} {{phase === 'selected' && showFlyingCard && selectedCardIndex !== index ? 'card-dimmed' : ''}}"
          style="--angle: {{item.angle}}deg; --x: {{item.x}}rpx; --y: {{item.y}}rpx; --z-index: {{item.zIndex}}; --delay: {{item.animationDelay}}ms;"
          bindtap="onFanCardTap"
          data-index="{{index}}"
        >
          <image class="fan-card-img" src="{{cardBackUrl}}" mode="aspectFill" />
          <!-- å·²é€‰ä¸­é¡ºåºæ ‡è®° - ä»…å½“è¯¥ç‰Œè¢«é€‰ä¸­æ—¶æ˜¾ç¤º -->
          <view
            wx:if="{{item.isChosen && item.selectionOrder > 0}}"
            class="card-selected-badge"
          >
            <text>{{item.selectionOrder}}</text>
          </view>
        </view>
      </view>

      <!-- é€‰ç‰Œæç¤º -->
      <view class="select-hint" wx:if="{{phase === 'selecting' || phase === 'selected'}}">
        <text wx:if="{{remainingCardCount === requiredCardCount}}">
          âœ¨ è¯·è·Ÿéšç›´è§‰ï¼Œé€‰æ‹© {{requiredCardCount}} å¼ ç‰Œ
        </text>
        <text wx:elif="{{remainingCardCount > 0}}">
          âœ¨ è¿˜éœ€é€‰æ‹© {{remainingCardCount}} å¼ ç‰Œ
        </text>
        <text wx:else>
          âœ¨ ç‰Œå·²é€‰å®Œï¼Œæ­£åœ¨æ­ç¤º...
        </text>
      </view>
    </view>

    <!-- é£å‡ºæ”¾å¤§çš„é€‰ä¸­ç‰Œï¼ˆå¯ç”¨äºé¢å¤–å¼ºè°ƒæˆ–åšé®ç½©ï¼‰ -->
    <view
      wx:if="{{showFlyingCard && selectedCardIndex >= 0}}"
      class="flying-card-overlay"
    >
      <view class="flying-card">
        <image class="flying-card-img" src="{{cardBackUrl}}" mode="aspectFill" />
      </view>
      <view class="flying-card-hint">ğŸ”® æ­£åœ¨æ­ç¤ºä½ çš„ç‰Œé¢...</view>
    </view>
  </view>

  <!-- å¼€å§‹æ´—ç‰ŒæŒ‰é’® (ä»… idle é˜¶æ®µæ˜¾ç¤º) -->
  <button
    wx:if="{{phase === 'idle'}}"
    class="btn-primary draw-btn"
    bindtap="startShuffle"
    disabled="{{!question}}"
  >
    å¼€å§‹æ´—ç‰Œ
  </button>

</view>

<!-- ========== å·²æŠ½ç‰Œç»“æœçŠ¶æ€ (result) ========== -->
<view
  wx:if="{{phase === 'result' || drawnCard}}"
  class="result-section"
>

  <!-- ç‰Œé˜µæ ‡é¢˜ -->
  <view class="spread-result-header">
    <view class="spread-result-title">ğŸ”® {{selectedSpread.name}}</view>
    <view class="spread-result-count">å…± {{drawnCards.length || 1}} å¼ ç‰Œ</view>
  </view>

  <!-- å¤šå¼ å¡”ç½—ç‰Œå±•ç¤º (å½“æœ‰å¤šå¼ ç‰Œæ—¶) -->
  <scroll-view
    wx:if="{{drawnCards.length > 1}}"
    class="cards-scroll"
    scroll-x="true"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="cards-result-row">
      <view
        wx:for="{{drawnCards}}"
        wx:key="_id"
        class="card-result-item card-reveal-animation"
        style="animation-delay: {{index * 150}}ms"
      >
        <view class="card-position-label">{{item.position}}</view>
        <image class="card-image-small" src="{{item.image}}" mode="aspectFit" />
        <view class="card-name-small">{{item.name}}</view>
        <view class="card-keywords-small">{{item.keywords}}</view>
      </view>
    </view>
  </scroll-view>

  <!-- å•å¼ å¡”ç½—ç‰Œå±•ç¤º (å…¼å®¹å•å¡æ¨¡å¼) -->
  <view wx:elif="{{drawnCard}}" class="card-result card-reveal-animation">
    <view wx:if="{{selectedSpread.positions[0]}}" class="card-position-label">
      {{selectedSpread.positions[0]}}
    </view>
    <image class="card-image" src="{{drawnCard.image}}" mode="aspectFit" />
    <view class="card-name">{{drawnCard.name}}</view>
    <view class="card-keywords">{{drawnCard.keywords}}</view>
  </view>

  <!-- ç‰Œé˜µä½ç½®è¯´æ˜ -->
  <view class="spread-info compact" wx:if="{{drawnCards.length > 1}}">
    <view class="spread-positions">
      <view
        class="pos-chip"
        wx:for="{{drawnCards}}"
        wx:key="_id"
      >
        <text class="pos-index">{{index + 1}}</text>
        <text class="pos-label">{{item.position}}: {{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- é—®é¢˜ä¸è§£è¯» -->
  <view class="question-section" wx:if="{{question}}">
    <view class="section-title">ğŸ’­ ä½ çš„é—®é¢˜</view>
    <view class="question-display">{{question}}</view>
    <button
      class="btn-primary"
      bindtap="getInterpretation"
      disabled="{{!question || loading}}"
    >
      {{loading ? 'è§£è¯»ä¸­...' : 'è·å–è§£è¯»'}}
    </button>
  </view>

  <!-- AI è§£è¯»ç»“æœ -->
  <view
    wx:if="{{interpretation}}"
    class="interpretation-section"
  >
    <view class="section-title">âœ¨ å°å²›è§£è¯»</view>
    <text
      class="interpretation-content"
      user-select="{{true}}"
    >
      {{interpretation}}
    </text>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <button
      class="btn-secondary"
      bindtap="resetDraw"
    >
      é‡æ–°æŠ½å–
    </button>
    <navigator
      url="/pages/tarot/history/history"
      class="btn-secondary nav-btn"
    >
      <text>æŸ¥çœ‹å†å²</text>
    </navigator>
  </view>

  <!-- è¡ŒåŠ¨è®¡åˆ’ -->
  <view
    wx:if="{{drawnCard}}"
    class="action-section"
  >
    <view class="section-title action-title">â˜€ ä»Šæ—¥è¡ŒåŠ¨ Â· æœ€å¤š 3 æ¡å°æ­¥éª¤</view>
    <view class="action-hint">
      ä¸€å¼ å¡å¯¹åº”ä¸€ä¸ªè¡ŒåŠ¨æ¡†ï¼ŒæŒ‰è¡Œåˆ—å‡º 1-3 æ¡å°æ­¥éª¤ï¼Œæƒ³å¥½å†å†™ä¹Ÿæ²¡å…³ç³»ã€‚
    </view>
    <view class="action-onebox">
      <textarea
        class="action-input single"
        placeholder="1) å†™ä¸‹ç¬¬ä¸€ä¸ªå¯æ‰§è¡Œçš„å°åŠ¨ä½œ&#10;2) å†™ä¸‹ç¬¬äºŒä¸ªå°åŠ¨ä½œï¼ˆå¯é€‰ï¼‰&#10;3) å†™ä¸‹ç¬¬ä¸‰ä¸ªå°åŠ¨ä½œï¼ˆå¯é€‰ï¼‰"
        value="{{actionText}}"
        bindinput="onActionInput"
        maxlength="300"
      ></textarea>
      <view class="action-count">
        {{actionText.length || 0}}/300
      </view>
    </view>
    <button
      class="btn-secondary solid"
      bindtap="saveActionPlan"
    >
      ä¿å­˜è¡ŒåŠ¨è®¡åˆ’
    </button>
  </view>
</view>

</view>
